define(["core/log","./api","./utils","./selectors","./tokeniser","./customevents"],(a,n,i,l,d,p)=>{let u={},c={},g="",o="",T="",_="",r=0,s=0,m,E=/\[(name="local_deepler|data-id="local_deepler)\/(\w+)"\]/i,S="onItemTranslated",L="onItemSaved",D="onItemNotSaved",b="onTranslationFailed",t="onTranslationDone",x="onRephraseFailed",y="onDbSuccess",k="onDbFailed",A=[l.deepl.tagHandling,l.deepl.context,l.deepl.splitSentences,l.deepl.preserveFormatting,l.deepl.formality,l.deepl.glossaryId,l.deepl.outlineDetection,l.deepl.nonSplittingTags,l.deepl.splittingTags,l.deepl.ignoreTags,l.deepl.modelType],I=e=>{void 0!==e.currentlang&&""!==e.currentlang&&(g=e.currentlang),void 0!==e.targetlang&&""!==e.targetlang&&(T=e.targetlang.toLowerCase()),void 0!==e.deeplsourcelang&&""!==e.deeplsourcelang&&(o=e.deeplsourcelang.toLowerCase())},f=e=>{var t;0===e.length?p.emit(k,"no data returned",""):(t=e.filter(e=>""!==e.error),e.forEach(e=>{""===e.error?(u[e.keyid].fieldText=e.text,p.emit(L,e.keyid,e.text)):p.emit(D,e.keyid,e.error)}),p.emit(y,t))},v=(e,t)=>{p.emit(k,t,e),a.trace(e),a.trace(t)};let N=(e,t)=>{let r=e.innerHTML;return r=t?i.decodeHTML(r):r},h=e=>{var t=u[e].source;return d.postprocess(t,u[e].tokens)};let O=e=>{a.info(e);let s=[];e.forEach(e=>{var t,r=e.key;""===e.error?(-1===s.indexOf(e.glossary_id)&&""!==e.glossary_id.trim()&&s.push(e.glossary_id),t=d.postprocess(e.translated_text,u[r].tokens),u[r].editor.innerHTML=t,u[r].translation=t,u[r].status=l.process.tosave,p.emit(S,r)):(u[r].status=l.process.failed,p.emit(b,e.error))}),0<s.length&&n.updateGlossariesUsage(s),p.emit(t)},C=e=>{e.forEach(e=>{var t,r;""===e.error?(t=e.key,r=d.postprocess(e.text,u[t].tokens),u[t].editor.innerHTML=r,u[t].translation=r,u[t].status=l.process.tosave,p.emit(S,t)):p.emit(x,e.error)}),p.emit(t)},F=(e,t)=>{p.emit(b,e,t)},R=(e,t)=>{p.emit(x,e,t)},P=(e,t)=>{var r,s={};for(r in t)s[t[r].match(E)[2]]=e[t[r]];return s};return{init:e=>{n.APP_VERSION=e.version,r=e.courseid,s=e.userid,I(e)},debugTemp:e=>{a.debug("translation/x/debugTemp::key"),a.debug(e),a.debug(u[e])},callTranslations:(e,t,r)=>{m=t.rephrasesymbol;let s=[],o=[];e.forEach(e=>{e=e;e={text:u[e].source,source_lang:u[e].sourceLang,key:e};(!t.isfree&&e.source_lang.includes(m)?(delete e.source_lang,a.debug("translation/x/callTranslations::t"),a.debug(e),o):s).push(e)}),0<s.length&&(p.on(n.DEEPL_SUCCESS,O),p.on(n.DEEPL_FAILED,F),n.translate(s,(e=>{const t=P(e,A);return t.target_lang=T.toUpperCase(),t.show_billed_characters=true,t})(r),n.APP_VERSION)),0<o.length&&(p.on(n.DEEPL_RF_SUCCESS,C),p.on(n.DEEPL_RF_FAILED,R),n.rephrase(o,(e=>{const t=[l.deepl.toneorstyle],r=P(e,t);return r.target_lang=T.toUpperCase(),r})(r),n.APP_VERSION))},saveTranslations:(e,t)=>{e=e.map(e=>((e,t)=>{const r=e.key,s=(a.debug(u[r]),N(u[r].editor,t));return a.debug(`translation/x/prepareDbUpdateItem::textTosave`),a.debug(s),a.debug(u[r]),a.debug(g),a.debug(o),a.debug(_),{tid:e.tid,text:s,keyid:r,mainsourcecode:g,sourcecode:u[r].sourceLang,targetcode:document.querySelector(l.actions.targetCompatibleSwitcher).value,sourcetext:h(r)}})(e,t));a.debug("translation/x/saveTranslations::data"),a.debug(e),p.on(n.TR_DB_SUCCESS,f),p.on(n.TR_DB_FAILED,v),n.updateTranslationsInDb(e,s,r)},initTempForKey:(e,t,r,s,o)=>{r=i.fromBase64(r),s=i.fromBase64(s),r=d.preprocess(r,c);u[e]={editorType:t.editorType,editor:t.editor,source:r.tokenizedText,sourceLang:o,fieldText:s,status:l.process.wait,translation:"",tokens:r.expressions}},initTemp:(e,t,r,s,o)=>{s=i.fromBase64(s),s=d.preprocess(s,c);u[e]={editorType:r,editor:t,source:s.tokenizedText,sourceLang:g,fieldText:i.fromBase64(o),status:l.process.wait,translation:"",tokens:s.expressions}},setMainLangs:I,translated:e=>0<u[e]?.translation?.length,updateTempSourceLang:(e,t)=>{u[e].sourceLang=t},updateTempStatus:(e,t)=>{u[e].status=t},updatTempStatusAll:t=>{u.map(e=>{e.status=t})},updateTempTokenized:(e,t)=>{t=d.preprocess(t,c);u[e].source=t.tokenizedText,u[e].tokens=t.expressions},ON_ITEM_TRANSLATED:S,ON_DB_FAILED:k,ON_ITEM_SAVED:L,ON_ITEM_NOT_SAVED:D,ON_TRANSLATION_FAILED:b,ON_TRANSLATION_DONE:t,ON_REPHRASE_FAILED:x,ON_DB_SAVE_SUCCESS:y}});