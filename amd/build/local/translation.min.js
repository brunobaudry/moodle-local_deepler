define(["core/log","./api","./utils","./selectors","./tokeniser","./customevents"],(o,n,i,l,d,p)=>{let u={},c={},g="",a="",T="",_="",r=0,s=0,m,E=/\[(name="local_deepler|data-id="local_deepler)\/(\w+)"\]/i,S="onItemTranslated",L="onItemSaved",D="onItemNotSaved",b="onTranslationFailed",t="onTranslationDone",x="onRephraseFailed",y="onDbSuccess",k="onDbFailed",A=[l.deepl.tagHandling,l.deepl.context,l.deepl.splitSentences,l.deepl.preserveFormatting,l.deepl.formality,l.deepl.glossaryId,l.deepl.outlineDetection,l.deepl.nonSplittingTags,l.deepl.splittingTags,l.deepl.ignoreTags,l.deepl.modelType],I=e=>{void 0!==e.currentlang&&""!==e.currentlang&&(g=e.currentlang),void 0!==e.targetlang&&""!==e.targetlang&&(T=e.targetlang.toLowerCase()),void 0!==e.deeplsourcelang&&""!==e.deeplsourcelang&&(a=e.deeplsourcelang.toLowerCase())},f=e=>{var t;0===e.length?p.emit(k,"no data returned",""):(t=e.filter(e=>""!==e.error),e.forEach(e=>{""===e.error?(u[e.keyid].fieldText=e.text,p.emit(L,e.keyid,e.text)):p.emit(D,e.keyid,e.error)}),p.emit(y,t))},v=(e,t)=>{p.emit(k,t,e),o.trace(e),o.trace(t)};let N=(e,t)=>{let r=e.innerHTML;return r=t?i.decodeHTML(r):r},h=e=>{var t=u[e].source;return d.postprocess(t,u[e].tokens)};let O=e=>{o.info(e);let s=[];e.forEach(e=>{var t,r=e.key;""===e.error?(-1===s.indexOf(e.glossary_id)&&""!==e.glossary_id.trim()&&s.push(e.glossary_id),t=d.postprocess(e.translated_text,u[r].tokens),u[r].editor.innerHTML=t,u[r].translation=t,u[r].status=l.process.tosave,p.emit(S,r)):(u[r].status=l.process.failed,p.emit(b,e.error))}),0<s.length&&n.updateGlossariesUsage(s),p.emit(t)},C=e=>{e.forEach(e=>{var t,r;""===e.error?(t=e.key,r=d.postprocess(e.text,u[t].tokens),u[t].editor.innerHTML=r,u[t].translation=r,u[t].status=l.process.tosave,p.emit(S,t)):p.emit(x,e.error)}),p.emit(t)},F=(e,t)=>{p.emit(b,e,t)},R=(e,t)=>{p.emit(x,e,t)},P=(e,t)=>{var r,s={};for(r in t)s[t[r].match(E)[2]]=e[t[r]];return s};return{init:e=>{n.APP_VERSION=e.version,r=e.courseid,s=e.userid,I(e)},debugTemp:e=>{o.debug("translation/x/debugTemp::key"),o.debug(e),o.debug(u[e])},callTranslations:(e,t,r)=>{m=t.rephrasesymbol;let s=[],a=[];e.forEach(e=>{e=e;e={text:u[e].source,source_lang:u[e].sourceLang,key:e};(!t.isfree&&e.source_lang.includes(m)?(delete e.source_lang,o.debug("translation/x/callTranslations::t"),o.debug(e),a):s).push(e)}),0<s.length&&(p.on(n.DEEPL_SUCCESS,O),p.on(n.DEEPL_FAILED,F),n.translate(s,(e=>{const t=P(e,A);return t.target_lang=T.toUpperCase(),t.show_billed_characters=true,t})(r),n.APP_VERSION)),0<a.length&&(p.on(n.DEEPL_RF_SUCCESS,C),p.on(n.DEEPL_RF_FAILED,R),n.rephrase(a,(e=>{const t=[l.deepl.toneorstyle],r=P(e,t);return r.target_lang=T.toUpperCase(),r})(r),n.APP_VERSION))},saveTranslations:(e,t)=>{e=e.map(e=>((e,t)=>{const r=e.key,s=(o.debug(u[r]),N(u[r].editor,t));return o.debug(`translation/x/prepareDbUpdateItem::textTosave`),o.debug(s),o.debug(u[r]),o.debug(g),o.debug(a),o.debug(_),{tid:e.tid,text:s,keyid:r,mainsourcecode:g,sourcecode:u[r].sourceLang,targetcode:document.querySelector(l.actions.targetCompatibleSwitcher).value,sourcetext:h(r)}})(e,t));o.debug("translation/x/saveTranslations::data"),o.debug(e),p.on(n.TR_DB_SUCCESS,f),p.on(n.TR_DB_FAILED,v),n.updateTranslationsInDb(e,s,r)},initTempForKey:(e,t,r,s,a)=>{r=i.fromBase64(r),s=i.fromBase64(s),r=d.preprocess(r,c);u[e]={editorType:t.editorType,editor:t.editor,source:r.tokenizedText,sourceLang:a,fieldText:s,status:l.process.wait,translation:"",tokens:r.expressions}},initTemp:(e,t,r,s,a)=>{s=i.fromBase64(s),s=d.preprocess(s,c);u[e]={editorType:r,editor:t,source:s.tokenizedText,sourceLang:g,fieldText:i.fromBase64(a),status:l.process.wait,translation:"",tokens:s.expressions}},setMainLangs:I,translated:e=>0<u[e]?.translation?.length,updateTempSourceLang:(e,t)=>{u[e].sourceLang=t},updateTempStatus:(e,t)=>{u[e].status=t},updatTempStatusAll:t=>{u.map(e=>{e.status=t})},updateTempTokenized:(e,t)=>{t=d.preprocess(t,c);u[e].source=t.tokenizedText,u[e].tokens=t.expressions},ON_ITEM_TRANSLATED:S,ON_DB_FAILED:k,ON_ITEM_SAVED:L,ON_ITEM_NOT_SAVED:D,ON_TRANSLATION_FAILED:b,ON_TRANSLATION_DONE:t,ON_REPHRASE_FAILED:x,ON_DB_SAVE_SUCCESS:y}}),define(["core/log","./api","./utils","./selectors","./tokeniser","./customevents"],(o,n,i,l,d,p)=>{let u={},c={},g="",a="",T="",t=0,r=0,_,m=/\[(name="local_deepler|data-id="local_deepler)\/(\w+)"\]/i,E="onItemTranslated",s="onItemSaved",S="onItemNotSaved",L="onTranslationFailed",D="onTranslationDone",b="onRephraseFailed",x="onDbSuccess",y="onDbFailed",k=[l.deepl.tagHandling,l.deepl.context,l.deepl.splitSentences,l.deepl.preserveFormatting,l.deepl.formality,l.deepl.glossaryId,l.deepl.outlineDetection,l.deepl.nonSplittingTags,l.deepl.splittingTags,l.deepl.ignoreTags,l.deepl.modelType],A=e=>{void 0!==e.currentlang&&""!==e.currentlang&&(g=e.currentlang),void 0!==e.targetlang&&""!==e.targetlang&&(T=e.targetlang.toLowerCase()),void 0!==e.deeplsourcelang&&""!==e.deeplsourcelang&&(a=e.deeplsourcelang.toLowerCase())},I=e=>{var t;0===e.length?p.emit(y,"no data returned",""):(t=e.filter(e=>""!==e.error),e.forEach(e=>{""===e.error?(u[e.keyid].fieldText=e.text,p.emit(s,e.keyid,e.text)):p.emit(S,e.keyid,e.error)}),p.emit(x,t))},f=(e,t)=>{p.emit(y,t,e),o.trace(e),o.trace(t)},v=e=>{o.info(e);let s=[];e.forEach(e=>{var t,r=e.key;""===e.error?(-1===s.indexOf(e.glossary_id)&&""!==e.glossary_id.trim()&&s.push(e.glossary_id),t=d.postprocess(e.translated_text,u[r].tokens),u[r].editor.innerHTML=t,u[r].translation=t,u[r].status=l.process.tosave,p.emit(E,r)):(u[r].status=l.process.failed,p.emit(L,e.error))}),0<s.length&&n.updateGlossariesUsage(s),p.emit(D)},N=e=>{e.forEach(e=>{var t,r;""===e.error?(t=e.key,r=d.postprocess(e.text,u[t].tokens),u[t].editor.innerHTML=r,u[t].translation=r,u[t].status=l.process.tosave,p.emit(E,t)):p.emit(b,e.error)}),p.emit(D)},h=(e,t)=>{p.emit(L,e,t)},O=(e,t)=>{p.emit(b,e,t)},C=(e,t)=>{var r,s={};for(r in t)s[t[r].match(m)[2]]=e[t[r]];return s};return{init:e=>{n.APP_VERSION=e.version,t=e.courseid,r=e.userid,A(e)},debugTemp:e=>{o.debug("translation/x/debugTemp::key"),o.debug(e),o.debug(u[e])},callTranslations:(e,t,r)=>{_=t.rephrasesymbol;let s=[],a=[];e.forEach(e=>{e={text:u[e].source,source_lang:u[e].sourceLang,key:e},(!t.isfree&&e.source_lang.includes(_)?(delete e.source_lang,o.debug("translation/x/callTranslations::t"),o.debug(e),a):s).push(e)}),0<s.length&&(p.on(n.DEEPL_SUCCESS,v),p.on(n.DEEPL_FAILED,h),n.translate(s,(e=>{e=C(e,k);return e.target_lang=T.toUpperCase(),e.show_billed_characters=!0,e})(r),n.APP_VERSION)),0<a.length&&(p.on(n.DEEPL_RF_SUCCESS,N),p.on(n.DEEPL_RF_FAILED,O),n.rephrase(a,(e=r,r=[l.deepl.toneorstyle],(e=C(e,r)).target_lang=T.toUpperCase(),e),n.APP_VERSION))},saveTranslations:(e,s)=>{e=e.map(e=>{return t=s,r=(e=e).key,o.debug(u[r]),t=((e,t)=>{e=e.innerHTML;return t?i.decodeHTML(e):e})(u[r].editor,t),o.debug("translation/x/prepareDbUpdateItem::textTosave"),o.debug(t),o.debug(u[r]),o.debug(g),o.debug(a),o.debug(""),{tid:e.tid,text:t,keyid:r,mainsourcecode:g,sourcecode:u[r].sourceLang,targetcode:document.querySelector(l.actions.targetCompatibleSwitcher).value,sourcetext:(e=r,t=u[e].source,d.postprocess(t,u[e].tokens))};var t,r}),o.debug("translation/x/saveTranslations::data"),o.debug(e),p.on(n.TR_DB_SUCCESS,I),p.on(n.TR_DB_FAILED,f),n.updateTranslationsInDb(e,r,t)},initTempForKey:(e,t,r,s,a)=>{r=i.fromBase64(r),s=i.fromBase64(s),r=d.preprocess(r,c),u[e]={editorType:t.editorType,editor:t.editor,source:r.tokenizedText,sourceLang:a,fieldText:s,status:l.process.wait,translation:"",tokens:r.expressions}},initTemp:(e,t,r,s,a)=>{s=i.fromBase64(s),s=d.preprocess(s,c),u[e]={editorType:r,editor:t,source:s.tokenizedText,sourceLang:g,fieldText:i.fromBase64(a),status:l.process.wait,translation:"",tokens:s.expressions}},setMainLangs:A,translated:e=>0<u[e]?.translation?.length,updateTempSourceLang:(e,t)=>{u[e].sourceLang=t},updateTempStatus:(e,t)=>{u[e].status=t},updatTempStatusAll:t=>{u.map(e=>{e.status=t})},updateTempTokenized:(e,t)=>{t=d.preprocess(t,c),u[e].source=t.tokenizedText,u[e].tokens=t.expressions},ON_ITEM_TRANSLATED:E,ON_DB_FAILED:y,ON_ITEM_SAVED:s,ON_ITEM_NOT_SAVED:S,ON_TRANSLATION_FAILED:L,ON_TRANSLATION_DONE:D,ON_REPHRASE_FAILED:b,ON_DB_SAVE_SUCCESS:x}});