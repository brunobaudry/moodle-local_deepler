define(["core/log","./api","./utils","./selectors","./tokeniser","./customevents"],(o,s,l,i,d,u)=>{let g={},c={},n="",p="",_="",T="",r=0,a=0,m,E=/\[(name="local_deepler|data-id="local_deepler)\/(\w+)"\]/i,S="onItemTranslated",b="onItemSaved",D="onItemNotSaved",L="onTranslationFailed",t="onTranslationDone",y="onRephraseFailed",x="onDbSuccess",I="onDbFailed",A=[i.deepl.tagHandling,i.deepl.context,i.deepl.splitSentences,i.deepl.preserveFormatting,i.deepl.formality,i.deepl.glossaryId,i.deepl.outlineDetection,i.deepl.nonSplittingTags,i.deepl.splittingTags,i.deepl.ignoreTags,i.deepl.modelType],N=e=>{void 0!==e.currentlang&&""!==e.currentlang&&(n=e.currentlang),void 0!==e.targetlang&&""!==e.targetlang&&(_=e.targetlang.toLowerCase()),void 0!==e.deeplsourcelang&&""!==e.deeplsourcelang&&(p=e.deeplsourcelang.toLowerCase())},h=e=>{var t;0===e.length?u.emit(I,"no data returned",""):(t=e.filter(e=>""!==e.error),e.forEach(e=>{""===e.error?(g[e.keyid].fieldText=e.text,u.emit(b,e.keyid,e.text)):u.emit(D,e.keyid,e.error)}),u.emit(x,t))},v=(e,t)=>{u.emit(I,t,e),o.trace(e),o.trace(t)};let f=(e,t)=>{let r=e.innerHTML;return r=t?l.decodeHTML(r):r},k=e=>{var t=g[e].source;return d.postprocess(t,g[e].tokens)};let O=e=>{o.info(e);let a=[];e.forEach(e=>{var t,r;""===e.error?(-1===a.indexOf(e.glossary_id)&&""!==e.glossary_id.trim()&&a.push(e.glossary_id),t=e.key,r=d.postprocess(e.translated_text,g[t].tokens),g[t].editor.innerHTML=r,g[t].translation=r,u.emit(S,t)):u.emit(L,e.error)}),0<a.length&&s.updateGlossariesUsage(a),u.emit(t)},C=e=>{e.forEach(e=>{var t,r;""===e.error?(t=e.key,r=d.postprocess(e.text,g[t].tokens),g[t].editor.innerHTML=r,g[t].translation=r,u.emit(S,t)):u.emit(y,e.error)}),u.emit(t)},F=(e,t)=>{u.emit(L,e,t)},R=(e,t)=>{u.emit(y,e,t)},P=(e,t)=>{var r,a={};for(r in t)a[t[r].match(E)[2]]=e[t[r]];return a};return{init:e=>{s.APP_VERSION=e.version,r=e.courseid,a=e.userid,N(e)},debugTemp:e=>{o.debug("translation/x/debugTemp::key"),o.debug(e),o.debug(g[e])},callTranslations:(e,t,r)=>{m=t.rephrasesymbol;let a=[],n=[];e.forEach(e=>{e=e;e={text:g[e].source,source_lang:g[e].sourceLang,key:e};(t.canimprove&&e.source_lang.includes(m)?(delete e.source_lang,o.debug("translation/x/callTranslations::t"),o.debug(e),n):a).push(e)}),0<a.length&&(u.on(s.DEEPL_SUCCESS,O),u.on(s.DEEPL_FAILED,F),s.translate(a,(e=>{const t=P(e,A);return t.target_lang=_.toUpperCase(),t.show_billed_characters=true,t})(r),s.APP_VERSION)),0<n.length&&(u.on(s.DEEPL_RF_SUCCESS,C),u.on(s.DEEPL_RF_FAILED,R),s.rephrase(n,(e=>{const t=[i.deepl.toneorstyle],r=P(e,t);return r.target_lang=_.toUpperCase(),r})(r),s.APP_VERSION))},saveTranslations:(e,t)=>{e=e.map(e=>((e,t)=>{const r=e.key,a=(o.debug(g[r]),f(g[r].editor,t));return o.debug(`translation/x/prepareDbUpdateItem::textTosave`),o.debug(a),o.debug(g[r]),o.debug(n),o.debug(p),o.debug(T),{tid:e.tid,text:f(g[r].editor,t),keyid:r,mainsourcecode:n,sourcecode:g[r].sourceLang,targetcode:document.querySelector(i.actions.targetCompatibleSwitcher).value,sourcetext:k(r)}})(e,"textarea"===t.userPrefs));o.debug("translation/x/saveTranslations::data"),o.debug(e),u.on(s.TR_DB_SUCCESS,h),u.on(s.TR_DB_FAILED,v),s.updateTranslationsInDb(e,a,r)},initTempForKey:(e,t,r,a,n)=>{r=l.fromBase64(r),a=l.fromBase64(a),r=d.preprocess(r,c);g[e]={editorType:t.editorType,editor:t.editor,source:r.tokenizedText,sourceLang:n,fieldText:a,status:i.statuses.wait,translation:"",tokens:r.expressions}},initTemp:e=>{g[e]={editorType:null,editor:null,source:"",sourceLang:"",fieldText:"",status:"",translation:"",tokens:[]}},setMainLangs:N,isTranslatable:()=>""!==_,translated:e=>0<g[e]?.translation?.length,ON_ITEM_TRANSLATED:S,ON_DB_FAILED:I,ON_ITEM_SAVED:b,ON_ITEM_NOT_SAVED:D,ON_TRANSLATION_FAILED:L,ON_TRANSLATION_DONE:t,ON_REPHRASE_FAILED:y,ON_DB_SAVE_SUCCESS:x}});