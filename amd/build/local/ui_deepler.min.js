define(["core/log","editor_tiny/loader","editor_tiny/editor","core/modal","./selectors","./translation","./utils","./customevents","./scrollspy","./api"],(s,W,r,i,d,o,l,t,U,a)=>{let n=((t,a)=>{let s;return(...e)=>{clearTimeout(s),s=setTimeout(()=>t(...e),a)}})(()=>{e()},100),u={wordCount:document.querySelector(d.statuses.wordcount),charWithSpace:document.querySelector(d.statuses.charNumWithSpace),charWOSpace:document.querySelector(d.statuses.charNumWithOutSpace),deeplUseSpan:document.querySelector(d.statuses.deeplUsage),deeplMaxSpan:document.querySelector(d.statuses.deeplMax),deeplStatusContainer:document.querySelector(d.statuses.deeplStatusContainer)},c,g={},p=[],h={},m={},b={},y={},v={},f=[],S=new Intl.NumberFormat,k={},w="",A={},E=[],L,T,F=(e,t)=>{null!==k&&k.isVisible&&k.hide(),I(w+" "+t,"DB failed to save translations. "+e,"Alert")},H=t=>{if(null!==k&&k.isVisible&&k.hide(),0<t.length){let e=m.uistrings.errordbpartial;e=e.replace("{$a}",t.length),I(w,e,"Alert")}},K=e=>{var t=e.glossaryid,a=JSON.parse(e.entries),r=e.status,s=e.message;if("success"===r){var r=document.createElement("table"),o=(r.className="generaltable",document.createElement("thead"));o.innerHTML=`<tr><th>${e.source.toUpperCase()}</th>
                <th>${e.target.toUpperCase()}</th></tr>`,r.appendChild(o);let s=document.createElement("tbody");Object.entries(a).forEach(([e,t])=>{var a=document.createElement("tr");a.innerHTML=`<td>${e}</td><td>${t}</td>`,s.appendChild(a)}),r.appendChild(s),i.create({title:"Entries",body:r,type:"default",show:!0,removeOnClose:!0})}else i.create({title:`Error fetching entries for<br/><em>${t}</em>`,body:s,type:"default",show:!0,removeOnClose:!0})},P=e=>{s.info("onGlossaryDbAllfailed"),s.error(e)},$=e=>{s.info("onGlossaryDbfailed"),s.error(e)},q=e=>{s.info("onGlossaryDbSuccess"),s.info(e)},G=()=>{E.forEach(t=>{var e=`[data-sourcetext-key="${t.id.replace("tiny_","")}"]`,e=R(e);let a=e.parentElement;var s=new ResizeObserver(()=>{var e;e=a.offsetHeight+80,t.style.height=e+"px"});s.observe(e),s.observe(a)})},V=()=>{if(h.targetlang){var e=l.getCookie(h),t=l.getEncodedCookie(h);if(null!==t){var a,s=JSON.parse(t);for(a in A)if(void 0!==s[a])switch(A[a].type){case"select-one":Y(s[a]);break;case"checkbox":A[a].checked=s[a];break;case"radio":R(a+`[value="${s[a]}"]`).checked=!0;break;default:A[a].value=s[a]}}null!==e&&(A[d.deepl.glossaryId].value=e)}},Y=e=>{e=R(`option[value="${e}"]`);e&&(e.selected=!0)},x=async e=>{await(k=await i.create(e)).show()},J=async(e,t)=>{try{await W.getTinyMCE(),await r.setupForTarget(e.target,t),s.info("tiny loaded for "+e.target.id)}catch(e){s.error(e)}},j=e=>{var t;e.target.closest(d.editors.targetarea)&&C(e.target.id.replace("tiny_",""))===d.statuses.tosave&&(t={subdirs:!1,maxbytes:10240,maxfiles:0,noclean:!0,trusttext:!0,enable_filemanagement:!1,autosave:!1,removeorphaneddrafts:!0,plugins:[]},J(e,t))},z=e=>{e.target.closest(d.actions.toggleMultilang)&&Q(e.target.closest(d.actions.toggleMultilang)),e.target.closest(d.actions.autoTranslateBtn)&&(!h.canimprove&&h.deeplsourcelang===h.targetlang||void 0===h.targetlang?I("Cannot call deepl",`<p>${m.uistrings.canttranslatesame} ${h.targetlang}</p>`):ce()),e.target.closest(d.actions.selectAllBtn)&&re(e),e.target.closest(d.actions.tothetop)&&window.scrollTo({top:c-5,behavior:"smooth"}),e.target.closest(d.actions.checkBoxes)&&O(),e.target.closest(d.actions.saveAll)&&Z(),e.target.closest(d.actions.validatorsBtns)&&ee(e),e.target.closest(d.glossary.entriesviewerPage)&&(s.info("CLICK"),s.info(A[d.deepl.glossaryId].value),a.getGlossariesEntries(A[d.deepl.glossaryId].value,h.deeplsourcelang,h.targetlang))},X=e=>{e.target.closest(d.actions.hideiframes)&&_(g.checked),e.target.closest(d.actions.targetSwitcher)&&be(e),e.target.closest(d.actions.sectionSwitcher)&&ye(e),e.target.closest(d.actions.moduleSwitcher)&&ve(e),e.target.closest(d.actions.sourceSwitcher)&&fe(e),clearTimeout(T),T=setTimeout(()=>{e.target.closest(d.actions.showUpdated)&&n(),e.target.closest(d.actions.showNeedUpdate)&&n(),e.target.closest(d.actions.showHidden)&&n()},30),e.target.closest(d.actions.checkBoxes)&&se(e),e.target.closest(d.actions.sourceselect)&&ae(e),e.target.closest(d.deepl.glossaryId)&&(""!==A[d.deepl.glossaryId].value?L.style.display="block":L.style.display="none")};function _(e){var t=M(d.sourcetexts.iframes);!e&&0<t.length?(p=[],t.forEach(e=>{p.push({parent:e.parentNode,nextSibling:e.nextSibling,html:e.outerHTML}),e.remove()})):0<p.length&&(p.forEach(e=>{var t=document.createElement("div"),t=(t.innerHTML=e.html,t.firstChild);e.nextSibling?e.parent.insertBefore(t,e.nextSibling):e.parent.appendChild(t)}),p=[])}let Q=e=>{var e=e.getAttribute("aria-controls"),t=l.keyidToKey(e);null===t?s.error(`KEY ${e} BAD FORMAT should be TABLE-ID-FIELD-CMID`):(t=R(d.sourcetexts.keys,t),e=R(d.sourcetexts.multilangs,e),t.classList.toggle("show"),e.classList.toggle("show"))},Z=()=>{var e=M(d.statuses.checkedCheckBoxes);if(0!==e.length){y.disabled=!0,x({title:m.uistrings.saveallmodaltitle,body:m.uistrings.saveallmodalbody}).then(e=>s.info("SaveAll Modal launched "+e)).catch(e=>{s.error(e)});let t=[];Array.from(e).map(e=>e.dataset.key).forEach(e=>{C(e)===d.statuses.tosave&&(pe(e),t.push(te(e)))}),o.saveTranslations(t,h)}},ee=e=>{e=e.target.closest(d.actions.validatorsBtns).dataset.keyValidator;C(e)===d.statuses.tosave&&(pe(e),o.saveTranslations([te(e)],h))},te=e=>{var t=R(d.editors.multiples.editorsWithKey,e);return{key:e,courseid:h.courseid,id:parseInt(t.getAttribute("data-id")),tid:t.getAttribute("data-tid"),table:t.getAttribute("data-table"),field:t.getAttribute("data-field"),cmid:t.getAttribute("data-cmid")}},ae=e=>{s.info("source changed"),s.info(e.target.getAttribute("data-key"))},se=e=>{"local_deepler/checkbox"===e.target.getAttribute("data-action")&&(B(e.target.getAttribute("data-key"),e.target.checked),D())},re=e=>{let a=e.target.checked,s=[];f.forEach(e=>{var t=!!a&&!oe(e).classList.contains("d-none");e.checked!==t&&s.push({checkbox:e,shouldCheck:t})}),requestAnimationFrame(()=>{s.forEach(({checkbox:e,shouldCheck:t})=>{e.checked=t,B(e.getAttribute("data-key"),t)}),O(),D()})},O=()=>{b.disabled=!Array.from(f).some(e=>e.checked)},C=e=>R(d.actions.validatorBtn,e).getAttribute("data-status"),N=(e,t=d.statuses.wait,a=!1)=>{e=R(d.actions.validatorBtn,e);a?(e.classList.contains("btn")||(e.classList.add("btn"),e.classList.add("btn-outline-secondary")),e.classList.contains("disable")&&e.classList.remove("disable")):(e.classList.contains("disable")||e.classList.add("disable"),e.classList.contains("btn")&&(e.classList.remove("btn"),e.classList.remove("btn-outline-secondary"))),e.setAttribute("role",a?"button":"status"),e.setAttribute("data-status",t),e.setAttribute("title",m.statusstrings[t.replace("local_deepler/","")])},oe=e=>e.closest(l.replaceKey(d.sourcetexts.parentrow,e.getAttribute("data-key"))),I=(e,t,a="default")=>{i.create({title:e,body:t,type:a,show:!0,removeOnClose:!0})},ie=e=>{var t=m.uistrings.deeplapiexception;le(),I(t,e,"Alert")},le=()=>{null!==k&&k.isVisible&&k.hide()},ne=e=>{N(e,d.statuses.tosave,!0)},ce=()=>{k=x({title:m.uistrings.translatemodaltitle,body:m.uistrings.translatemodalbody});let s=[];var[e,t]=de(),a=(y.disabled=!1,M(d.statuses.checkedCheckBoxes).forEach(e=>{var e=e.getAttribute("data-key"),t=R(d.sourcetexts.keys,e),a=Se(e);o.initTempForKey(e,a,t.getAttribute("data-sourcetext-raw"),t.getAttribute("data-filedtext-raw"),R(d.sourcetexts.sourcelangdd,e).value),s.push(e)}),l.COOKIE_PREFIX_NEW+h.currentlang+h.targetlang+h.courseid);l.setEncodedCookie(a,JSON.stringify(e),h.cookieduration),o.callTranslations(s,h,t)},de=()=>{var e,t={},a={};for(e in A)if(null===A[e])s.warn("prepareSettingsAndCookieValues. Could not find selector "+e),s.warn(A);else switch(A[e].type){case"select-one":a[e]=A[e].value,t[e]=A[e].value;break;case"textarea":a[e]=A[e].value,t[e]=l.toJsonArray(a[e]);break;case"checkbox":e===d.deepl.tagHandling?(a[e]=A[e].checked,t[e]=A[e].checked?"html":"xml"):t[e]=a[e]=A[e].checked;break;case"radio":t[e]=a[e]=Ee(e);break;default:t[e]=a[e]=A[e].value}return[a,t]},B=(e,t)=>{switch(R(d.actions.validatorBtn,e).dataset.status){case d.statuses.wait:o.initTemp(e),t&&N(e,d.statuses.totranslate);break;case d.statuses.totranslate:t&&o.translated[e]?N(e,d.statuses.tosave,!0):N(e,d.statuses.wait);break;case d.statuses.tosave:t||N(e,d.statuses.totranslate);break;case d.statuses.failed:t&&N(e,d.statuses.totranslate);break;case d.statuses.success:break;case d.statuses.saved:t&&N(e,d.statuses.totranslate),o.initTemp(e)}},e=()=>{let i={[d.statuses.updated]:R(d.actions.showUpdated).checked,[d.statuses.needsupdate]:R(d.actions.showNeedUpdate).checked,[d.statuses.hidden]:R(d.actions.showHidden).checked};var e=Object.keys(i).join(","),e=M(e);let l=R(d.actions.selectAllBtn).checked;e.forEach(e=>{let t=!1,a=!1;for(var[s,r]of Object.entries(i))if(e.matches(s)){t=r,a=l&&r;break}e.classList.toggle("d-none",!t);var o=e.getAttribute("data-row-id");null===o?M(d.statuses.hiddenForStudentRows,"",e).forEach(e=>{e=e.getAttribute("data-row-id");ue(e,a)}):ue(o,a)}),O(),D()},ue=(e,t)=>{R(d.editors.multiples.checkBoxesWithKey,e).checked=t,B(e,!1)},ge=(e,t)=>{s.warn("ui/errorMessageItem"),s.warn(e),s.warn(t);R(d.editors.multiples.editorsWithKey,e).classList.add("local_deepler__error"),N(e,d.statuses.failed);var a=t.indexOf("Data too long");-1===a?me(e,t):(a=m.uistrings.errortoolong,me(e,t.substring(0,t.indexOf("WHERE id=?"))+" "+a))},pe=e=>{var e=R(d.editors.multiples.editorsWithKey,e),t=R(".alert-danger","",e);t&&e.removeChild(t)},he=(t,e)=>{R(d.editors.multiples.editorsWithKey,t).classList.add("local_deepler__success"),N(t,d.statuses.success),R(d.editors.multiples.textAreas,t).innerHTML=e,R(d.editors.multiples.checkBoxesWithKey,t).checked=!1,setTimeout(()=>{var e=R(d.statuses.multilang,t);R(d.statuses.prevTransStatus,t).classList="badge badge-pill badge-success",e.classList.contains("disabled")&&e.classList.remove("disabled"),N(t,d.statuses.saved)})},me=(e,t)=>{var e=R(d.editors.multiples.editorsWithKey,e),a=document.createElement("div");a.id="local_deepler__errormsg",a.classList=["alert alert-danger"],a.innerHTML=t,e.appendChild(a)},be=e=>{var t=new URL(window.location.href);t.searchParams.set("target_lang",e.target.value.replace(h.rephrasesymbol,"").trim()),window.location=t.toString()},ye=e=>{var t=new URL(window.location.href),a=t.searchParams;a.set("section_id",e.target.value.trim()),a.has("activity_id")&&a.delete("activity_id"),window.location=t.toString()},ve=e=>{var t=new URL(window.location.href);t.searchParams.set("activity_id",e.target.value.trim()),window.location=t.toString()},fe=e=>{var t=new URL(window.location.href);t.searchParams.set("lang",e.target.value),window.location=t.toString()},D=()=>{let t=0,a=0,s=0;Array.from(M(d.statuses.checkedCheckBoxes)).forEach(e=>{e=e.getAttribute("data-key"),e=Ae(e);t+=e.wordCount,a+=e.charNumWithSpace,s+=e.charNumWithOutSpace});var e=u.wordCount,r=u.charWithSpace,o=u.charWOSpace,i=u.deeplUseSpan,l=u.deeplMaxSpan,n=u.deeplStatusContainer,c=a+h.usage.character.count;e.innerText=t,r.innerText=a,o.innerText=s,i.innerText=S.format(c),l.innerText=null===h.usage.character.limit?"âˆž":S.format(h.usage.character.limit),n.classList.toggle("alert-success",c<h.usage.character.limit||null===h.usage.character.limit),n.classList.toggle("alert-danger",c>=h.usage.character.limit&&null!==h.usage.character.limit)},Se=t=>{var e=R(d.editors.types.basic,t);if(null!==e)return{editor:e,editorType:"basic"};{let e=null;if(-1===["atto","tiny","marklar","textarea"].indexOf(h.userPrefs))s.warn("Unsupported editor "+h.userPrefs);else try{e=ke(t,h.userPrefs)}catch(e){s.trace(`Editor not found: ${h.userPrefs} for key `+t)}return e}},ke=(e,t)=>{let a="basic",s=null;switch(t){case"atto":a="iframe",s=R(d.editors.types.atto,e);break;case"tiny":a="iframe",s=we(e);break;case"marklar":case"textarea":s=R(d.editors.types.other,e)}return{editor:s,editorType:a}},we=a=>{let s=null;return r.getAllInstances().every((e,t)=>0!=t.attributes.name.value.indexOf(a)||(s=e.getBody(),!1)),s},Ae=e=>{e=R(d.sourcetexts.keys,e).getAttribute("data-sourcetext-raw"),e=l.stripHTMLTags(l.fromBase64(e)).trim();return{wordCount:(e.match(/\S+/g)||[]).length,charNumWithSpace:e.length,charNumWithOutSpace:e.replace(/\s+/g,"").length}},Ee=e=>R(d.actions.radioValues.replace("<RADIO>",e)).value,R=(e,t="",a=null)=>{a=a??document,e=""===t?e:e.replace("<KEY>",t);return a.querySelector(e)},M=(e,t="",a=null)=>{a=a??document,e=""===t?e:e.replace("<KEY>",t);return a.querySelectorAll(e)};return{init:e=>{c=R(d.config.langstrings).offsetTop,U.init(".local_deepler__form","#local_deepler-scrollspy",{highestLevel:3,fadingDistance:60,offsetEndOfScope:1,offsetTop:100,crumbsmaxlen:e.crumbsmaxlen}),o.init(e),h=e,s.info(e),(()=>{try{E=M(d.editors.targetarea),g=R(d.actions.hideiframes),m=JSON.parse(R(d.config.langstrings).getAttribute("data-langstrings")),w=m.uistrings.errordbtitle,y=R(d.actions.saveAll),v=R(d.actions.selectAllBtn),b=R(d.actions.autoTranslateBtn),f=M(d.actions.checkBoxes),!L&&document.querySelector(d.glossary.entriesviewerPage)&&(L=document.querySelector(d.glossary.entriesviewerPage)),A[d.deepl.glossaryId]=R(d.deepl.glossaryId),A[d.deepl.context]=R(d.deepl.context),A[d.deepl.formality]=R(d.deepl.formality),A[d.deepl.modelType]=R(d.deepl.modelType),A[d.deepl.ignoreTags]=R(d.deepl.ignoreTags),A[d.deepl.nonSplittingTags]=R(d.deepl.nonSplittingTags),A[d.deepl.outlineDetection]=R(d.deepl.outlineDetection),A[d.deepl.preserveFormatting]=R(d.deepl.preserveFormatting),A[d.deepl.splitSentences]=R(d.deepl.splitSentences),A[d.deepl.splittingTags]=R(d.deepl.splittingTags),A[d.deepl.tagHandling]=R(d.deepl.tagHandling),h.isfree||(A[d.deepl.toneorstyle]=R(d.deepl.toneorstyle)),A[d.actions.escapeLatex]=R(d.actions.escapeLatex),A[d.actions.escapePre]=R(d.actions.escapePre),V(),G()}catch(e){h.debug&&s.error(e.message)}})(),document.addEventListener("change",X),document.addEventListener("click",z),document.addEventListener("focusin",j),t.on(o.ON_ITEM_TRANSLATED,ne),t.on(o.ON_TRANSLATION_FAILED,ie),t.on(o.ON_TRANSLATION_DONE,le),t.on(o.ON_REPHRASE_FAILED,ie),t.on(o.ON_DB_SAVE_SUCCESS,H),t.on(o.ON_DB_FAILED,F),t.on(o.ON_ITEM_SAVED,he),t.on(o.ON_ITEM_NOT_SAVED,ge),t.on(a.GLOSSARY_DB_ALL_FAILED,P),t.on(a.GLOSSARY_DB_FAILED,$),t.on(a.GLOSSARY_DB_SUCCESS,q),t.on(a.GLOSSARY_ENTRIES_SUCCESS,K),t.on(a.GLOSSARY_ENTRIES_FAILED,e=>s.error(e)),O(),_(g.checked),y.disabled=!0,v.disabled=!o.isTranslatable(),f.forEach(e=>{e.disabled=v.disabled}),n()}}});