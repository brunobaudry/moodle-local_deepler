/**
 * @module     local_deepler/deepler
 * @file       amd/src/local/ui.js
 * @copyright  2025 Bruno Baudry <bruno.baudry@bfh.ch>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_deepler/local/ui",["core/log","editor_tiny/editor","core/str","core/modal","./selectors","./translation","./utils","./customevents"],((Log,TinyMCE,Str,Modal,Selectors,Translation,Utils,Events)=>{const{getString:getString}=Str;let config={},autotranslateButton={},saveAllBtn={},selectAllBtn={},checkboxes=[],format=new Intl.NumberFormat,saveAllModal={},errordbtitle="";const handleChangeEvent=e=>{e.target.closest(Selectors.actions.targetSwitcher)&&switchTarget(e),e.target.closest(Selectors.actions.sourceSwitcher)&&switchSource(e),e.target.closest(Selectors.actions.showUpdated)&&showRows(Selectors.statuses.updated,e.target.checked),e.target.closest(Selectors.actions.showNeedUpdate)&&showRows(Selectors.statuses.needsupdate,e.target.checked),(e.target.closest(Selectors.actions.checkBoxes)||e.target.closest(Selectors.actions.sourceselect))&&onItemChecked(e)},handleClickEvent=e=>{e.target.closest(Selectors.actions.toggleMultilang)&&(e=>{let keyid=e.getAttribute("aria-controls"),key=Utils.keyidToKey(keyid),source=domQuery(Selectors.sourcetexts.keys,key),multilang=domQuery(Selectors.sourcetexts.multilangs,keyid);source.classList.toggle("show"),multilang.classList.toggle("show")})(e.target.closest(Selectors.actions.toggleMultilang)),e.target.closest(Selectors.actions.autoTranslateBtn)&&(config.currentlang===config.lang||void 0===config.lang?showModal("Cannot call deepl","<p>Both languages are the same ".concat(config.lang,"</p>")):doAutotranslate()),e.target.closest(Selectors.actions.selectAllBtn)&&toggleAllCheckboxes(e),e.target.closest(Selectors.actions.checkBoxes)&&toggleAutotranslateButton(),e.target.closest(Selectors.actions.saveAll)&&saveTranslations(),e.target.closest(Selectors.actions.validatorsBtns)&&saveSingleTranslation(e)},saveTranslations=()=>{const selectedCheckboxes=domQueryAll(Selectors.statuses.checkedCheckBoxes);if(0===selectedCheckboxes.length)return;saveAllBtn.disabled=!0,(async()=>{saveAllModal=await Modal.create({title:getString("saveallmodaltitle","local_deepler"),body:getString("saveallmodalbody","local_deepler")}),await saveAllModal.show()})().then((r=>Log.info("SaveAll Modal launched "+r)));const data=[];Array.from(selectedCheckboxes).map((e=>e.dataset.key)).forEach((key=>{getIconStatus(key)===Selectors.statuses.tosave&&(hideErrorMessage(key),data.push(prepareDBitem(key)))})),Translation.saveTranslations(data,config)},saveSingleTranslation=e=>{const key=e.target.closest(Selectors.actions.validatorsBtns).dataset.keyValidator;Log.warn(key),Log.warn(getIconStatus(key)),getIconStatus(key)===Selectors.statuses.tosave&&(hideErrorMessage(key),Translation.saveTranslations([prepareDBitem(key)],config))},prepareDBitem=key=>{const element=domQuery(Selectors.editors.multiples.editorsWithKey,key);return{key:key,courseid:config.courseid,id:parseInt(element.getAttribute("data-id")),tid:element.getAttribute("data-tid"),table:element.getAttribute("data-table"),field:element.getAttribute("data-field")}},onItemChecked=e=>{Log.info("SELECTION",e.target.getAttribute("data-key"),e.target.getAttribute("data-action"));const key=e.target.getAttribute("data-key");"local_deepler/checkbox"===e.target.getAttribute("data-action")?(toggleStatus(key,e.target.checked),countWordAndChar()):Translation.initTempForKey(key,findEditor(key),domQuery(Selectors.sourcetexts.keys,key).getAttribute("data-sourcetext-raw"),domQuery(Selectors.sourcetexts.keys,key).getAttribute("data-filedtext-raw"))},toggleAllCheckboxes=e=>{e.target.checked?checkboxes.forEach((i=>{i.checked=!getParentRow(i).classList.contains("d-none"),toggleStatus(i.getAttribute("data-key"),i.checked)})):checkboxes.forEach((i=>{i.checked=!1,toggleStatus(i.getAttribute("data-key"),!1)})),toggleAutotranslateButton(),countWordAndChar()},toggleAutotranslateButton=()=>{autotranslateButton.disabled=!0;for(let i in checkboxes){if(checkboxes[i].checked){autotranslateButton.disabled=!1;break}}},getIconStatus=key=>domQuery(Selectors.actions.validatorBtn,key).getAttribute("data-status"),setIconStatus=function(key){let status=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Selectors.statuses.wait,isBtn=arguments.length>2&&void 0!==arguments[2]&&arguments[2],icon=domQuery(Selectors.actions.validatorBtn,key);isBtn?(icon.classList.contains("btn")||(icon.classList.add("btn"),icon.classList.add("btn-outline-secondary")),icon.classList.contains("disable")&&icon.classList.remove("disable")):(icon.classList.contains("disable")||icon.classList.add("disable"),icon.classList.contains("btn")&&(icon.classList.remove("btn"),icon.classList.remove("btn-outline-secondary"))),icon.setAttribute("role",isBtn?"button":"status"),icon.setAttribute("data-status",status),icon.setAttribute("title",config.statusstrings[status.replace("local_deepler/","")])},getParentRow=node=>node.closest(Utils.replaceKey(Selectors.sourcetexts.parentrow,node.getAttribute("data-key"))),showModal=(title,body)=>{Modal.create({title:title,body:body,show:!0,removeOnClose:!0})},onItemTranslated=key=>{setIconStatus(key,Selectors.statuses.tosave,!0)},doAutotranslate=()=>{const keys=[];saveAllBtn.disabled=!1,domQueryAll(Selectors.statuses.checkedCheckBoxes).forEach((ckBox=>{keys.push(ckBox.getAttribute("data-key"))})),Translation.callTranslations(keys)},toggleStatus=(key,checked)=>{switch(domQuery(Selectors.actions.validatorBtn,key).dataset.status){case Selectors.statuses.wait:Translation.initTemp(key),checked&&(setIconStatus(key,Selectors.statuses.totranslate),refreshTempTranslation(key));break;case Selectors.statuses.totranslate:checked&&Translation.translated[key]?setIconStatus(key,Selectors.statuses.tosave,!0):setIconStatus(key,Selectors.statuses.wait);break;case Selectors.statuses.tosave:checked||setIconStatus(key,Selectors.statuses.totranslate);break;case Selectors.statuses.failed:case Selectors.statuses.success:break;case Selectors.statuses.saved:Translation.initTemp(key)}},refreshTempTranslation=key=>{Translation.initTempForKey(key,findEditor(key),domQuery(Selectors.sourcetexts.keys,key).getAttribute("data-sourcetext-raw"),domQuery(Selectors.sourcetexts.keys,key).getAttribute("data-filedtext-raw"),domQuery(Selectors.sourcetexts.sourcelangs,key).value)},showRows=(selector,selected)=>{const items=domQueryAll(selector),allSelected=domQuery(Selectors.actions.selectAllBtn).checked;items.forEach((item=>{let k=item.getAttribute("data-row-id");var row;row=item,selected?row.classList.remove("d-none"):row.classList.add("d-none");try{domQuery(Selectors.editors.multiples.checkBoxesWithKey,k).checked=allSelected&&selected,toggleStatus(k,!1)}catch(e){Log.trace("".concat(k," translation is disalbled"))}})),toggleAutotranslateButton(),countWordAndChar()},hideErrorMessage=key=>{let parent=domQuery(Selectors.editors.multiples.editorsWithKey,key),alertChild=domQuery(".alert-danger","",parent);alertChild&&parent.removeChild(alertChild)},switchTarget=e=>{let url=new URL(window.location.href);url.searchParams.set("target_lang",e.target.value),window.location=url.toString()},switchSource=e=>{let url=new URL(window.location.href);url.searchParams.set("lang",e.target.value),window.location=url.toString()},countWordAndChar=()=>{let wrdsc=0,cws=0,cwos=0;domQueryAll(Selectors.statuses.checkedCheckBoxes).forEach((ckBox=>{let key=ckBox.getAttribute("data-key"),results=getCount(key);wrdsc+=results.wordCount,cwos+=results.charNumWithOutSpace,cws+=results.charNumWithSpace}));const wordCount=domQuery(Selectors.statuses.wordcount),charWithSpace=domQuery(Selectors.statuses.charNumWithSpace),charWOSpace=domQuery(Selectors.statuses.charNumWithOutSpace),deeplUseSpan=domQuery(Selectors.statuses.deeplUsage),deeplMaxSpan=domQuery(Selectors.statuses.deeplMax),parent=domQuery(Selectors.statuses.deeplStatusContainer);let current=cwos+config.usage.character.count;wordCount.innerText=wrdsc,charWithSpace.innerText=cws,charWOSpace.innerText=cwos,deeplUseSpan.innerText=format.format(current),deeplMaxSpan.innerText=null===config.usage.character.limit?"âˆž":format.format(config.usage.character.limit),current>=config.usage.character.limit?(parent.classList.remove("alert-success"),parent.classList.add("alert-danger")):(parent.classList.add("alert-success"),parent.classList.remove("alert-danger"))},findEditor=key=>{let e=domQuery(Selectors.editors.types.basic,key);if(null===e){let r=null;if(-1===["atto","tiny","marklar","textarea"].indexOf(config.userPrefs))Log.warn("Unsupported editor "+config.userPrefs);else try{r=findEditorByType(key,config.userPrefs)}catch(error){Log.trace("Editor not found: ".concat(config.userPrefs," for key ").concat(key))}return r}return{editor:e,editorType:"basic"}},findEditorByType=(key,editorType)=>{let et="basic",ed=null;switch(editorType){case"atto":et="iframe",ed=domQuery(Selectors.editors.types.atto,key);break;case"tiny":et="iframe",ed=findTinyInstanceByKey(key);break;case"marklar":case"textarea":ed=domQuery(Selectors.editors.types.other,key)}return{editor:ed,editorType:et}},findTinyInstanceByKey=key=>(TinyMCE.getAllInstances().forEach(((k,v)=>{if(v.attributes.name.value===key)return k.getBody()})),null),getCount=key=>{const raw=domQuery(Selectors.sourcetexts.keys,key).getAttribute("data-sourcetext-raw"),trimmedVal=Utils.stripHTMLTags(Utils.fromBase64(raw)).trim();return{wordCount:(trimmedVal.match(/\S+/g)||[]).length,charNumWithSpace:trimmedVal.length,charNumWithOutSpace:trimmedVal.replace(/\s+/g,"").length}},domQuery=function(selector){let key=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",target=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const el=null!=target?target:document,q=""===key?selector:selector.replace("<KEY>",key);return el.querySelector(q)},domQueryAll=function(selector){let key=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",target=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const el=null!=target?target:document,q=""===key?selector:selector.replace("<KEY>",key);return el.querySelectorAll(q)};return{init:cfg=>{var e;config=cfg,Log.info(cfg),getString("errordbtitle","local_deepler").then((s=>{errordbtitle=s})).catch((e=>{e("errordbtitle, could not get Moodle string!!!")})),Log.info(errordbtitle),(()=>{try{saveAllBtn=document.querySelector(Selectors.actions.saveAll),Translation.setMainLangs(config.currentlang,config.lang),selectAllBtn=domQuery(Selectors.actions.selectAllBtn),autotranslateButton=domQuery(Selectors.actions.autoTranslateBtn),checkboxes=domQueryAll(Selectors.actions.checkBoxes)}catch(e){config.debug&&Log.error(e.message)}})(),document.addEventListener("change",handleChangeEvent),document.addEventListener("click",handleClickEvent),Events.on(Translation.ON_ITEM_TRANSLATED,onItemTranslated),Events.on(Translation.ON,onItemTranslated),Events.on(Translation.ON_ITEM_TRANSLATED,onItemTranslated),toggleAutotranslateButton(),e=config.lang,Translation.setMainLangs("",e),saveAllBtn.disabled=!0,selectAllBtn.disabled=!Translation.isTranslatable(),checkboxes.forEach((node=>{node.disabled=selectAllBtn.disabled})),showRows(Selectors.statuses.updated,domQuery(Selectors.actions.showUpdated).checked),showRows(Selectors.statuses.needsupdate,domQuery(Selectors.actions.showNeedUpdate).checked)},setIconStatus:setIconStatus,findEditor:findEditor,findEditorByType:findEditorByType}}));

//# sourceMappingURL=ui.min.js.map