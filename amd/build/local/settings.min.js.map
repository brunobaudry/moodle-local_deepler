{"version":3,"file":"settings.min.js","sources":["../../src/local/settings.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n *  description here.\n *\n * @module     'local_deepler'; // Full name of the plugin (used for diagnostics)./local/settings\n * @copyright  2025 Bruno Baudry <bruno.baudry@bfh.ch>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(\n    ['./selectors',\n    './utils',\n    'core/log'],\n    (Selectors,\n    Utils, Log)=>{\n        let config;\n        let settingsUI = {};\n        const registerUI = () => {\n            try {\n            settingsUI[Selectors.deepl.glossaryId] = Utils.domQuery(Selectors.deepl.glossaryId);\n            settingsUI[Selectors.deepl.context] = Utils.domQuery(Selectors.deepl.context);\n            settingsUI[Selectors.deepl.formality] = Utils.domQuery(Selectors.deepl.formality);\n            settingsUI[Selectors.deepl.modelType] = Utils.domQuery(Selectors.deepl.modelType);\n            settingsUI[Selectors.deepl.ignoreTags] = Utils.domQuery(Selectors.deepl.ignoreTags);\n            settingsUI[Selectors.deepl.nonSplittingTags] = Utils.domQuery(Selectors.deepl.nonSplittingTags);\n            settingsUI[Selectors.deepl.outlineDetection] = Utils.domQuery(Selectors.deepl.outlineDetection);\n            settingsUI[Selectors.deepl.preserveFormatting] = Utils.domQuery(Selectors.deepl.preserveFormatting);\n            settingsUI[Selectors.deepl.splitSentences] = Utils.domQuery(Selectors.deepl.splitSentences);\n            settingsUI[Selectors.deepl.splittingTags] = Utils.domQuery(Selectors.deepl.splittingTags);\n            settingsUI[Selectors.deepl.tagHandling] = Utils.domQuery(Selectors.deepl.tagHandling);\n            if (!config.isfree) {\n                settingsUI[Selectors.deepl.toneorstyle] = Utils.domQuery(Selectors.deepl.toneorstyle);\n            }\n            settingsUI[Selectors.actions.escapeLatex] = Utils.domQuery(Selectors.actions.escapeLatex);\n            settingsUI[Selectors.actions.escapePre] = Utils.domQuery(Selectors.actions.escapePre);\n        } catch (e) {\n            if (config.debug) {\n                Log.error(e.message);\n            }\n        }\n        };\n\n        /**\n         * Get the stored settings for this course and lang pair.\n         */\n        const fetchCookies = () => {\n            if (!config.targetlang) {\n                return;\n            }\n            const glossaryCookie = Utils.getCookie(config);\n            const newCookie = Utils.getEncodedCookie(config);\n            if (newCookie !== null) {\n                const settingsCookie = JSON.parse(newCookie);\n                for (const selector in settingsUI) {\n                    if (settingsCookie[selector] !== undefined) {\n                        switch (settingsUI[selector].type) {\n                            case 'select-one' :\n                                setOptionFromCookie(settingsCookie[selector]);\n                                break;\n                            case 'checkbox' :\n                                settingsUI[selector].checked = settingsCookie[selector];\n                                break;\n                            case 'radio' :\n                                Utils.domQuery(selector + `[value=\"${settingsCookie[selector]}\"]`).checked = true;\n                                break;\n                            default:\n                                settingsUI[selector].value = settingsCookie[selector];\n                                break;\n                        }\n\n                    }\n                }\n            }\n            if (glossaryCookie !== null) {\n                // Legacy cookie.\n                settingsUI[Selectors.deepl.glossaryId].value = glossaryCookie;\n            }\n        };\n        /**\n         * Parse the advanced settings UI and map the values for cookies and Deepl.\n         *\n         * @returns {[{},{}]}\n         */\n        const prepareSettingsAndCookieValues = () => {\n            let settings = {};\n            let cookie = {};\n            for (const selector in settingsUI) {\n                if (settingsUI[selector] === null) {\n                    Log.warn(`prepareSettingsAndCookieValues. Could not find selector ${selector}`);\n                    Log.warn(settingsUI);\n                } else {\n                    switch (settingsUI[selector].type) {\n                        case 'select-one':\n                            cookie[selector] = settingsUI[selector].value;\n                            settings[selector] = settingsUI[selector].value;\n                            break;\n                        case 'textarea':\n                            cookie[selector] = settingsUI[selector].value;\n                            // Deepl needs an array.\n                            settings[selector] = Utils.toJsonArray(cookie[selector]);\n                            break;\n                        case 'checkbox':\n                            if (selector === Selectors.deepl.tagHandling) {\n                                cookie[selector] = settingsUI[selector].checked;\n                                // Exception for tag_handling that checkbox but not boolean value for Deepl.\n                                settings[selector] = settingsUI[selector].checked ? 'html' : 'xml';\n                            } else {\n                                settings[selector] = cookie[selector] = settingsUI[selector].checked;\n                            }\n                            break;\n                        case 'radio':\n                            cookie[selector] = Utils.domQuery(Selectors.actions.radioValues.replace(\"<RADIO>\", selector)).value;\n                            settings[selector] = cookie[selector];\n                            break;\n                        default: // Text.\n                            settings[selector] = cookie[selector] = settingsUI[selector].value;\n                            break;\n                    }\n                }\n            }\n            return [cookie, settings];\n        };\n        const getValue = (selector)=>{\n           return settingsUI[selector].value;\n        };\n        /**\n         * Selects a dd based on its value.\n         * @param {string} value\n         */\n        const setOptionFromCookie = (value)=>{\n            let optionToSelect = Utils.domQuery(`option[value=\"${value}\"]`);\n            if (optionToSelect) {\n                optionToSelect.selected = true;\n            }\n        };\n        const init = (cfg)=>{\n            config = cfg;\n            registerUI();\n            fetchCookies();\n        };\n        return {\n            init: init,\n            getValue: getValue,\n            prepareSettingsAndCookieValues: prepareSettingsAndCookieValues\n        };\n    }\n);\n"],"names":["define","Selectors","Utils","Log","config","settingsUI","setOptionFromCookie","value","optionToSelect","domQuery","selected","init","cfg","deepl","glossaryId","context","formality","modelType","ignoreTags","nonSplittingTags","outlineDetection","preserveFormatting","splitSentences","splittingTags","tagHandling","isfree","toneorstyle","actions","escapeLatex","escapePre","e","debug","error","message","registerUI","targetlang","glossaryCookie","getCookie","newCookie","getEncodedCookie","settingsCookie","JSON","parse","selector","undefined","type","checked","fetchCookies","getValue","prepareSettingsAndCookieValues","settings","cookie","warn","toJsonArray","radioValues","replace"],"mappings":"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"}