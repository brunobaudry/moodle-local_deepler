{"version":3,"file":"settings.min.js","sources":["../../src/local/settings.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n *  description here.\n *\n * @module     'local_deepler'; // Full name of the plugin (used for diagnostics)./local/settings\n * @copyright  2025 Bruno Baudry <bruno.baudry@bfh.ch>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(\n    [\n        './selectors',\n    './utils',\n        './uiHelpers',\n    'core/log'\n    ],\n    (\n        Selectors,\n        Utils,\n        UI,\n        Log)=>{\n        let config;\n        let settingsUI = {};\n        const registerUI = () => {\n            try {\n            settingsUI[Selectors.deepl.glossaryId] = UI.settingsQuery(Selectors.deepl.glossaryId);\n            settingsUI[Selectors.deepl.context] = UI.settingsQuery(Selectors.deepl.context);\n            settingsUI[Selectors.deepl.formality] = UI.settingsQuery(Selectors.deepl.formality);\n            settingsUI[Selectors.deepl.modelType] = UI.settingsQuery(Selectors.deepl.modelType);\n            settingsUI[Selectors.deepl.ignoreTags] = UI.settingsQuery(Selectors.deepl.ignoreTags);\n            settingsUI[Selectors.deepl.nonSplittingTags] = UI.settingsQuery(Selectors.deepl.nonSplittingTags);\n            settingsUI[Selectors.deepl.outlineDetection] = UI.settingsQuery(Selectors.deepl.outlineDetection);\n            settingsUI[Selectors.deepl.preserveFormatting] = UI.settingsQuery(Selectors.deepl.preserveFormatting);\n            settingsUI[Selectors.deepl.splitSentences] = UI.settingsQuery(Selectors.deepl.splitSentences);\n            settingsUI[Selectors.deepl.splittingTags] = UI.settingsQuery(Selectors.deepl.splittingTags);\n            settingsUI[Selectors.deepl.tagHandling] = UI.settingsQuery(Selectors.deepl.tagHandling);\n            if (!config.isfree) {\n                settingsUI[Selectors.deepl.toneorstyle] = UI.settingsQuery(Selectors.deepl.toneorstyle);\n            }\n            settingsUI[Selectors.actions.escapeLatex] = UI.settingsQuery(Selectors.actions.escapeLatex);\n            settingsUI[Selectors.actions.escapePre] = UI.settingsQuery(Selectors.actions.escapePre);\n        } catch (e) {\n            if (config.debug) {\n                Log.error(e.message);\n            }\n        }\n        };\n\n        /**\n         * Get the stored settings for this course and lang pair.\n         */\n        const fetchCookies = () => {\n            if (!config.targetlang) {\n                return;\n            }\n            const glossaryCookie = Utils.getCookie(config);\n            const newCookie = Utils.getEncodedCookie(config);\n            if (newCookie !== null) {\n                const settingsCookie = JSON.parse(newCookie);\n                for (const selector in settingsUI) {\n                    if (settingsCookie[selector] !== undefined) {\n                        switch (settingsUI[selector].type) {\n                            case 'select-one' :\n                                setOptionFromCookie(settingsCookie[selector]);\n                                break;\n                            case 'checkbox' :\n                                settingsUI[selector].checked = settingsCookie[selector];\n                                break;\n                            case 'radio' :\n                                UI.settingsQuery(selector + `[value=\"${settingsCookie[selector]}\"]`).checked = true;\n                                break;\n                            default:\n                                settingsUI[selector].value = settingsCookie[selector];\n                                break;\n                        }\n\n                    }\n                }\n            }\n            if (glossaryCookie !== null) {\n                // Legacy cookie.\n                settingsUI[Selectors.deepl.glossaryId].value = glossaryCookie;\n            }\n        };\n        /**\n         * Parse the advanced settings UI and map the values for cookies and Deepl.\n         *\n         * @returns {[{},{}]}\n         */\n        const prepareSettingsAndCookieValues = () => {\n            let settings = {};\n            let cookie = {};\n            for (const selector in settingsUI) {\n                if (settingsUI[selector] === null) {\n                    Log.warn(`prepareSettingsAndCookieValues. Could not find selector ${selector}`);\n                    Log.warn(settingsUI);\n                } else {\n                    switch (settingsUI[selector].type) {\n                        case 'select-one':\n                            cookie[selector] = settingsUI[selector].value;\n                            settings[selector] = settingsUI[selector].value;\n                            break;\n                        case 'textarea':\n                            cookie[selector] = settingsUI[selector].value;\n                            // Deepl needs an array.\n                            settings[selector] = Utils.toJsonArray(cookie[selector]);\n                            break;\n                        case 'checkbox':\n                            if (selector === Selectors.deepl.tagHandling) {\n                                cookie[selector] = settingsUI[selector].checked;\n                                // Exception for tag_handling that checkbox but not boolean value for Deepl.\n                                settings[selector] = settingsUI[selector].checked ? 'html' : 'xml';\n                            } else {\n                                settings[selector] = cookie[selector] = settingsUI[selector].checked;\n                            }\n                            break;\n                        case 'radio':\n                            cookie[selector] = UI.settingsQuery(Selectors.actions.radioValues.replace(\"<RADIO>\", selector)).value;\n                            settings[selector] = cookie[selector];\n                            break;\n                        default: // Text.\n                            settings[selector] = cookie[selector] = settingsUI[selector].value;\n                            break;\n                    }\n                }\n            }\n            return [cookie, settings];\n        };\n        const getValue = (selector)=>{\n           return settingsUI[selector].value;\n        };\n        /**\n         * Selects a dd based on its value.\n         * @param {string} value\n         */\n        const setOptionFromCookie = (value)=>{\n            let optionToSelect = UI.settingsQuery(`option[value=\"${value}\"]`);\n            if (optionToSelect) {\n                optionToSelect.selected = true;\n            }\n        };\n        const init = (cfg)=>{\n            config = cfg;\n            registerUI();\n            fetchCookies();\n        };\n        return {\n            init: init,\n            getValue: getValue,\n            prepareSettingsAndCookieValues: prepareSettingsAndCookieValues\n        };\n    }\n);\n"],"names":["define","Selectors","Utils","UI","Log","config","settingsUI","setOptionFromCookie","value","optionToSelect","settingsQuery","selected","init","cfg","deepl","glossaryId","context","formality","modelType","ignoreTags","nonSplittingTags","outlineDetection","preserveFormatting","splitSentences","splittingTags","tagHandling","isfree","toneorstyle","actions","escapeLatex","escapePre","e","debug","error","message","registerUI","targetlang","glossaryCookie","getCookie","newCookie","getEncodedCookie","settingsCookie","JSON","parse","selector","undefined","type","checked","fetchCookies","getValue","prepareSettingsAndCookieValues","settings","cookie","warn","toJsonArray","radioValues","replace"],"mappings":"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"}