/**
 *  description here.
 *
 * @module     'local_deepler'; // Full name of the plugin (used for diagnostics)./local/uiHelpers
 * @copyright  2025 Bruno Baudry <bruno.baudry@bfh.ch>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_deepler/local/uiHelpers",["core/modal","core/log","editor_tiny/loader","editor_tiny/editor","./utils","./selectors","./customevents","./translation"],((Modal,Log,TinyMCEinit,TinyMCE,Utils,Selectors,Events,Translation)=>{let mainContainer,formContainer,settingsContainer,sourcetargetContainer,activityfilterContainer,statusfilterContainer,glossaryDetailViewr,config={},format=new Intl.NumberFormat,autotranslateButton={},saveAllBtn={},saveAllModal={},langstrings={},selectAllBtn={},removedIframes=[],allDataFormatOne=[],checkboxes=[],allRows=[],checkBoxParentMap=new Map;const optionsForTiny={subdirs:!1,maxbytes:10240,maxfiles:0,noclean:!0,trusttext:!0,enable_filemanagement:!1,autosave:!1,removeorphaneddrafts:!0,plugins:[]},cachedSelectors={wordCount:document.querySelector(Selectors.statuses.wordcount),charWithSpace:document.querySelector(Selectors.statuses.charNumWithSpace),charWOSpace:document.querySelector(Selectors.statuses.charNumWithOutSpace),deeplUseSpan:document.querySelector(Selectors.statuses.deeplUsage),deeplMaxSpan:document.querySelector(Selectors.statuses.deeplMax),deeplStatusContainer:document.querySelector(Selectors.statuses.deeplStatusContainer)};function doHideiframes(){const isChecked=settingsQuery(Selectors.actions.hideiframes),allIframes=formQueryAll(Selectors.sourcetexts.iframes);!isChecked&&allIframes.length>0?(removedIframes=[],allIframes.forEach((iframe=>{removedIframes.push({parent:iframe.parentNode,nextSibling:iframe.nextSibling,html:iframe.outerHTML}),iframe.remove()}))):removedIframes.length>0&&(removedIframes.forEach((info=>{const tempDiv=document.createElement("div");tempDiv.innerHTML=info.html;const newIframe=tempDiv.firstChild;info.nextSibling?info.parent.insertBefore(newIframe,info.nextSibling):info.parent.appendChild(newIframe)})),removedIframes=[])}const findEditor=(key,row)=>{let e=formQuery(Selectors.editors.types.basic,key,row);if(null===e){let r=null;if(-1===["atto","tiny","marklar","textarea"].indexOf(config.userPrefs))Log.warn("Unsupported editor "+config.userPrefs);else try{r=findEditorByType(key,config.userPrefs,row)}catch(error){Log.trace("Editor not found: ".concat(config.userPrefs," for key ").concat(key))}return r}return{editor:e,editorType:"basic"}},findEditorByType=(key,editorType,row)=>{let et="basic",ed=null;switch(editorType){case"atto":et="iframe",ed=formQuery(Selectors.editors.types.atto,key,row);break;case"tiny":et="iframe",ed=findTinyInstanceByKey(key);break;case"marklar":case"textarea":ed=formQuery(Selectors.editors.types.other,key,row)}return{editor:ed,editorType:et}},findTinyInstanceByKey=key=>{let editor=null;return TinyMCE.getAllInstances().every(((k,v)=>0!==v.attributes.name.value.indexOf(key)||(editor=k.getBody(),!1))),editor},countWordAndChar=()=>{let wrdsc=0,cws=0,cwos=0;Array.from(formQueryAll(Selectors.statuses.checkedCheckBoxes)).forEach((ckBox=>{const key=ckBox.getAttribute("data-key"),results=getCount(key);wrdsc+=results.wordCount,cws+=results.charNumWithSpace,cwos+=results.charNumWithOutSpace}));const wordCount=cachedSelectors.wordCount,charWithSpace=cachedSelectors.charWithSpace,charWOSpace=cachedSelectors.charWOSpace,deeplUseSpan=cachedSelectors.deeplUseSpan,deeplMaxSpan=cachedSelectors.deeplMaxSpan,parent=cachedSelectors.deeplStatusContainer,current=cws+config.usage.character.count;wordCount.innerText=wrdsc,charWithSpace.innerText=cws,charWOSpace.innerText=cwos,deeplUseSpan.innerText=format.format(current),deeplMaxSpan.innerText=null===config.usage.character.limit?"âˆž":format.format(config.usage.character.limit),parent.classList.toggle("alert-success",current<config.usage.character.limit||null===config.usage.character.limit),parent.classList.toggle("alert-danger",current>=config.usage.character.limit&&null!==config.usage.character.limit)},getCount=key=>{const raw=formQuery(Selectors.sourcetexts.singlelangkeys,key).getAttribute("data-sourcetext-raw"),trimmedVal=Utils.stripHTMLTags(Utils.fromBase64(raw)).trim();return{wordCount:(trimmedVal.match(/\S+/g)||[]).length,charNumWithSpace:trimmedVal.length,charNumWithOutSpace:trimmedVal.replace(/\s+/g,"").length}},toggleStatus=(row,checked)=>{const key=row.getAttribute("data-row-id"),translated=Translation.translated(key),icon=formQuery(Selectors.actions.validatorBtn,key),status=null==icon?void 0:icon.dataset.status;if(status)switch(status){case Selectors.process.wait:checked&&setIconElementStatus(icon,Selectors.process.totranslate);break;case Selectors.process.totranslate:checked&&translated?setIconElementStatus(icon,Selectors.process.tosave,!0):setIconElementStatus(icon,Selectors.process.wait);break;case Selectors.process.tosave:checked||setIconElementStatus(icon,Selectors.process.totranslate);break;case Selectors.process.failed:checked&&setIconElementStatus(icon,Selectors.process.totranslate);break;case Selectors.process.success:break;case Selectors.process.saved:checked&&setIconElementStatus(icon,Selectors.process.totranslate)}},setIconElementStatus=function(icon){let status=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Selectors.process.wait,isBtn=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!icon)return;const classList=icon.classList;isBtn?(classList.contains("btn")||classList.add("btn","btn-outline-secondary"),classList.contains("disable")&&classList.remove("disable")):(classList.contains("disable")||classList.add("disable"),classList.contains("btn")&&classList.remove("btn","btn-outline-secondary")),icon.getAttribute("role")!==(isBtn?"button":"status")&&icon.setAttribute("role",isBtn?"button":"status"),icon.dataset.status!==status&&icon.setAttribute("data-status",status);const title=langstrings.statusstrings[status.replace("local_deepler/","")];icon.getAttribute("title")!==title&&icon.setAttribute("title",title)},getIconStatus=key=>formQuery(Selectors.actions.validatorBtn,key).getAttribute("data-status"),launchModal=async messageObject=>{saveAllModal=await Modal.create(messageObject),await saveAllModal.show()},dbErrorModal=function(body){let titleSuffix=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",title=langstrings.uistrings.errordbtitle;""!==titleSuffix&&(title+=titleSuffix),presentDialogModal(title,body,"alert")},presentDialogModal=function(title,body){let type=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"default";Modal.create({title:title,body:body,type:type,show:!0,removeOnClose:!0})},resizeEditors=()=>{allDataFormatOne.forEach((editable=>{const grandparent=editable.closest("[data-row-id]"),sourceTextSinglelang=formQuery(Selectors.sourcetexts.singlelang,"",grandparent),sourceTextMultilang=formQuery(Selectors.sourcetexts.multilangs,"",grandparent),resizeObserver=new ResizeObserver((()=>{(()=>{const totalHeight=(sourceTextMultilang.classList.contains("show")?sourceTextMultilang:sourceTextSinglelang).offsetHeight+80;editable.style.height=totalHeight+"px"})()}));resizeObserver.observe(sourceTextSinglelang),resizeObserver.observe(sourceTextMultilang)}))},toggleAutotranslateButton=()=>{autotranslateButton.disabled=!Array.from(checkboxes).some((e=>e.checked))},debouncedShowRows=Utils.debounce((()=>{showRows()}),100),showRows=()=>{const selectorMap={[Selectors.statuses.updated]:statusFilterQuery(Selectors.actions.showUpdated).checked,[Selectors.statuses.needsupdate]:statusFilterQuery(Selectors.actions.showNeedUpdate).checked,[Selectors.statuses.hidden]:statusFilterQuery(Selectors.actions.showHidden).checked},mergedSelector=Object.keys(selectorMap).join(","),allItems=formQueryAll(mergedSelector),allSelected=statusFilterQuery(Selectors.actions.selectAllBtn).checked;allItems.forEach((item=>{let shouldShow=!1,shouldCheck=!1;for(const[selector,checked]of Object.entries(selectorMap))if(item.matches(selector)){shouldShow=checked,shouldCheck=allSelected&&checked;break}item.classList.toggle("d-none",!shouldShow);let rowId=item.getAttribute("data-row-id");if(null===rowId){formQueryAll(Selectors.statuses.hiddenForStudentRows,"",item).forEach((child=>{const childId=child.getAttribute("data-row-id");toggleChildCheckBoxSelection(childId,shouldCheck)}))}else toggleChildCheckBoxSelection(rowId,shouldCheck)})),toggleAutotranslateButton(),countWordAndChar(),resizeEditors()},toggleChildCheckBoxSelection=(row,shouldBeChecked)=>{const rowEl="string"==typeof row?formQuery(Selectors.actions.corerowid,row):row;if(!rowEl)return;const single=formQuery(Selectors.actions.checkBoxes,"",rowEl);single&&(single.checked=shouldBeChecked),toggleStatus(rowEl,!1)},disableSaveButton=()=>{saveAllBtn.disabled=!0},formQuery=function(selector){let key=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",parent=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return domQuery(selector,key,null!=parent?parent:formContainer)},settingsQuery=function(selector){let key=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",parent=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return domQuery(selector,key,null!=parent?parent:settingsContainer)},statusFilterQuery=function(selector){let key=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",parent=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return domQuery(selector,key,null!=parent?parent:statusfilterContainer)},formQueryAll=function(selector){let key=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",parent=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return domQueryAll(selector,key,null!=parent?parent:formContainer)},domQuery=function(selector){let key=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",target=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const el=null!=target?target:mainContainer,q=""===key?selector:selector.replace("<KEY>",key);return el.querySelector(q)},domQueryAll=function(selector){let key=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",target=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const el=null!=target?target:mainContainer,q=""===key?selector:selector.replace("<KEY>",key);return el.querySelectorAll(q)};return{domQuery:domQuery,formQuery:formQuery,formQueryAll:formQueryAll,settingsQuery:settingsQuery,settingsQueryAll:function(selector){let key=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",parent=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return domQueryAll(selector,key,null!=parent?parent:settingsContainer)},statusFilterQuery:statusFilterQuery,statusFilterQueryAll:function(selector){let key=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",parent=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return domQueryAll(selector,key,null!=parent?parent:statusfilterContainer)},activityFilterQuery:function(selector){let key=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",parent=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return domQuery(selector,key,null!=parent?parent:activityfilterContainer)},activityFilterQueryAll:function(selector){let key=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",parent=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return domQueryAll(selector,key,null!=parent?parent:activityfilterContainer)},domQueryAll:domQueryAll,backToBase:()=>{const offsetTop=domQuery(Selectors.config.langstrings).offsetTop;window.scrollTo({top:offsetTop-5,behavior:"smooth"})},countWordAndChar:countWordAndChar,dbErrorModal:dbErrorModal,dbErrorPartialModal:stringVar=>{const body=langstrings.uistrings.errordbpartial.replace("{$a}",stringVar);dbErrorModal(body)},disableSaveButton:disableSaveButton,disableTranslateButton:()=>{autotranslateButton.disabled=!0},enableSaveButton:()=>{saveAllBtn.disabled=!1},enableTranslateButton:()=>{autotranslateButton.disabled=!1},debouncedShowRows:debouncedShowRows,deeplErrorModal:body=>{presentDialogModal(langstrings.uistrings.deeplapiexception,body,"Alert")},doHideiframes:doHideiframes,findEditor:findEditor,getIconStatus:getIconStatus,hideModal:()=>{null!==saveAllModal&&saveAllModal.isVisible&&saveAllModal.hide()},hideErrorMessageForRow:row=>{let alertChild=domQuery(".alert-danger","",row);alertChild&&row.removeChild(alertChild)},init:cfg=>{config=cfg,mainContainer=document.querySelector(Selectors.config.main),formContainer=mainContainer.querySelector(Selectors.config.form),allRows=formQueryAll(Selectors.actions.corerowid),settingsContainer=mainContainer.querySelector(Selectors.config.advancedsettings),sourcetargetContainer=mainContainer.querySelector(Selectors.config.sourcetarget),Log.log(sourcetargetContainer),activityfilterContainer=mainContainer.querySelector(Selectors.config.activityfilter),statusfilterContainer=mainContainer.querySelector(Selectors.config.statusfilter),!glossaryDetailViewr&&document.querySelector(Selectors.glossary.entriesviewerPage)&&(glossaryDetailViewr=document.querySelector(Selectors.glossary.entriesviewerPage)),autotranslateButton=statusFilterQuery(Selectors.actions.autoTranslateBtn),checkboxes=formQueryAll(Selectors.actions.checkBoxes),allDataFormatOne=formQueryAll(Selectors.editors.targetarea),selectAllBtn=statusFilterQuery(Selectors.actions.selectAllBtn),saveAllBtn=statusFilterQuery(Selectors.actions.saveAll),langstrings=JSON.parse(domQuery(Selectors.config.langstrings).getAttribute("data-langstrings")),doHideiframes(),toggleAutotranslateButton(),disableSaveButton(),selectAllBtn.disabled=""===config.targetlang,checkboxes.forEach((node=>{node.disabled=selectAllBtn.disabled})),allRows.forEach((row=>{const key=row.getAttribute("data-row-id"),editor=findEditor(key,row),sourceEl=formQuery(Selectors.sourcetexts.singlelangkeys,key,row),srcRaw=sourceEl?sourceEl.getAttribute("data-sourcetext-raw"):"",multiRaw=sourceEl?sourceEl.getAttribute("data-filedtext-raw"):"";Translation.initTemp(key,editor.editor,editor.editorType,srcRaw,multiRaw)})),debouncedShowRows()},launchModal:launchModal,launchSaveAllModal:()=>{launchModal({title:langstrings.uistrings.saveallmodaltitle,body:langstrings.uistrings.saveallmodalbody}).then((r=>Log.info("SaveAll Modal launched "+r))).catch((reason=>{Log.error(reason)}))},launchTranslatingModal:()=>launchModal({title:langstrings.uistrings.translatemodaltitle,body:langstrings.uistrings.translatemodalbody}),prepareRowForDB:(row,courseId)=>({key:row.getAttribute("data-row-id"),courseid:courseId,tid:row.getAttribute("data-tid")}),presentDialogModal:presentDialogModal,setIconStatus:function(key){let status=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Selectors.process.wait,isBtn=arguments.length>2&&void 0!==arguments[2]&&arguments[2],icon=formQuery(Selectors.actions.validatorBtn,key);setIconElementStatus(icon,status,isBtn)},showEntriesModal:ajaxResponse=>{const glossaryid=ajaxResponse.glossaryid,entries=JSON.parse(ajaxResponse.entries),status=ajaxResponse.status,message=ajaxResponse.message;if("success"===status){const table=document.createElement("table");table.className="generaltable";const thead=document.createElement("thead");thead.innerHTML="<tr><th>".concat(ajaxResponse.source.toUpperCase(),"</th>\n                <th>").concat(ajaxResponse.target.toUpperCase(),"</th></tr>"),table.appendChild(thead);const tbody=document.createElement("tbody");Object.entries(entries).forEach((_ref=>{let[key,value]=_ref;const row=document.createElement("tr");row.innerHTML="<td>".concat(key,"</td><td>").concat(value,"</td>"),tbody.appendChild(row)})),table.appendChild(tbody),Modal.create({title:"Entries",body:table,type:"default",show:!0,removeOnClose:!0})}else Modal.create({title:"Error fetching entries for<br/><em>".concat(glossaryid,"</em>"),body:message,type:"default",show:!0,removeOnClose:!0})},showErrorMessageForEditor:(key,message)=>{let parent=formQuery(Selectors.editors.multiples.editorsWithKey,key);const errorMsg=document.createElement("div");message.indexOf("Data too long")>-1&&(message=(message=message.substring(0,message.indexOf("WHERE id=?")))+" "+langstrings.uistrings.errortoolong),errorMsg.id="local_deepler__errormsg",errorMsg.classList=["alert alert-danger"],errorMsg.innerHTML=message,parent.appendChild(errorMsg)},toggleAllCheckboxes:checked=>{const updates=[];checkboxes.forEach((checkbox=>{let parent;checkBoxParentMap.has(checkbox)?parent=checkBoxParentMap.get(checkbox):(parent=Utils.getParentRow(checkbox,Selectors.sourcetexts.parentrow),checkBoxParentMap.set(checkbox,parent));const shouldCheck=!!checked&&!parent.classList.contains("d-none");checkbox.checked!==shouldCheck&&updates.push({checkbox:checkbox,shouldCheck:shouldCheck})})),requestAnimationFrame((()=>{updates.forEach((_ref2=>{let{checkbox:checkbox,shouldCheck:shouldCheck}=_ref2;checkbox.checked=shouldCheck;const rowEl=checkBoxParentMap.get(checkbox);toggleStatus(rowEl,shouldCheck)})),toggleAutotranslateButton(),countWordAndChar()}))},toggleAutotranslateButton:toggleAutotranslateButton,toggleGlossaryDetails:glossaryId=>{glossaryDetailViewr.style.display=""!==glossaryId?"block":"none"},toggleStatus:toggleStatus,wrapTinyOnTarget:element=>{getIconStatus(element.id.replace("tiny_",""))===Selectors.process.tosave&&TinyMCEinit.getTinyMCE().then((()=>{TinyMCE.setupForTarget(element,optionsForTiny).then((()=>{Log.info("tiny loaded for "+element.id)})).catch((r=>{Log.error(r)}))}))}}}));

//# sourceMappingURL=uiHelpers.min.js.map