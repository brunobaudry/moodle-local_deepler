define(["core/modal","core/log","editor_tiny/loader","editor_tiny/editor","./utils","./selectors","./customevents","./translation"],(l,r,H,t,o,d,Q,s)=>{let i,n,c,a,u,g,h={},p=new Intl.NumberFormat,b={},m={},y={},f={},v={},w=[],S=[],x=[],P=[],A,k=new Map,U={subdirs:!1,maxbytes:10240,maxfiles:0,noclean:!0,trusttext:!0,enable_filemanagement:!1,autosave:!1,removeorphaneddrafts:!0,plugins:[]},E={wordCount:document.querySelector(d.statuses.wordcount),charWithSpace:document.querySelector(d.statuses.charNumWithSpace),charWOSpace:document.querySelector(d.statuses.charNumWithOutSpace),deeplUseSpan:document.querySelector(d.statuses.deeplUsage),deeplMaxSpan:document.querySelector(d.statuses.deeplMax),deeplStatusContainer:document.querySelector(d.statuses.deeplStatusContainer)};function _(){var e=V(d.actions.hideiframes),t=W(d.sourcetexts.iframes);!e&&0<t.length?(w=[],t.forEach(e=>{w.push({parent:e.parentNode,nextSibling:e.nextSibling,html:e.outerHTML}),e.remove()})):0<w.length&&(w.forEach(e=>{var t=document.createElement("div"),t=(t.innerHTML=e.html,t.firstChild);e.nextSibling?e.parent.insertBefore(t,e.nextSibling):e.parent.appendChild(t)}),w=[])}let R=(t,a)=>{var e=q(d.editors.types.basic,t,a);if(null!==e)return{editor:e,editorType:"basic"};{let e=null;if(-1===["atto","tiny","marklar","textarea"].indexOf(h.userPrefs))r.warn("Unsupported editor "+h.userPrefs);else try{e=((e,t,a)=>{let r="basic",s=null;switch(t){case"atto":r="iframe";s=q(d.editors.types.atto,e,a);break;case"tiny":r="iframe";s=$(e);break;case"marklar":case"textarea":s=q(d.editors.types.other,e,a);break}return{editor:s,editorType:r}})(t,h.userPrefs,a)}catch(e){r.trace(`Editor not found: ${h.userPrefs} for key `+t)}return e}},$=a=>{let r=null;return t.getAllInstances().every((e,t)=>0!==t.attributes.name.value.indexOf(a)||(r=e.getBody(),!1)),r};let T=()=>{let t=0,a=0,r=0;Array.from(W(d.statuses.checkedCheckBoxes)).forEach(e=>{e=e.getAttribute("data-key"),e=j(e);t+=e.wordCount,a+=e.charNumWithSpace,r+=e.charNumWithOutSpace});var e=E.wordCount,s=E.charWithSpace,o=E.charWOSpace,l=E.deeplUseSpan,i=E.deeplMaxSpan,n=E.deeplStatusContainer,c=a+h.usage.character.count;e.innerText=t,s.innerText=a,o.innerText=r,l.innerText=p.format(c),i.innerText=null===h.usage.character.limit?"∞":p.format(h.usage.character.limit),n.classList.toggle("alert-success",c<h.usage.character.limit||null===h.usage.character.limit),n.classList.toggle("alert-danger",c>=h.usage.character.limit&&null!==h.usage.character.limit)},j=e=>{e=q(d.sourcetexts.singlelangkeys,e).getAttribute("data-sourcetext-raw"),e=o.stripHTMLTags(o.fromBase64(e)).trim();return{wordCount:(e.match(/\S+/g)||[]).length,charNumWithSpace:e.length,charNumWithOutSpace:e.replace(/\s+/g,"").length}},C=(e,t)=>{var e=e.getAttribute("data-row-id"),a=s.translated(e),r=q(d.actions.validatorBtn,e),e=r?.dataset.status;if(e)switch(e){case d.process.wait:t&&M(r,d.process.totranslate);break;case d.process.totranslate:t&&a?M(r,d.process.tosave,!0):M(r,d.process.wait);break;case d.process.tosave:t||M(r,d.process.totranslate);break;case d.process.failed:t&&M(r,d.process.totranslate);break;case d.process.success:break;case d.process.saved:t&&M(r,d.process.totranslate)}},M=(e,t=d.process.wait,a=!1)=>{var r;e&&(r=e.classList,a?(r.contains("btn")||r.add("btn","btn-outline-secondary"),r.contains("disable")&&r.remove("disable")):(r.contains("disable")||r.add("disable"),r.contains("btn")&&r.remove("btn","btn-outline-secondary")),e.getAttribute("role")!==(a?"button":"status")&&e.setAttribute("role",a?"button":"status"),e.dataset.status!==t&&e.setAttribute("data-status",t),r=f.statusstrings[t.replace("local_deepler/","")],e.getAttribute("title")!==r)&&e.setAttribute("title",r)};let D=e=>q(d.actions.validatorBtn,e).getAttribute("data-status"),e=async e=>{await(y=await l.create(e)).show()};let I=(e,t="")=>{let a=f.uistrings.errordbtitle;""!==t&&(a+=t),B(a,e,"alert")};let B=(e,t,a="default")=>{l.create({title:e,body:t,type:a,show:!0,removeOnClose:!0})};let K=()=>{S.forEach(t=>{var e=t.closest("[data-row-id]");let a=q(d.sourcetexts.singlelang,"",e),r=q(d.sourcetexts.multilangs,"",e);e=new ResizeObserver(()=>{var e;e=(r.classList.contains("show")?r:a).offsetHeight+80,t.style.height=e+"px"});e.observe(a),e.observe(r)})},O=()=>{b.disabled=!Array.from(x).some(e=>e.checked)};let J=o.debounce(()=>{Y()},100),Y=()=>{let l={[d.statuses.updated]:L(d.actions.showUpdated).checked,[d.statuses.needsupdate]:L(d.actions.showNeedUpdate).checked,[d.statuses.hidden]:L(d.actions.showHidden).checked};var e=Object.keys(l).join(","),e=W(e);let i=L(d.actions.selectAllBtn).checked;e.forEach(e=>{let t=!1,a=!1;for(var[r,s]of Object.entries(l))if(e.matches(r)){t=s,a=i&&s;break}e.classList.toggle("d-none",!t);var o=e.getAttribute("data-row-id");null===o?W(d.statuses.hiddenForStudentRows,"",e).forEach(e=>{e=e.getAttribute("data-row-id");z(e,a)}):z(o,a)}),O(),T(),K()},z=(e,t)=>{var a,e="string"==typeof e?q(d.actions.corerowid,e):e;e&&((a=q(d.actions.checkBoxes,"",e))&&(a.checked=t),C(e,!1))};let G=()=>{m.disabled=!0};let q=(e,t="",a=null)=>N(e,t,a??n),V=(e,t="",a=null)=>N(e,t,a??c);let L=(e,t="",a=null)=>N(e,t,a??g),W=(e,t="",a=null)=>F(e,t,a??n);let N=(e,t="",a=null)=>{a=a??i,e=""===t?e:e.replace("<KEY>",t);return a.querySelector(e)},F=(e,t="",a=null)=>{a=a??i,e=""===t?e:e.replace("<KEY>",t);return a.querySelectorAll(e)};return{domQuery:N,formQuery:q,formQueryAll:W,settingsQuery:V,settingsQueryAll:(e,t="",a=null)=>F(e,t,a??c),statusFilterQuery:L,statusFilterQueryAll:(e,t="",a=null)=>F(e,t,a??g),activityFilterQuery:(e,t="",a=null)=>N(e,t,a??u),activityFilterQueryAll:(e,t="",a=null)=>F(e,t,a??u),domQueryAll:F,backToBase:()=>{var e=N(d.config.langstrings).offsetTop;window.scrollTo({top:e-5,behavior:"smooth"})},countWordAndChar:T,dbErrorModal:I,dbErrorPartialModal:e=>{e=f.uistrings.errordbpartial.replace("{$a}",e);I(e)},disableSaveButton:G,disableTranslateButton:()=>{b.disabled=!0},enableSaveButton:()=>{m.disabled=!1},enableTranslateButton:()=>{b.disabled=!1},debouncedShowRows:J,deeplErrorModal:e=>{B(f.uistrings.deeplapiexception,e,"Alert")},doHideiframes:_,findEditor:R,getIconStatus:D,hideModal:()=>{null!==y&&y.isVisible&&y.hide()},hideErrorMessageForRow:e=>{var t=N(".alert-danger","",e);t&&e.removeChild(t)},init:e=>{h=e,i=document.querySelector(d.config.main),n=i.querySelector(d.config.form),P=W(d.actions.corerowid),c=i.querySelector(d.config.advancedsettings),a=i.querySelector(d.config.sourcetarget),r.log(a),u=i.querySelector(d.config.activityfilter),g=i.querySelector(d.config.statusfilter),!A&&document.querySelector(d.glossary.entriesviewerPage)&&(A=document.querySelector(d.glossary.entriesviewerPage)),b=L(d.actions.autoTranslateBtn),x=W(d.actions.checkBoxes),S=W(d.editors.targetarea),v=L(d.actions.selectAllBtn),m=L(d.actions.saveAll),f=JSON.parse(N(d.config.langstrings).getAttribute("data-langstrings")),_(),O(),G(),v.disabled=""===h.targetlang,x.forEach(e=>{e.disabled=v.disabled}),P.forEach(e=>{var t=e.getAttribute("data-row-id"),a=R(t,e),e=q(d.sourcetexts.singlelangkeys,t,e),r=e?e.getAttribute("data-sourcetext-raw"):"",e=e?e.getAttribute("data-filedtext-raw"):"";s.initTemp(t,a.editor,a.editorType,r,e)}),J()},launchModal:e,launchSaveAllModal:()=>{e({title:f.uistrings.saveallmodaltitle,body:f.uistrings.saveallmodalbody}).then(e=>r.info("SaveAll Modal launched "+e)).catch(e=>{r.error(e)})},launchTranslatingModal:()=>e({title:f.uistrings.translatemodaltitle,body:f.uistrings.translatemodalbody}),prepareRowForDB:(e,t)=>({key:e.getAttribute("data-row-id"),courseid:t,tid:e.getAttribute("data-tid")}),presentDialogModal:B,setIconStatus:(e,t=d.process.wait,a=!1)=>{e=q(d.actions.validatorBtn,e);M(e,t,a)},showEntriesModal:e=>{var t=e.glossaryid,a=JSON.parse(e.entries),s=e.status,r=e.message;if("success"===s){var s=document.createElement("table"),o=(s.className="generaltable",document.createElement("thead"));o.innerHTML=`<tr><th>${e.source.toUpperCase()}</th>
                <th>${e.target.toUpperCase()}</th></tr>`,s.appendChild(o);let r=document.createElement("tbody");Object.entries(a).forEach(([e,t])=>{var a=document.createElement("tr");a.innerHTML=`<td>${e}</td><td>${t}</td>`,r.appendChild(a)}),s.appendChild(r),l.create({title:"Entries",body:s,type:"default",show:!0,removeOnClose:!0})}else l.create({title:`Error fetching entries for<br/><em>${t}</em>`,body:r,type:"default",show:!0,removeOnClose:!0})},showErrorMessageForEditor:(e,t)=>{var e=q(d.editors.multiples.editorsWithKey,e),a=document.createElement("div");-1<t.indexOf("Data too long")&&(t=(t=t.substring(0,t.indexOf("WHERE id=?")))+" "+f.uistrings.errortoolong),a.id="local_deepler__errormsg",a.classList=["alert alert-danger"],a.innerHTML=t,e.appendChild(a)},toggleAllCheckboxes:r=>{let s=[];x.forEach(e=>{let t;k.has(e)?t=k.get(e):(t=o.getParentRow(e,d.sourcetexts.parentrow),k.set(e,t));var a=!!r&&!t.classList.contains("d-none");e.checked!==a&&s.push({checkbox:e,shouldCheck:a})}),requestAnimationFrame(()=>{s.forEach(({checkbox:e,shouldCheck:t})=>{e.checked=t;e=k.get(e);C(e,t)}),O(),T()})},toggleAutotranslateButton:O,toggleGlossaryDetails:e=>{A.style.display=""!==e?"block":"none"},toggleStatus:C,wrapTinyOnTarget:e=>{D(e.id.replace("tiny_",""))===d.process.tosave&&H.getTinyMCE().then(()=>{t.setupForTarget(e,U).then(()=>{r.info("tiny loaded for "+e.id)}).catch(e=>{r.error(e)})})}}}),define(["core/modal","core/log","editor_tiny/loader","editor_tiny/editor","./utils","./selectors","./customevents","./translation"],(l,s,H,o,i,d,Q,n)=>{let r,c,u,t,g,h,p={},b=new Intl.NumberFormat,a={},m={},y={},f={},v={},w=[],S=[],x=[],P=[],A,k=new Map,U={subdirs:!1,maxbytes:10240,maxfiles:0,noclean:!0,trusttext:!0,enable_filemanagement:!1,autosave:!1,removeorphaneddrafts:!0,plugins:[]},E={wordCount:document.querySelector(d.statuses.wordcount),charWithSpace:document.querySelector(d.statuses.charNumWithSpace),charWOSpace:document.querySelector(d.statuses.charNumWithOutSpace),deeplUseSpan:document.querySelector(d.statuses.deeplUsage),deeplMaxSpan:document.querySelector(d.statuses.deeplMax),deeplStatusContainer:document.querySelector(d.statuses.deeplStatusContainer)};function _(){var e=z(d.actions.hideiframes),t=W(d.sourcetexts.iframes);!e&&0<t.length?(w=[],t.forEach(e=>{w.push({parent:e.parentNode,nextSibling:e.nextSibling,html:e.outerHTML}),e.remove()})):0<w.length&&(w.forEach(e=>{(t=document.createElement("div")).innerHTML=e.html;var t=t.firstChild;e.nextSibling?e.parent.insertBefore(t,e.nextSibling):e.parent.appendChild(t)}),w=[])}let R=(t,a)=>{var r=q(d.editors.types.basic,t,a);if(null!==r)return{editor:r,editorType:"basic"};{let e=null;if(-1===["atto","tiny","marklar","textarea"].indexOf(p.userPrefs))s.warn("Unsupported editor "+p.userPrefs);else try{e=((e,t,a)=>{let r="basic",s=null;switch(t){case"atto":r="iframe",s=q(d.editors.types.atto,e,a);break;case"tiny":r="iframe",s=(a=>{let r=null;return o.getAllInstances().every((e,t)=>0!==t.attributes.name.value.indexOf(a)||(r=e.getBody(),!1)),r})(e);break;case"marklar":case"textarea":s=q(d.editors.types.other,e,a)}return{editor:s,editorType:r}})(t,p.userPrefs,a)}catch(r){s.trace(`Editor not found: ${p.userPrefs} for key `+t)}return e}},T=()=>{let t=0,a=0,r=0;Array.from(W(d.statuses.checkedCheckBoxes)).forEach(e=>{e=e.getAttribute("data-key"),e=$(e),t+=e.wordCount,a+=e.charNumWithSpace,r+=e.charNumWithOutSpace});var e=E.wordCount,s=E.charWithSpace,o=E.charWOSpace,l=E.deeplUseSpan,i=E.deeplMaxSpan,n=E.deeplStatusContainer,c=a+p.usage.character.count;e.innerText=t,s.innerText=a,o.innerText=r,l.innerText=b.format(c),i.innerText=null===p.usage.character.limit?"∞":b.format(p.usage.character.limit),n.classList.toggle("alert-success",c<p.usage.character.limit||null===p.usage.character.limit),n.classList.toggle("alert-danger",c>=p.usage.character.limit&&null!==p.usage.character.limit)},$=e=>(e=q(d.sourcetexts.singlelangkeys,e).getAttribute("data-sourcetext-raw"),{wordCount:((e=i.stripHTMLTags(i.fromBase64(e)).trim()).match(/\S+/g)||[]).length,charNumWithSpace:e.length,charNumWithOutSpace:e.replace(/\s+/g,"").length}),C=(e,t)=>{var e=e.getAttribute("data-row-id"),a=n.translated(e),r=q(d.actions.validatorBtn,e);if(e=r?.dataset.status)switch(e){case d.process.wait:t&&M(r,d.process.totranslate);break;case d.process.totranslate:t&&a?M(r,d.process.tosave,!0):M(r,d.process.wait);break;case d.process.tosave:t||M(r,d.process.totranslate);break;case d.process.failed:t&&M(r,d.process.totranslate);break;case d.process.success:break;case d.process.saved:t&&M(r,d.process.totranslate)}},M=(e,t=d.process.wait,a=!1)=>{var r;e&&(r=e.classList,a?(r.contains("btn")||r.add("btn","btn-outline-secondary"),r.contains("disable")&&r.remove("disable")):(r.contains("disable")||r.add("disable"),r.contains("btn")&&r.remove("btn","btn-outline-secondary")),e.getAttribute("role")!==(a?"button":"status")&&e.setAttribute("role",a?"button":"status"),e.dataset.status!==t&&e.setAttribute("data-status",t),r=f.statusstrings[t.replace("local_deepler/","")],e.getAttribute("title")!==r)&&e.setAttribute("title",r)},j=e=>q(d.actions.validatorBtn,e).getAttribute("data-status"),e=async e=>{await(y=await l.create(e)).show()},D=(e,t="")=>{let a=f.uistrings.errordbtitle;""!==t&&(a+=t),B(a,e,"alert")},B=(e,t,a="default")=>{l.create({title:e,body:t,type:a,show:!0,removeOnClose:!0})},O=()=>{a.disabled=!Array.from(x).some(e=>e.checked)},I=i.debounce(()=>{K()},100),K=()=>{let l={[d.statuses.updated]:L(d.actions.showUpdated).checked,[d.statuses.needsupdate]:L(d.actions.showNeedUpdate).checked,[d.statuses.hidden]:L(d.actions.showHidden).checked};var e=Object.keys(l).join(","),e=W(e);let i=L(d.actions.selectAllBtn).checked;e.forEach(e=>{let t=!1,a=!1;for(var[r,s]of Object.entries(l))if(e.matches(r)){t=s,a=i&&s;break}e.classList.toggle("d-none",!t);var o=e.getAttribute("data-row-id");null===o?W(d.statuses.hiddenForStudentRows,"",e).forEach(e=>{e=e.getAttribute("data-row-id"),J(e,a)}):J(o,a)}),O(),T(),S.forEach(t=>{let e=t.closest("[data-row-id]"),a=q(d.sourcetexts.singlelang,"",e),r=q(d.sourcetexts.multilangs,"",e);(e=new ResizeObserver(()=>{var e=(r.classList.contains("show")?r:a).offsetHeight+80;t.style.height=e+"px"})).observe(a),e.observe(r)})},J=(e,t)=>{var a;(e="string"==typeof e?q(d.actions.corerowid,e):e)&&((a=q(d.actions.checkBoxes,"",e))&&(a.checked=t),C(e,!1))},Y=()=>{m.disabled=!0},q=(e,t="",a=null)=>N(e,t,a??c),z=(e,t="",a=null)=>N(e,t,a??u),L=(e,t="",a=null)=>N(e,t,a??h),W=(e,t="",a=null)=>F(e,t,a??c),N=(e,t="",a=null)=>(a=a??r,e=""===t?e:e.replace("<KEY>",t),a.querySelector(e)),F=(e,t="",a=null)=>(a=a??r,e=""===t?e:e.replace("<KEY>",t),a.querySelectorAll(e));return{domQuery:N,formQuery:q,formQueryAll:W,settingsQuery:z,settingsQueryAll:(e,t="",a=null)=>F(e,t,a??u),statusFilterQuery:L,statusFilterQueryAll:(e,t="",a=null)=>F(e,t,a??h),activityFilterQuery:(e,t="",a=null)=>N(e,t,a??g),activityFilterQueryAll:(e,t="",a=null)=>F(e,t,a??g),domQueryAll:F,backToBase:()=>{var e=N(d.config.langstrings).offsetTop;window.scrollTo({top:e-5,behavior:"smooth"})},countWordAndChar:T,dbErrorModal:D,dbErrorPartialModal:e=>{e=f.uistrings.errordbpartial.replace("{$a}",e),D(e)},disableSaveButton:Y,disableTranslateButton:()=>{a.disabled=!0},enableSaveButton:()=>{m.disabled=!1},enableTranslateButton:()=>{a.disabled=!1},debouncedShowRows:I,deeplErrorModal:e=>{B(f.uistrings.deeplapiexception,e,"Alert")},doHideiframes:_,findEditor:R,getIconStatus:j,hideModal:()=>{null!==y&&y.isVisible&&y.hide()},hideErrorMessageForRow:e=>{var t=N(".alert-danger","",e);t&&e.removeChild(t)},init:e=>{p=e,r=document.querySelector(d.config.main),c=r.querySelector(d.config.form),P=W(d.actions.corerowid),u=r.querySelector(d.config.advancedsettings),t=r.querySelector(d.config.sourcetarget),s.log(t),g=r.querySelector(d.config.activityfilter),h=r.querySelector(d.config.statusfilter),!A&&document.querySelector(d.glossary.entriesviewerPage)&&(A=document.querySelector(d.glossary.entriesviewerPage)),a=L(d.actions.autoTranslateBtn),x=W(d.actions.checkBoxes),S=W(d.editors.targetarea),v=L(d.actions.selectAllBtn),m=L(d.actions.saveAll),f=JSON.parse(N(d.config.langstrings).getAttribute("data-langstrings")),_(),O(),Y(),v.disabled=""===p.targetlang,x.forEach(e=>{e.disabled=v.disabled}),P.forEach(e=>{var t=e.getAttribute("data-row-id"),a=R(t,e),r=(e=q(d.sourcetexts.singlelangkeys,t,e))?e.getAttribute("data-sourcetext-raw"):"",e=e?e.getAttribute("data-filedtext-raw"):"";n.initTemp(t,a.editor,a.editorType,r,e)}),I()},launchModal:e,launchSaveAllModal:()=>{e({title:f.uistrings.saveallmodaltitle,body:f.uistrings.saveallmodalbody}).then(e=>s.info("SaveAll Modal launched "+e)).catch(e=>{s.error(e)})},launchTranslatingModal:()=>e({title:f.uistrings.translatemodaltitle,body:f.uistrings.translatemodalbody}),prepareRowForDB:(e,t)=>({key:e.getAttribute("data-row-id"),courseid:t,tid:e.getAttribute("data-tid")}),presentDialogModal:B,setIconStatus:(e,t=d.process.wait,a=!1)=>{e=q(d.actions.validatorBtn,e),M(e,t,a)},showEntriesModal:e=>{var t=e.glossaryid,a=JSON.parse(e.entries),s=e.status,r=e.message;if("success"===s){(s=document.createElement("table")).className="generaltable";var o=document.createElement("thead");o.innerHTML=`<tr><th>${e.source.toUpperCase()}</th>
                <th>${e.target.toUpperCase()}</th></tr>`,s.appendChild(o);let r=document.createElement("tbody");Object.entries(a).forEach(([e,t])=>{var a=document.createElement("tr");a.innerHTML=`<td>${e}</td><td>${t}</td>`,r.appendChild(a)}),s.appendChild(r),l.create({title:"Entries",body:s,type:"default",show:!0,removeOnClose:!0})}else l.create({title:`Error fetching entries for<br/><em>${t}</em>`,body:r,type:"default",show:!0,removeOnClose:!0})},showErrorMessageForEditor:(e,t)=>{var e=q(d.editors.multiples.editorsWithKey,e),a=document.createElement("div");-1<t.indexOf("Data too long")&&(t=(t=t.substring(0,t.indexOf("WHERE id=?")))+" "+f.uistrings.errortoolong),a.id="local_deepler__errormsg",a.classList=["alert alert-danger"],a.innerHTML=t,e.appendChild(a)},toggleAllCheckboxes:r=>{let s=[];x.forEach(e=>{let t;k.has(e)?t=k.get(e):(t=i.getParentRow(e,d.sourcetexts.parentrow),k.set(e,t));var a=!!r&&!t.classList.contains("d-none");e.checked!==a&&s.push({checkbox:e,shouldCheck:a})}),requestAnimationFrame(()=>{s.forEach(({checkbox:e,shouldCheck:t})=>{e.checked=t,e=k.get(e),C(e,t)}),O(),T()})},toggleAutotranslateButton:O,toggleGlossaryDetails:e=>{A.style.display=""!==e?"block":"none"},toggleStatus:C,wrapTinyOnTarget:e=>{j(e.id.replace("tiny_",""))===d.process.tosave&&H.getTinyMCE().then(()=>{o.setupForTarget(e,U).then(()=>{s.info("tiny loaded for "+e.id)}).catch(e=>{s.error(e)})})}}});