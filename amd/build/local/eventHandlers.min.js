define(["core/log","./utils","./translation","./api","./customevents","./selectors","./uiHelpers","./settings"],(s,a,r,o,t,l,i,c)=>{let n={},d,u,g=e=>{e.target.closest(l.editors.targetarea)&&i.wrapTinyOnTarget(e.target)},h=e=>{e.target.closest(l.actions.autoTranslateBtn)&&p(),e.target.closest(l.actions.selectAllBtn)&&(i.toggleAllCheckboxes(e.target.checked),r.updatTempStatusAll(e.target.checked?l.process.totranslate:l.process.wait)),e.target.closest(l.actions.tothetop)&&i.backToBase(),e.target.closest(l.glossary.entriesviewerPage)&&(s.info("CLICK"),s.info(c.getValue(l.deepl.glossaryId)),o.getGlossariesEntries(c.getValue(l.deepl.glossaryId),n.deeplsourcelang,n.targetlang));var t=e.target.closest("[data-row-id]");t&&(e.target.closest(l.actions.toggleMultilang)&&m(t),e.target.closest(l.actions.validatorsBtns))&&t.getAttribute("data-process")===l.process.tosave&&B(t),e.target.closest(l.actions.saveAll)&&D()},S=e=>{e.target.closest(l.actions.escapeLatex),e.target.closest(l.actions.escapePre),e.target.closest(l.actions.hideiframes)&&i.doHideiframes(),e.target.closest(l.actions.targetSwitcher)&&a.switchLocation({key:"target_lang",value:e.target.value.replace(n.rephrasesymbol,"")}),e.target.closest(l.deepl.glossaryId)&&i.toggleGlossaryDetails(c.getValue(l.deepl.glossaryId)),clearTimeout(d),d=setTimeout(()=>{e.target.closest(l.actions.showUpdated)&&i.debouncedShowRows(),e.target.closest(l.actions.showNeedUpdate)&&i.debouncedShowRows(),e.target.closest(l.actions.showHidden)&&i.debouncedShowRows()},30),e.target.closest(l.actions.sectionSwitcher)&&a.switchLocation({key:"section_id",value:e.target.value},"activity_id"),e.target.closest(l.actions.moduleSwitcher)&&a.switchLocation({key:"activity_id",value:e.target.value});var t=e.target.closest("[data-row-id]");if(t){var s=t.getAttribute("data-row-id");switch(e.target.getAttribute("data-action")){case l.actions.checkBoxes:v(t,e.target.checked);break;case l.actions.sourceselect:r.updateTempSourceLang(s,e.target.value)}}},p=()=>{i.launchTranslatingModal();let o=[];var[e,t]=c.prepareSettingsAndCookieValues(),s=(i.disableSaveButton(),i.formQueryAll(l.statuses.checkedCheckBoxes).forEach(e=>{var e=e.closest(l.actions.corerowid),t=e.getAttribute("data-key"),s=i.formQuery(l.sourcetexts.singlelangkeys,t,e),a=i.findEditor(t);r.initTempForKey(t,a,s.getAttribute("data-sourcetext-raw"),s.getAttribute("data-filedtext-raw"),i.formQuery(l.sourcetexts.sourcelangdd,t,e).value),o.push(t)}),a.COOKIE_PREFIX_NEW+n.currentlang+n.targetlang+n.courseid);a.setEncodedCookie(s,JSON.stringify(e),n.cookieduration),r.callTranslations(o,n,t)},E=e=>{i.disableTranslateButton(),A(),i.deeplErrorModal(e)},A=()=>{i.disableTranslateButton(),i.enableSaveButton(),i.hideModal()},_=e=>{i.setIconStatus(e,l.process.tosave,!0)},w=(e,t)=>{s.warn("ui/errorMessageItem"),s.warn(e),s.warn(t),i.formQuery(l.editors.multiples.editorsWithKey,e).classList.add("local_deepler__error"),i.setIconStatus(e,l.process.failed),i.showErrorMessageForEditor(e,t)};let v=(e,t)=>{i.toggleStatus(e,t),i.countWordAndChar(),i.toggleAutotranslateButton()},y=(e,t)=>{i.hideModal(),i.dbErrorModal(e,t)},L=e=>{i.hideModal(),0<e.length&&i.dbErrorPartialModal(e.length)},m=(e,t)=>{null===t?s.error(`KEY ${t} BAD FORMAT should be TABLE-ID-FIELD-CMID`):(t=i.formQuery(l.sourcetexts.singlelang,"",e),e=i.formQuery(l.sourcetexts.multilangs,",",e),t.classList.toggle("show"),e.classList.toggle("show"))},f=e=>{s.info("onGlossaryDbAllfailed"),s.error(e)},T=e=>{s.info("onGlossaryDbfailed"),s.error(e)},b=e=>{s.info("onGlossaryDbSuccess"),s.info(e)},I=(t,e)=>{i.formQuery(l.editors.multiples.editorsWithKey,t).classList.add("local_deepler__success"),i.setIconStatus(t,l.process.success,r.translated(t)),i.formQuery(l.editors.multiples.textAreas,t).innerHTML=e,i.formQuery(l.editors.multiples.checkBoxesWithKey,t).checked=!1,setTimeout(()=>{var e=i.formQuery(l.statuses.multilang,t);i.formQuery(l.statuses.prevTransStatus,t).classList="badge badge-pill badge-success",e.classList.contains("disabled")&&e.classList.remove("disabled"),i.setIconStatus(t,l.process.saved,r.translated(t))})},D=()=>{var e=i.formQueryAll(l.statuses.checkedCheckBoxes);if(0!==e.length){i.disableSaveButton(),i.launchSaveAllModal();let t=[];e.forEach(e=>{e=e.closest(l.actions.corerowid);i.hideErrorMessageForRow(e),t.push(i.prepareRowForDB(e,n.courseid))}),r.saveTranslations(t,u)}},B=e=>{i.hideErrorMessageForRow(e);e=i.prepareRowForDB(e,n.courseid);r.saveTranslations([e],u)};return{init:e=>{n=e,u="textarea"===n.userPrefs,document.addEventListener("change",S),document.addEventListener("click",h),document.addEventListener("focusin",g),t.on(r.ON_ITEM_TRANSLATED,_),t.on(r.ON_TRANSLATION_FAILED,E),t.on(r.ON_TRANSLATION_DONE,A),t.on(r.ON_REPHRASE_FAILED,E),t.on(r.ON_DB_SAVE_SUCCESS,L),t.on(r.ON_DB_FAILED,y),t.on(r.ON_ITEM_SAVED,I),t.on(r.ON_ITEM_NOT_SAVED,w),t.on(o.GLOSSARY_DB_ALL_FAILED,f),t.on(o.GLOSSARY_DB_FAILED,T),t.on(o.GLOSSARY_DB_SUCCESS,b),t.on(o.GLOSSARY_ENTRIES_SUCCESS,i.showEntriesModal),t.on(o.GLOSSARY_ENTRIES_FAILED,e=>s.error(e))}}});