/**
 *  description here.
 *
 * @module     'local_deepler'; // Full name of the plugin (used for diagnostics)./local/eventHandlers
 * @copyright  2025 Bruno Baudry <bruno.baudry@bfh.ch>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_deepler/local/eventHandlers",["core/log","./utils","./translation","./api","./customevents","./selectors","./uiHelpers","./settings"],((Log,Utils,Translation,Api,Events,Selectors,UI,Settings)=>{let filterTimeout,config={};const handleFocusEvent=e=>{e.target.closest(Selectors.editors.targetarea)&&UI.wrapTinyOnTarget(e.target)},handleClickEvent=e=>{e.target.closest(Selectors.actions.toggleMultilang)&&onToggleMultilang(e.target.closest(Selectors.actions.toggleMultilang)),e.target.closest(Selectors.actions.autoTranslateBtn)&&callDeeplServices(),e.target.closest(Selectors.actions.selectAllBtn)&&UI.toggleAllCheckboxes(e.target.checked),e.target.closest(Selectors.actions.tothetop)&&UI.backToBase(),e.target.closest(Selectors.actions.checkBoxes)&&UI.toggleAutotranslateButton(),e.target.closest(Selectors.actions.saveAll)&&saveTranslations(),e.target.closest(Selectors.actions.validatorsBtns)&&saveSingleTranslation(e),e.target.closest(Selectors.glossary.entriesviewerPage)&&(Log.info("CLICK"),Log.info(Settings.getValue(Selectors.deepl.glossaryId)),Api.getGlossariesEntries(Settings.getValue(Selectors.deepl.glossaryId),config.deeplsourcelang,config.targetlang))},callDeeplServices=()=>{UI.launchTranslatingModal();const keys=[],[cookie,settings]=Settings.prepareSettingsAndCookieValues();UI.saveAllBtn.disabled=!1,Utils.domQueryAll(Selectors.statuses.checkedCheckBoxes).forEach((ckBox=>{const key=ckBox.getAttribute("data-key"),sourceText=Utils.domQuery(Selectors.sourcetexts.keys,key),editor=UI.findEditor(key);Translation.initTempForKey(key,editor,sourceText.getAttribute("data-sourcetext-raw"),sourceText.getAttribute("data-filedtext-raw"),Utils.domQuery(Selectors.sourcetexts.sourcelangdd,key).value),keys.push(key)}));const newCookiename=Utils.COOKIE_PREFIX_NEW+config.currentlang+config.targetlang+config.courseid;Utils.setEncodedCookie(newCookiename,JSON.stringify(cookie),config.cookieduration),Translation.callTranslations(keys,config,settings)},handleChangeEvent=e=>{e.target.closest(Selectors.actions.hideiframes)&&UI.doHideiframes(),e.target.closest(Selectors.actions.targetSwitcher)&&Utils.switchLocation({key:"target_lang",value:e.target.value.replace(config.rephrasesymbol,"")}),e.target.closest(Selectors.actions.sectionSwitcher)&&Utils.switchLocation({key:"section_id",value:e.target.value},"activity_id"),e.target.closest(Selectors.actions.moduleSwitcher)&&Utils.switchLocation({key:"activity_id",value:e.target.value}),e.target.closest(Selectors.actions.sourceSwitcher)&&Utils.switchLocation({key:"lang",value:e.target.value}),e.target.closest(Selectors.actions.checkBoxes)&&onItemChecked(e),e.target.closest(Selectors.actions.sourceselect)&&onSourceChange(e),e.target.closest(Selectors.deepl.glossaryId)&&UI.toggleGlossaryDetails(Settings.getValue(Selectors.deepl.glossaryId)),clearTimeout(filterTimeout),filterTimeout=setTimeout((()=>{e.target.closest(Selectors.actions.showUpdated)&&UI.debouncedShowRows(),e.target.closest(Selectors.actions.showNeedUpdate)&&UI.debouncedShowRows(),e.target.closest(Selectors.actions.showHidden)&&UI.debouncedShowRows()}),30)},onIconStatusChanged=key=>{Translation.initTemp(key)},onTranslationFailed=error=>{onTranslationDone(),UI.deeplErrorModal(error)},onTranslationDone=()=>{UI.hideModal()},onItemTranslated=key=>{UI.setIconStatus(key,Selectors.statuses.tosave,!0)},onErrorMessageItem=(key,error)=>{Log.warn("ui/errorMessageItem"),Log.warn(key),Log.warn(error);Utils.domQuery(Selectors.editors.multiples.editorsWithKey,key).classList.add("local_deepler__error"),UI.setIconStatus(key,Selectors.statuses.failed),UI.showErrorMessageForEditor(key,error)},onSourceChange=e=>{Log.info("source changed"),Log.info(e.target.getAttribute("data-key"))},onItemChecked=e=>{if("local_deepler/checkbox"===e.target.getAttribute("data-action")){const key=e.target.getAttribute("data-key");UI.toggleStatus(key,e.target.checked,Translation.translated(key)),UI.countWordAndChar()}},onDBFailed=(error,status)=>{UI.hideModal(),UI.dbErrorModal(error,status)},onDbSavedSuccess=errors=>{UI.saveAllBtn.disabled=!1,UI.hideModal(),errors.length>0&&UI.dbErrorPartialModal(errors.length)},onToggleMultilang=e=>{let keyid=e.getAttribute("aria-controls"),key=Utils.keyidToKey(keyid);if(null===key)Log.error("KEY ".concat(keyid," BAD FORMAT should be TABLE-ID-FIELD-CMID"));else{let source=Utils.domQuery(Selectors.sourcetexts.keys,key),multilang=Utils.domQuery(Selectors.sourcetexts.multilangs,keyid);source.classList.toggle("show"),multilang.classList.toggle("show")}},onGlossaryDbAllfailed=obj=>{Log.info("onGlossaryDbAllfailed"),Log.error(obj)},onGlossaryDbfailed=obj=>{Log.info("onGlossaryDbfailed"),Log.error(obj)},onGlossaryDbSuccess=obj=>{Log.info("onGlossaryDbSuccess"),Log.info(obj)},onSuccessMessageItem=(key,savedText)=>{Utils.domQuery(Selectors.editors.multiples.editorsWithKey,key).classList.add("local_deepler__success"),UI.setIconStatus(key,Selectors.statuses.success,Translation.translated(key));Utils.domQuery(Selectors.editors.multiples.textAreas,key).innerHTML=savedText,Utils.domQuery(Selectors.editors.multiples.checkBoxesWithKey,key).checked=!1,setTimeout((()=>{let multilangPill=Utils.domQuery(Selectors.statuses.multilang,key);Utils.domQuery(Selectors.statuses.prevTransStatus,key).classList="badge badge-pill badge-success",multilangPill.classList.contains("disabled")&&multilangPill.classList.remove("disabled"),UI.setIconStatus(key,Selectors.statuses.saved,Translation.translated(key))}))},saveTranslations=()=>{const selectedCheckboxes=Utils.domQueryAll(Selectors.statuses.checkedCheckBoxes);if(0===selectedCheckboxes.length)return;UI.saveAllBtn.disabled=!0,UI.launchSaveAllModal();const data=[];Array.from(selectedCheckboxes).map((e=>e.dataset.key)).forEach((key=>{if(UI.getIconStatus(key)===Selectors.statuses.tosave){UI.hideErrorMessage(key);const dbItem=Utils.prepareDBitem(key,Selectors.editors.multiples.editorsWithKey,config.courseid);data.push(dbItem)}})),Translation.saveTranslations(data,"textarea"===config.userPrefs)},saveSingleTranslation=e=>{const key=e.target.closest(Selectors.actions.validatorsBtns).dataset.keyValidator;if(UI.getIconStatus(key)===Selectors.statuses.tosave){UI.hideErrorMessage(key);const dbItem=Utils.prepareDBitem(key,Selectors.editors.multiples.editorsWithKey,config.courseid);Translation.saveTranslations([dbItem],"textarea"===config.userPrefs)}};return{init:cfg=>{config=cfg,document.addEventListener("change",handleChangeEvent),document.addEventListener("click",handleClickEvent),document.addEventListener("focusin",handleFocusEvent),Events.on(Translation.ON_ITEM_TRANSLATED,onItemTranslated),Events.on(Translation.ON_TRANSLATION_FAILED,onTranslationFailed),Events.on(Translation.ON_TRANSLATION_DONE,onTranslationDone),Events.on(Translation.ON_REPHRASE_FAILED,onTranslationFailed),Events.on(Translation.ON_DB_SAVE_SUCCESS,onDbSavedSuccess),Events.on(Translation.ON_DB_FAILED,onDBFailed),Events.on(Translation.ON_ITEM_SAVED,onSuccessMessageItem),Events.on(Translation.ON_ITEM_NOT_SAVED,onErrorMessageItem),Events.on(UI.ON_STATUS_CHANGED,onIconStatusChanged),Events.on(Api.GLOSSARY_DB_ALL_FAILED,onGlossaryDbAllfailed),Events.on(Api.GLOSSARY_DB_FAILED,onGlossaryDbfailed),Events.on(Api.GLOSSARY_DB_SUCCESS,onGlossaryDbSuccess),Events.on(Api.GLOSSARY_ENTRIES_SUCCESS,UI.showEntriesModal),Events.on(Api.GLOSSARY_ENTRIES_FAILED,(e=>Log.error(e)))}}}));

//# sourceMappingURL=eventHandlers.min.js.map