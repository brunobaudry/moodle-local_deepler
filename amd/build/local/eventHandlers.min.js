/**
 *  description here.
 *
 * @module     'local_deepler'; // Full name of the plugin (used for diagnostics)./local/eventHandlers
 * @copyright  2025 Bruno Baudry <bruno.baudry@bfh.ch>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_deepler/local/eventHandlers",["core/log","./utils","./translation","./api","./customevents","./selectors","./uiHelpers","./settings"],((Log,Utils,Translation,Api,Events,Selectors,UI,Settings)=>{let filterTimeout,mainEditorIsTextArea,config={};const handleFocusEvent=e=>{e.target.closest(Selectors.editors.targetarea)&&UI.wrapTinyOnTarget(e.target)},handleClickEvent=e=>{e.target.closest(Selectors.actions.autoTranslateBtn)&&callDeeplServices(),e.target.closest(Selectors.actions.selectAllBtn)&&(UI.toggleAllCheckboxes(e.target.checked),Translation.updatTempStatusAll(e.target.checked?Selectors.process.totranslate:Selectors.process.wait)),e.target.closest(Selectors.actions.tothetop)&&UI.backToBase(),e.target.closest(Selectors.glossary.entriesviewerPage)&&(Log.info("CLICK"),Log.info(Settings.getValue(Selectors.deepl.glossaryId)),Api.getGlossariesEntries(Settings.getValue(Selectors.deepl.glossaryId),config.deeplsourcelang,config.targetlang));const rowContainer=e.target.closest("[data-row-id]");if(rowContainer&&(e.target.closest(Selectors.actions.toggleMultilang)&&onToggleMultilang(rowContainer),e.target.closest(Selectors.actions.validatorsBtns))){if(rowContainer.getAttribute("data-process")===Selectors.process.tosave)saveSingleTranslation(rowContainer)}e.target.closest(Selectors.actions.saveAll)&&saveTranslations()},handleChangeEvent=e=>{e.target.closest(Selectors.actions.escapeLatex),e.target.closest(Selectors.actions.escapePre),e.target.closest(Selectors.actions.hideiframes)&&UI.doHideiframes(),e.target.closest(Selectors.actions.targetSwitcher)&&Utils.switchLocation({key:"target_lang",value:e.target.value.replace(config.rephrasesymbol,"")}),e.target.closest(Selectors.deepl.glossaryId)&&UI.toggleGlossaryDetails(Settings.getValue(Selectors.deepl.glossaryId)),clearTimeout(filterTimeout),filterTimeout=setTimeout((()=>{e.target.closest(Selectors.actions.showUpdated)&&UI.debouncedShowRows(),e.target.closest(Selectors.actions.showNeedUpdate)&&UI.debouncedShowRows(),e.target.closest(Selectors.actions.showHidden)&&UI.debouncedShowRows()}),30),e.target.closest(Selectors.actions.sectionSwitcher)&&Utils.switchLocation({key:"section_id",value:e.target.value},"activity_id"),e.target.closest(Selectors.actions.moduleSwitcher)&&Utils.switchLocation({key:"activity_id",value:e.target.value});const rowContainer=e.target.closest("[data-row-id]");if(rowContainer){const key=rowContainer.getAttribute("data-row-id");switch(e.target.getAttribute("data-action")){case Selectors.actions.checkBoxes:onItemChecked(rowContainer,e.target.checked);break;case Selectors.actions.sourceselect:Translation.updateTempSourceLang(key,e.target.value)}}},callDeeplServices=()=>{UI.launchTranslatingModal();const keys=[],[cookie,settings]=Settings.prepareSettingsAndCookieValues();UI.disableSaveButton(),UI.formQueryAll(Selectors.statuses.checkedCheckBoxes).forEach((ckBox=>{const row=ckBox.closest(Selectors.actions.corerowid),key=row.getAttribute("data-key"),sourceText=UI.formQuery(Selectors.sourcetexts.singlelangkeys,key,row),editor=UI.findEditor(key);Translation.initTempForKey(key,editor,sourceText.getAttribute("data-sourcetext-raw"),sourceText.getAttribute("data-filedtext-raw"),UI.formQuery(Selectors.sourcetexts.sourcelangdd,key,row).value),keys.push(key)}));const newCookiename=Utils.COOKIE_PREFIX_NEW+config.currentlang+config.targetlang+config.courseid;Utils.setEncodedCookie(newCookiename,JSON.stringify(cookie),config.cookieduration),Translation.callTranslations(keys,config,settings)},onTranslationFailed=error=>{UI.disableTranslateButton(),onTranslationDone(),UI.deeplErrorModal(error)},onTranslationDone=()=>{UI.disableTranslateButton(),UI.enableSaveButton(),UI.hideModal()},onItemTranslated=key=>{UI.setIconStatus(key,Selectors.process.tosave,!0)},onErrorMessageItem=(key,error)=>{Log.warn("ui/errorMessageItem"),Log.warn(key),Log.warn(error);UI.formQuery(Selectors.editors.multiples.editorsWithKey,key).classList.add("local_deepler__error"),UI.setIconStatus(key,Selectors.process.failed),UI.showErrorMessageForEditor(key,error)},onItemChecked=(row,checked)=>{UI.toggleStatus(row,checked),UI.countWordAndChar(),UI.toggleAutotranslateButton()},onDBFailed=(error,status)=>{UI.hideModal(),UI.dbErrorModal(error,status)},onDbSavedSuccess=errors=>{UI.hideModal(),errors.length>0&&UI.dbErrorPartialModal(errors.length)},onToggleMultilang=(row,key)=>{if(null===key)Log.error("KEY ".concat(key," BAD FORMAT should be TABLE-ID-FIELD-CMID"));else{let sourceText=UI.formQuery(Selectors.sourcetexts.singlelang,"",row),multilangText=UI.formQuery(Selectors.sourcetexts.multilangs,",",row);sourceText.classList.toggle("show"),multilangText.classList.toggle("show")}},onGlossaryDbAllfailed=obj=>{Log.info("onGlossaryDbAllfailed"),Log.error(obj)},onGlossaryDbfailed=obj=>{Log.info("onGlossaryDbfailed"),Log.error(obj)},onGlossaryDbSuccess=obj=>{Log.info("onGlossaryDbSuccess"),Log.info(obj)},onSuccessMessageItem=(key,savedText)=>{UI.formQuery(Selectors.editors.multiples.editorsWithKey,key).classList.add("local_deepler__success"),UI.setIconStatus(key,Selectors.process.success,Translation.translated(key));UI.formQuery(Selectors.editors.multiples.textAreas,key).innerHTML=savedText,UI.formQuery(Selectors.editors.multiples.checkBoxesWithKey,key).checked=!1,setTimeout((()=>{let multilangPill=UI.formQuery(Selectors.statuses.multilang,key);UI.formQuery(Selectors.statuses.prevTransStatus,key).classList="badge badge-pill badge-success",multilangPill.classList.contains("disabled")&&multilangPill.classList.remove("disabled"),UI.setIconStatus(key,Selectors.process.saved,Translation.translated(key))}))},saveTranslations=()=>{const selectedCheckboxes=UI.formQueryAll(Selectors.statuses.checkedCheckBoxes);if(0===selectedCheckboxes.length)return;UI.disableSaveButton(),UI.launchSaveAllModal();const data=[];selectedCheckboxes.forEach((ck=>{const row=ck.closest(Selectors.actions.corerowid);UI.hideErrorMessageForRow(row),data.push(UI.prepareRowForDB(row,config.courseid))})),Translation.saveTranslations(data,mainEditorIsTextArea)},saveSingleTranslation=row=>{UI.hideErrorMessageForRow(row);const dbItem=UI.prepareRowForDB(row,config.courseid);Translation.saveTranslations([dbItem],mainEditorIsTextArea)};return{init:cfg=>{config=cfg,mainEditorIsTextArea="textarea"===config.userPrefs,document.addEventListener("change",handleChangeEvent),document.addEventListener("click",handleClickEvent),document.addEventListener("focusin",handleFocusEvent),Events.on(Translation.ON_ITEM_TRANSLATED,onItemTranslated),Events.on(Translation.ON_TRANSLATION_FAILED,onTranslationFailed),Events.on(Translation.ON_TRANSLATION_DONE,onTranslationDone),Events.on(Translation.ON_REPHRASE_FAILED,onTranslationFailed),Events.on(Translation.ON_DB_SAVE_SUCCESS,onDbSavedSuccess),Events.on(Translation.ON_DB_FAILED,onDBFailed),Events.on(Translation.ON_ITEM_SAVED,onSuccessMessageItem),Events.on(Translation.ON_ITEM_NOT_SAVED,onErrorMessageItem),Events.on(Api.GLOSSARY_DB_ALL_FAILED,onGlossaryDbAllfailed),Events.on(Api.GLOSSARY_DB_FAILED,onGlossaryDbfailed),Events.on(Api.GLOSSARY_DB_SUCCESS,onGlossaryDbSuccess),Events.on(Api.GLOSSARY_ENTRIES_SUCCESS,UI.showEntriesModal),Events.on(Api.GLOSSARY_ENTRIES_FAILED,(e=>Log.error(e)))}}}));

//# sourceMappingURL=eventHandlers.min.js.map