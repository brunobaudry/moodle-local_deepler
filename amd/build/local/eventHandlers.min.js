define(["core/log","./utils","./translation","./api","./customevents","./selectors","./uiHelpers","./settings"],(s,a,r,o,t,l,i,c)=>{let n={},d,u,g=e=>{e.target.closest(l.editors.targetarea)&&i.wrapTinyOnTarget(e.target)},h=e=>{e.target.closest(l.actions.autoTranslateBtn)&&p(),e.target.closest(l.actions.selectAllBtn)&&(i.toggleAllCheckboxes(e.target.checked),r.updatTempStatusAll(e.target.checked?l.process.totranslate:l.process.wait)),e.target.closest(l.actions.tothetop)&&i.backToBase(),e.target.closest(l.glossary.entriesviewerPage)&&(s.info("CLICK"),s.info(c.getValue(l.deepl.glossaryId)),o.getGlossariesEntries(c.getValue(l.deepl.glossaryId),n.deeplsourcelang,n.targetlang));var t=e.target.closest("[data-row-id]");t&&(e.target.closest(l.actions.toggleMultilang)&&m(t),e.target.closest(l.actions.validatorsBtns))&&t.getAttribute("data-process")===l.process.tosave&&B(t),e.target.closest(l.actions.saveAll)&&D()},S=e=>{e.target.closest(l.actions.escapeLatex),e.target.closest(l.actions.escapePre),e.target.closest(l.actions.hideiframes)&&i.doHideiframes(),e.target.closest(l.actions.targetSwitcher)&&a.switchLocation({key:"target_lang",value:e.target.value.replace(n.rephrasesymbol,"")}),e.target.closest(l.deepl.glossaryId)&&i.toggleGlossaryDetails(c.getValue(l.deepl.glossaryId)),clearTimeout(d),d=setTimeout(()=>{e.target.closest(l.actions.showUpdated)&&i.debouncedShowRows(),e.target.closest(l.actions.showNeedUpdate)&&i.debouncedShowRows(),e.target.closest(l.actions.showHidden)&&i.debouncedShowRows()},30),e.target.closest(l.actions.sectionSwitcher)&&a.switchLocation({key:"section_id",value:e.target.value},"activity_id"),e.target.closest(l.actions.moduleSwitcher)&&a.switchLocation({key:"activity_id",value:e.target.value});var t=e.target.closest("[data-row-id]");if(t){var s=t.getAttribute("data-row-id");switch(e.target.getAttribute("data-action")){case l.actions.checkBoxes:y(t,e.target.checked);break;case l.actions.sourceselect:r.updateTempSourceLang(s,e.target.value)}}},p=()=>{i.launchTranslatingModal();let o=[];var[e,t]=c.prepareSettingsAndCookieValues(),s=(i.disableSaveButton(),i.formQueryAll(l.statuses.checkedCheckBoxes).forEach(e=>{var e=e.closest(l.actions.corerowid),t=e.getAttribute("data-key"),s=i.formQuery(l.sourcetexts.singlelangkeys,t,e),a=i.findEditor(t);r.initTempForKey(t,a,s.getAttribute("data-sourcetext-raw"),s.getAttribute("data-filedtext-raw"),i.formQuery(l.sourcetexts.sourcelangdd,t,e).value),o.push(t)}),a.COOKIE_PREFIX_NEW+n.currentlang+n.targetlang+n.courseid);a.setEncodedCookie(s,JSON.stringify(e),n.cookieduration),r.callTranslations(o,n,t)},E=e=>{i.disableTranslateButton(),A(),i.deeplErrorModal(e)},A=()=>{i.disableTranslateButton(),i.enableSaveButton(),i.hideModal()},_=e=>{i.setIconStatus(e,l.process.tosave,!0)},w=(e,t)=>{s.warn("ui/errorMessageItem"),s.warn(e),s.warn(t),i.formQuery(l.editors.multiples.editorsWithKey,e).classList.add("local_deepler__error"),i.setIconStatus(e,l.process.failed),i.showErrorMessageForEditor(e,t)};let y=(e,t)=>{i.toggleStatus(e,t),i.countWordAndChar(),i.toggleAutotranslateButton()},L=(e,t)=>{i.hideModal(),i.dbErrorModal(e,t)},v=e=>{i.hideModal(),0<e.length&&i.dbErrorPartialModal(e.length)},m=(e,t)=>{null===t?s.error(`KEY ${t} BAD FORMAT should be TABLE-ID-FIELD-CMID`):(t=i.formQuery(l.sourcetexts.singlelang,"",e),e=i.formQuery(l.sourcetexts.multilangs,",",e),t.classList.toggle("show"),e.classList.toggle("show"))},f=e=>{s.info("onGlossaryDbAllfailed"),s.error(e)},T=e=>{s.info("onGlossaryDbfailed"),s.error(e)},b=e=>{s.info("onGlossaryDbSuccess"),s.info(e)},I=(t,e)=>{i.formQuery(l.editors.multiples.editorsWithKey,t).classList.add("local_deepler__success"),i.setIconStatus(t,l.process.success,r.translated(t)),i.formQuery(l.editors.multiples.textAreas,t).innerHTML=e,i.formQuery(l.editors.multiples.checkBoxesWithKey,t).checked=!1,setTimeout(()=>{var e=i.formQuery(l.statuses.multilang,t);i.formQuery(l.statuses.prevTransStatus,t).classList="badge badge-pill badge-success",e.classList.contains("disabled")&&e.classList.remove("disabled"),i.setIconStatus(t,l.process.saved,r.translated(t))})},D=()=>{var e=i.formQueryAll(l.statuses.checkedCheckBoxes);if(0!==e.length){i.disableSaveButton(),i.launchSaveAllModal();let t=[];e.forEach(e=>{e=e.closest(l.actions.corerowid);i.hideErrorMessageForRow(e),t.push(i.prepareRowForDB(e,n.courseid))}),r.saveTranslations(t,u)}},B=e=>{i.hideErrorMessageForRow(e);e=i.prepareRowForDB(e,n.courseid);r.saveTranslations([e],u)};return{init:e=>{n=e,u="textarea"===n.userPrefs,document.addEventListener("change",S),document.addEventListener("click",h),document.addEventListener("focusin",g),t.on(r.ON_ITEM_TRANSLATED,_),t.on(r.ON_TRANSLATION_FAILED,E),t.on(r.ON_TRANSLATION_DONE,A),t.on(r.ON_REPHRASE_FAILED,E),t.on(r.ON_DB_SAVE_SUCCESS,v),t.on(r.ON_DB_FAILED,L),t.on(r.ON_ITEM_SAVED,I),t.on(r.ON_ITEM_NOT_SAVED,w),t.on(o.GLOSSARY_DB_ALL_FAILED,f),t.on(o.GLOSSARY_DB_FAILED,T),t.on(o.GLOSSARY_DB_SUCCESS,b),t.on(o.GLOSSARY_ENTRIES_SUCCESS,i.showEntriesModal),t.on(o.GLOSSARY_ENTRIES_FAILED,e=>s.error(e))}}}),define(["core/log","./utils","./translation","./api","./customevents","./selectors","./uiHelpers","./settings"],(o,r,l,i,t,c,n,d)=>{let u={},g,h,s=e=>{e.target.closest(c.editors.targetarea)&&n.wrapTinyOnTarget(e.target)},a=e=>{e.target.closest(c.actions.autoTranslateBtn)&&(()=>{n.launchTranslatingModal();let o=[],[e,t]=d.prepareSettingsAndCookieValues(),s=(n.disableSaveButton(),n.formQueryAll(c.statuses.checkedCheckBoxes).forEach(e=>{var e=e.closest(c.actions.corerowid),t=e.getAttribute("data-key"),s=n.formQuery(c.sourcetexts.singlelangkeys,t,e),a=n.findEditor(t);l.initTempForKey(t,a,s.getAttribute("data-sourcetext-raw"),s.getAttribute("data-filedtext-raw"),n.formQuery(c.sourcetexts.sourcelangdd,t,e).value),o.push(t)}),r.COOKIE_PREFIX_NEW+u.currentlang+u.targetlang+u.courseid);r.setEncodedCookie(s,JSON.stringify(e),u.cookieduration),l.callTranslations(o,u,t)})(),e.target.closest(c.actions.selectAllBtn)&&(n.toggleAllCheckboxes(e.target.checked),l.updatTempStatusAll(e.target.checked?c.process.totranslate:c.process.wait)),e.target.closest(c.actions.tothetop)&&n.backToBase(),e.target.closest(c.glossary.entriesviewerPage)&&(o.info("CLICK"),o.info(d.getValue(c.deepl.glossaryId)),i.getGlossariesEntries(d.getValue(c.deepl.glossaryId),u.deeplsourcelang,u.targetlang));var t,s,a=e.target.closest("[data-row-id]");a&&(e.target.closest(c.actions.toggleMultilang)&&(t=a,null===s?o.error(`KEY ${s} BAD FORMAT should be TABLE-ID-FIELD-CMID`):(s=n.formQuery(c.sourcetexts.singlelang,"",t),t=n.formQuery(c.sourcetexts.multilangs,",",t),s.classList.toggle("show"),t.classList.toggle("show"))),e.target.closest(c.actions.validatorsBtns))&&a.getAttribute("data-process")===c.process.tosave&&(s=a,n.hideErrorMessageForRow(s),s=n.prepareRowForDB(s,u.courseid),l.saveTranslations([s],h)),e.target.closest(c.actions.saveAll)&&(()=>{var e=n.formQueryAll(c.statuses.checkedCheckBoxes);if(0!==e.length){n.disableSaveButton(),n.launchSaveAllModal();let t=[];e.forEach(e=>{e=e.closest(c.actions.corerowid);n.hideErrorMessageForRow(e),t.push(n.prepareRowForDB(e,u.courseid))}),l.saveTranslations(t,h)}})()},S=e=>{e.target.closest(c.actions.escapeLatex),e.target.closest(c.actions.escapePre),e.target.closest(c.actions.hideiframes)&&n.doHideiframes(),e.target.closest(c.actions.targetSwitcher)&&r.switchLocation({key:"target_lang",value:e.target.value.replace(u.rephrasesymbol,"")}),e.target.closest(c.deepl.glossaryId)&&n.toggleGlossaryDetails(d.getValue(c.deepl.glossaryId)),clearTimeout(g),g=setTimeout(()=>{e.target.closest(c.actions.showUpdated)&&n.debouncedShowRows(),e.target.closest(c.actions.showNeedUpdate)&&n.debouncedShowRows(),e.target.closest(c.actions.showHidden)&&n.debouncedShowRows()},30),e.target.closest(c.actions.sectionSwitcher)&&r.switchLocation({key:"section_id",value:e.target.value},"activity_id"),e.target.closest(c.actions.moduleSwitcher)&&r.switchLocation({key:"activity_id",value:e.target.value});var t,s=e.target.closest("[data-row-id]");if(s){var a=s.getAttribute("data-row-id");switch(e.target.getAttribute("data-action")){case c.actions.checkBoxes:t=e.target.checked,n.toggleStatus(s,t),n.countWordAndChar(),n.toggleAutotranslateButton();break;case c.actions.sourceselect:l.updateTempSourceLang(a,e.target.value)}}},p=e=>{n.disableTranslateButton(),E(),n.deeplErrorModal(e)},E=()=>{n.disableTranslateButton(),n.enableSaveButton(),n.hideModal()},A=e=>{n.setIconStatus(e,c.process.tosave,!0)},_=(e,t)=>{o.warn("ui/errorMessageItem"),o.warn(e),o.warn(t),n.formQuery(c.editors.multiples.editorsWithKey,e).classList.add("local_deepler__error"),n.setIconStatus(e,c.process.failed),n.showErrorMessageForEditor(e,t)},w=(e,t)=>{n.hideModal(),n.dbErrorModal(e,t)},y=e=>{n.hideModal(),0<e.length&&n.dbErrorPartialModal(e.length)},L=e=>{o.info("onGlossaryDbAllfailed"),o.error(e)},v=e=>{o.info("onGlossaryDbfailed"),o.error(e)},m=e=>{o.info("onGlossaryDbSuccess"),o.info(e)},f=(t,e)=>{n.formQuery(c.editors.multiples.editorsWithKey,t).classList.add("local_deepler__success"),n.setIconStatus(t,c.process.success,l.translated(t)),n.formQuery(c.editors.multiples.textAreas,t).innerHTML=e,n.formQuery(c.editors.multiples.checkBoxesWithKey,t).checked=!1,setTimeout(()=>{var e=n.formQuery(c.statuses.multilang,t);n.formQuery(c.statuses.prevTransStatus,t).classList="badge badge-pill badge-success",e.classList.contains("disabled")&&e.classList.remove("disabled"),n.setIconStatus(t,c.process.saved,l.translated(t))})};return{init:e=>{u=e,h="textarea"===u.userPrefs,document.addEventListener("change",S),document.addEventListener("click",a),document.addEventListener("focusin",s),t.on(l.ON_ITEM_TRANSLATED,A),t.on(l.ON_TRANSLATION_FAILED,p),t.on(l.ON_TRANSLATION_DONE,E),t.on(l.ON_REPHRASE_FAILED,p),t.on(l.ON_DB_SAVE_SUCCESS,y),t.on(l.ON_DB_FAILED,w),t.on(l.ON_ITEM_SAVED,f),t.on(l.ON_ITEM_NOT_SAVED,_),t.on(i.GLOSSARY_DB_ALL_FAILED,L),t.on(i.GLOSSARY_DB_FAILED,v),t.on(i.GLOSSARY_DB_SUCCESS,m),t.on(i.GLOSSARY_ENTRIES_SUCCESS,n.showEntriesModal),t.on(i.GLOSSARY_ENTRIES_FAILED,e=>o.error(e))}}});