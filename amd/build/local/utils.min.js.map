{"version":3,"file":"utils.min.js","sources":["../../src/local/utils.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module     local_deepler/deepler\n * @file       amd/src/local/utils.js\n * @copyright  2025 Bruno Baudry <bruno.baudry@bfh.ch>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([], () => {\n    const COOKIE_PREFIX = 'moodle_deepler_glossary_';\n    const COOKIE_PREFIX_NEW = 'moodle_deepler_settings_';\n    const MAX_INPUT_LENGTH = 256;\n    const parser = new DOMParser();\n    /**\n     * Shortcut for dom querySelector.\n     *\n     * @param {string} selector\n     * @param {string} key\n     * @param {element} target\n     * @returns {element}\n     */\n    const domQuery = (selector, key = '', target = null) => {\n        const el = target ?? document;\n        const q = key === '' ? selector : selector.replace(\"<KEY>\", key);\n        return el.querySelector(q);\n    };\n\n    /**\n     * Shortcut for dom querySelector.\n     *\n     * @param {string} selector\n     * @param {string} key\n     * @param {element} target\n     * @returns {NodeList}\n     */\n    const domQueryAll = (selector, key = '', target = null) => {\n        const el = target ?? document;\n        const q = key === '' ? selector : selector.replace(\"<KEY>\", key);\n        return el.querySelectorAll(q);\n    };\n    /**\n     * Fetch the parent row of the translation.\n     * @param {Node} node\n     * @param {string} selector\n     * @returns {*}\n     */\n    const getParentRow = (node, selector) => {\n        return node.closest(replaceKey(selector, node.getAttribute('data-key')));\n    };\n    /**\n     * Debounce for performance\n     *\n     * @param {function} fn\n     * @param {int} delay\n     * @returns {(function(...[*]): void)|*}\n     */\n    const debounce = (fn, delay) => {\n        let timer;\n        return (...args) => {\n            clearTimeout(timer);\n            timer = setTimeout(() => fn(...args), delay);\n        };\n    };\n    /**\n     * Simple helper to manage selectors\n     * @param {string} s\n     * @param {string} k\n     * @returns {*}\n     */\n    const replaceKey = (s, k) => {\n        return s.replace(\"<KEY>\", k);\n    };\n    /**\n     * Transforms a keyid to a key.\n     *\n     * @param {string} k\n     * @returns {string|null}\n     */\n    const keyidToKey = (k) => {\n        if (typeof k !== 'string' || k.length > MAX_INPUT_LENGTH) {\n            return null;\n        }\n        let m = k.match(/^([^-]+)-([^-]+)-([^-]+)-([^-]+)$/i);\n        if (!m) {\n            return null;\n        }\n        return `${m[1]}[${m[2]}][${m[3]}][${m[4]}]`;\n    };\n\n    /**\n     * Json helper\n     * @param {string} s\n     * @param {string} sep\n     * @returns {string}\n     */\n    const toJsonArray = (s, sep = \",\") => {\n        return JSON.stringify(s.split(sep));\n    };\n    /**\n     * Helper function to decode the PHP base64 encoded source.\n     *\n     * @param {string} encoded\n     * @returns {string}\n     */\n    const fromBase64 = (encoded) => {\n        const binString = atob(encoded); // Maybe we should import js-base64 instead.\n        const bytes = Uint8Array.from(binString, (m) => m.codePointAt(0));\n        return new TextDecoder().decode(bytes);\n    };\n    /**\n     * Helper function for the decode html escaped content.\n     *\n     * @param {string} encodedStr\n     * @returns {string}\n     */\n    const decodeHTML = (encodedStr) => {\n\n        const doc = parser.parseFromString(encodedStr, 'text/html');\n        return doc.documentElement.textContent;\n    };\n    /**\n     * Helper to remove HTML from strings.\n     *\n     * @param {string} str\n     * @returns {string|string}\n     * utils.js\n     */\n    const stripHTMLTags = (str) => {\n        let doc = new DOMParser().parseFromString(str, 'text/html');\n        return doc.body.textContent || \"\";\n    };\n    /**\n     * Helps to create a cookie name based on the config.\n     *\n     * @param {object} config\n     * @param {bool} oldWay\n     */\n    const makeCookieName = (config, oldWay = false) =>{\n        if (oldWay) {\n            return COOKIE_PREFIX + config.currentlang + config.targetlang + config.courseid;\n        }\n        return COOKIE_PREFIX_NEW + config.currentlang + config.targetlang + config.courseid;\n    };\n    /**\n     * Cookie setter.\n     *\n     * @param {object} config\n     * @param {string} value\n     * @param {int} hours\n     */\n    const setCookie = (config, value, hours)=>{\n        let expires = \"\";\n        if (hours) {\n            const date = new Date();\n            date.setTime(date.getTime() + (hours * 60 * 60 * 1000));\n            expires = \"; expires=\" + date.toUTCString();\n        }\n        document.cookie = makeCookieName(config, true) + \"=\" + (value || \"\") + expires + \"; path=/\";\n    };\n\n    /**\n     * Cookie Getter.\n     *\n     * @param {object} config\n     * @returns {object}\n     */\n    const getCookie = (config) => {\n        const nameEQ = makeCookieName(config, true) + \"=\";\n        const ca = document.cookie.split(';');\n        for (let i = 0; i < ca.length; i++) {\n            let c = ca[i];\n            while (c.charAt(0) == ' ') {\n                // Strips leading spaces.\n                c = c.substring(1, c.length);\n            }\n            if (c.indexOf(nameEQ) == 0) {\n                return c.substring(nameEQ.length, c.length);\n            }\n        }\n        return null;\n    };\n\n    /**\n     * Wrapper for the setCookie function to encode the value in base64.\n     *\n     * @param {object} config\n     * @param {string} value\n     * @param {int} hours\n     */\n    const setEncodedCookie = (config, value, hours)=>{\n       setCookie(makeCookieName(config), btoa(value), hours);\n    };\n    /**\n     * Wrapper for the getCookie function to decode the value from base64.\n     *\n     * @param {object} config\n     * @returns {string}\n     */\n    const getEncodedCookie = (config) => {\n       const cook = getCookie(makeCookieName(config));\n       if (cook === null) {\n           return null;\n       }\n       return atob(cook);\n    };\n    /**\n     * Limit the size of a String.\n     *\n     * @param {string} str\n     * @param {int} maxLength\n     * @returns {*|string}\n     */\n    const smartTruncate = (str, maxLength) =>{\n        if (str.length <= maxLength || maxLength == 0) {\n            return str;\n        }\n\n        const ellipsis = 'â€¦';\n        const trimmed = str.slice(0, maxLength - ellipsis.length);\n\n        // Try to cut at the last space within the limit\n        const lastSpace = trimmed.lastIndexOf(' ');\n        if (lastSpace > 0) {\n            return trimmed.slice(0, lastSpace) + ellipsis;\n        }\n\n        // If no space found, just hard cut\n        return trimmed + ellipsis;\n    };\n    /**\n     *\n     * @param {string} key\n     * @param {string} selector\n     * @param {int} courseId\n     * @returns {{key, courseid, id: number, tid: *, table: *, field: *}}\n     */\n    const prepareDBitem = (key, selector, courseId) => {\n        const element = domQuery(selector, key);\n        return {\n            key: key,\n            courseid: courseId,\n            id: parseInt(element.getAttribute(\"data-id\")),\n            tid: element.getAttribute(\"data-tid\"),\n            table: element.getAttribute(\"data-table\"),\n            field: element.getAttribute(\"data-field\"),\n            cmid: element.getAttribute(\"data-cmid\"),\n        };\n    };\n    const switchLocation = (addParam, removeParam)=>{\n        let url = new URL(window.location.href);\n        let searchParams = url.searchParams;\n        // Pass the target lang in the url and refresh, not forgetting to remove the rephrase prefix indicator.\n        searchParams.set(addParam.key, addParam.value.trim());\n        if (removeParam && removeParam !== '' && searchParams.has(removeParam)) {\n            searchParams.delete(removeParam);\n        }\n        window.location = url.toString();\n    };\n    /**\n     * Api to be used by the other modules.\n     */\n    return {\n        debounce: debounce,\n        decodeHTML: decodeHTML,\n        domQuery: domQuery,\n        domQueryAll: domQueryAll,\n        getCookie: getCookie,\n        getEncodedCookie: getEncodedCookie,\n        getParentRow: getParentRow,\n        fromBase64: fromBase64,\n        keyidToKey: keyidToKey,\n        prepareDBitem: prepareDBitem,\n        replaceKey: replaceKey,\n        setCookie: setCookie,\n        setEncodedCookie: setEncodedCookie,\n        smartTruncate: smartTruncate,\n        stripHTMLTags: stripHTMLTags,\n        switchLocation: switchLocation,\n        toJsonArray: toJsonArray\n    };\n});\n"],"names":["define","parser","DOMParser","domQuery","selector","key","target","el","document","q","replace","querySelector","replaceKey","s","k","makeCookieName","config","oldWay","currentlang","targetlang","courseid","setCookie","value","hours","expires","date","Date","setTime","getTime","toUTCString","cookie","getCookie","nameEQ","ca","split","i","length","c","charAt","substring","indexOf","debounce","fn","delay","timer","args","clearTimeout","setTimeout","decodeHTML","encodedStr","parseFromString","documentElement","textContent","domQueryAll","querySelectorAll","getEncodedCookie","cook","atob","getParentRow","node","closest","getAttribute","fromBase64","encoded","binString","bytes","Uint8Array","from","m","codePointAt","TextDecoder","decode","keyidToKey","match","prepareDBitem","courseId","element","id","parseInt","tid","table","field","cmid","setEncodedCookie","btoa","smartTruncate","str","maxLength","trimmed","slice","lastSpace","lastIndexOf","stripHTMLTags","body","switchLocation","addParam","removeParam","url","URL","window","location","href","searchParams","set","trim","has","delete","toString","toJsonArray","sep","JSON","stringify"],"mappings":"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"}