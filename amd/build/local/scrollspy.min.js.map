{"version":3,"file":"scrollspy.min.js","sources":["../../src/local/scrollspy.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Port of the scrollspy script from Angelika Cathor (angelikatyborska) to AMD.\n * Utilizes the scroll event to update the breadcrumbs based on the current scroll position.\n *\n * @module     local_deepler/deepler\n * @file       amd/src/local/scrollspy.js\n * @copyright  2025 Bruno Baudry <bruno.baudry@bfh.ch>\n * @copyright  2025 Angelika Cathor <https://angelika.me>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @see https://github.com/angelikatyborska\n */\ndefine(['./utils'], (Utils) => {\n    let OFFSET_TOP;\n    let ARTICLE;\n    let CONTAINER;\n    let PARENT;\n    let END_OF_ARTICLE;\n    let HIGHEST_LEVEL;\n    let FADING_DISTANCE;\n    let OFFSET_END_OF_SCOPE;\n    let MAX_SUB_LENGTH;\n    /**\n     * Injects the breadcrumbs into the container.\n     *\n     * @param {array} headingsPerLevel\n     */\n    const makeBreadcrumbs = (headingsPerLevel)=>{\n        CONTAINER.innerHTML = getBreadcrumbs(headingsPerLevel, scrollTop());\n        if (CONTAINER.innerHTML.trim() === '') {\n            PARENT.style.display = 'none';\n        } else {\n            PARENT.style.display = 'block';\n        }\n    };\n\n    /**\n     * Returns the current scroll position.\n     */\n    const scrollTop = ()=>{\n        return window.scrollY + OFFSET_TOP;\n    };\n\n    /**\n     * Returns an array of headings per level.\n     */\n    const getHeadingsPerLevel = ()=> {\n        const headingsPerLevel = [];\n        for (let level = HIGHEST_LEVEL; level <= 6; level++) {\n            let headings = Array.prototype.slice.call(ARTICLE.querySelectorAll('span.h' + level));\n            headings = headings.sort((a, b)=> b.offsetTop - a.offsetTop);\n            headingsPerLevel.push(headings);\n        }\n\n        return headingsPerLevel;\n    };\n\n    /**\n     * Gets the breadcrumbs at position.\n     *\n     * @param {array} headingsPerLevel\n     * @param {number} scrollTop\n     * @return {string}\n     */\n    const getBreadcrumbs = (headingsPerLevel, scrollTop)=> {\n        const breadcrumbs = [];\n        const headingsInScope = findHeadingsInScope(headingsPerLevel, scrollTop);\n\n        headingsInScope.forEach((heading)=> {\n            const opacity = calculateOpacity(heading.beginningOfScope, heading.endOfScope, scrollTop);\n            const html = '<a href=\"#' + heading.id\n                + '\" class=\"' + heading.tag\n                + '\" style=\"opacity:' + opacity\n                + '; pointer-events: ' + (opacity > 0.5 ? 'auto' : 'none')\n                + '\">' + heading.text\n                + '</a>';\n\n            breadcrumbs.push(html);\n        });\n        return breadcrumbs.join('<small>&nbsp;&gt;&nbsp;</small>');\n    };\n\n    /**\n     * Finds the headings in scope.\n     *\n     * @param {array} headingsPerLevel\n     * @param {number} scrollTop\n     * @return {string}\n     */\n    const findHeadingsInScope = (headingsPerLevel, scrollTop) =>{\n        const headingsInScope = [];\n        let previousHeadingOffset = 0;\n\n        headingsPerLevel.forEach((headings, level)=> {\n            const heading = headings.find((node) =>{\n                return node.offsetTop < scrollTop && node.offsetTop > previousHeadingOffset;\n            });\n            if (heading) {\n                const nextHeadingOfSameLevel = headingsPerLevel[level][headingsPerLevel[level].indexOf(heading) - 1];\n                const currentHeadingOfHigherLevel = headingsInScope[headingsInScope.length - 1];\n                const endOfScope = calculateEndOfScope(nextHeadingOfSameLevel, currentHeadingOfHigherLevel);\n\n                headingsInScope.push({\n                    id: heading.id,\n                    tag: heading.tagName.toLowerCase(),\n                    text: Utils.smartTruncate(heading.textContent.trim(), MAX_SUB_LENGTH),\n                    beginningOfScope: heading.offsetTop + heading.offsetHeight,\n                    endOfScope: endOfScope\n                });\n\n                previousHeadingOffset = heading.offsetTop;\n            } else {\n                previousHeadingOffset = END_OF_ARTICLE;\n            }\n        });\n\n        return headingsInScope;\n    };\n\n    /**\n     * Calculates the end of the scope.\n     *\n     * @param {object} nextHeadingOfSameLevel\n     * @param {object} currentHeadingOfHigherLevel\n     * @return {number}\n     */\n    const calculateEndOfScope = (nextHeadingOfSameLevel, currentHeadingOfHigherLevel) => {\n        let endOfScope;\n\n        if (currentHeadingOfHigherLevel) {\n            if (nextHeadingOfSameLevel) {\n                endOfScope = Math.min(nextHeadingOfSameLevel.offsetTop, currentHeadingOfHigherLevel.endOfScope);\n            } else {\n                endOfScope = currentHeadingOfHigherLevel.endOfScope;\n            }\n        } else {\n            if (nextHeadingOfSameLevel) {\n                endOfScope = nextHeadingOfSameLevel.offsetTop;\n            } else {\n                endOfScope = END_OF_ARTICLE;\n            }\n        }\n\n        return endOfScope;\n    };\n\n    /**\n     * Calculates the opacity of the breadcrumb.\n     *\n     * @param {number} top\n     * @param {number} bottom\n     * @param {number} scrollTop\n     */\n    const calculateOpacity = (top, bottom, scrollTop) =>{\n        const diffTop = scrollTop - top;\n        const topOnFade = diffTop / FADING_DISTANCE;\n        const opacityTop = diffTop > FADING_DISTANCE ? 1 : diffTop / topOnFade;\n        const diffBottom = bottom - scrollTop - OFFSET_END_OF_SCOPE;\n        const bottomOnFade = diffBottom / FADING_DISTANCE;\n        const opacityBottom = diffBottom > FADING_DISTANCE ? 1 : bottomOnFade;\n        return Math.min(opacityTop, opacityBottom);\n    };\n\n\n    const init = (article, breadcrumbsContainer, options) =>{\n        MAX_SUB_LENGTH = options.crumbsmaxlen || 30;\n        ARTICLE = document.querySelector(article);\n        PARENT = document.querySelector(breadcrumbsContainer);\n        CONTAINER = PARENT.querySelector('#local_deepler__breadcrumbs');\n        END_OF_ARTICLE = ARTICLE.offsetTop + ARTICLE.offsetHeight;\n        HIGHEST_LEVEL = options.highestLevel || 2;\n        FADING_DISTANCE = options.fadingDistance == 0 ? 1 : options.fadingDistance || 100;\n        OFFSET_END_OF_SCOPE = options.offsetEndOfScope || 100;\n        OFFSET_TOP = options.offsetTop || 0;\n        const headingsPerLevel = getHeadingsPerLevel();\n        makeBreadcrumbs(headingsPerLevel);\n        window.addEventListener('scroll', () =>{\n            makeBreadcrumbs(headingsPerLevel);\n        });\n    };\n    return {\n        init: init\n    };\n});\n"],"names":["define","Utils","OFFSET_TOP","ARTICLE","CONTAINER","PARENT","END_OF_ARTICLE","HIGHEST_LEVEL","FADING_DISTANCE","OFFSET_END_OF_SCOPE","MAX_SUB_LENGTH","makeBreadcrumbs","headingsPerLevel","innerHTML","getBreadcrumbs","scrollTop","trim","style","display","window","scrollY","breadcrumbs","findHeadingsInScope","forEach","heading","opacity","calculateOpacity","beginningOfScope","endOfScope","html","id","tag","text","push","join","headingsInScope","previousHeadingOffset","headings","level","find","node","offsetTop","nextHeadingOfSameLevel","indexOf","currentHeadingOfHigherLevel","length","calculateEndOfScope","tagName","toLowerCase","smartTruncate","textContent","offsetHeight","Math","min","top","bottom","diffTop","opacityTop","diffBottom","opacityBottom","init","article","breadcrumbsContainer","options","crumbsmaxlen","document","querySelector","highestLevel","fadingDistance","offsetEndOfScope","getHeadingsPerLevel","Array","prototype","slice","call","querySelectorAll","sort","a","b","addEventListener"],"mappings":"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"}