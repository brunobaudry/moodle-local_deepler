define("local_deepler/mlangremover-old",["exports","./selectors","core/ajax"],(function(_exports,_selectors,_ajax){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/*
   * @module     local_mlangremover/mlangremover
   * @copyright  2024 Bruno Baudry <bruno.baudry@bfh.ch>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_selectors=_interopRequireDefault(_selectors),_ajax=_interopRequireDefault(_ajax);let tempTranslations={},config={},letsdobutton={},checkboxes=[],selectedLanguages=[],allMLangs=[],removalMethod="",removetag={},log=function(){for(var _len=arguments.length,a=new Array(_len),_key=0;_key<_len;_key++)a[_key]=arguments[_key];return a},warn=function(){for(var _len2=arguments.length,a=new Array(_len2),_key2=0;_key2<_len2;_key2++)a[_key2]=arguments[_key2];return a},info=function(){for(var _len3=arguments.length,a=new Array(_len3),_key3=0;_key3<_len3;_key3++)a[_key3]=arguments[_key3];return a},error=function(){for(var _len4=arguments.length,a=new Array(_len4),_key4=0;_key4<_len4;_key4++)a[_key4]=arguments[_key4];return a};const debug_MINIMAL=5,debug_NORMAL=15,debug_ALL=30719,debug_DEVELOPER=32767;_exports.init=cfg=>{log("init"),config=cfg,config.debug===debug_MINIMAL?error=window.console.error.bind(window.console):config.debug===debug_NORMAL?(error=window.console.error.bind(window.console),warn=window.console.warn.bind(window.console)):config.debug===debug_ALL?(error=window.console.error.bind(window.console),warn=window.console.warn.bind(window.console),info=window.console.info.bind(window.console)):config.debug===debug_DEVELOPER&&(error=window.console.error.bind(window.console),warn=window.console.warn.bind(window.console),info=window.console.info.bind(window.console),log=window.console.log.bind(window.console)),info("MLANGREMOVER loaded"),log(config),warn("WARNING MESSAGE "+config.debug),error("testing developper level "+ +config.debug),(()=>{try{removetag=document.querySelector(_selectors.default.statuses.removetag),document.querySelector(_selectors.default.actions.selectAllBtn).checked=!1,allMLangs=Array.from(document.querySelectorAll(_selectors.default.statuses.allMLangCkboxes)),log(allMLangs,allMLangs.length),letsdobutton=document.querySelector(_selectors.default.actions.letsdobutton),checkboxes=document.querySelectorAll(_selectors.default.actions.checkBoxes),checkboxes.forEach((node=>{tempTranslations[node.dataset.key]={}}))}catch(e){config.debug&&error(e.message)}})(),document.addEventListener("change",(e=>{e.target.closest(_selectors.default.actions.removeRadios)&&grabSetting(),e.target.matches('input[type="checkbox"]')&&e.target.matches(_selectors.default.statuses.allMLangCkboxesNames)&&grabSetting()})),document.addEventListener("click",(e=>{e.target.closest(_selectors.default.actions.letsdobutton)&&doTagRemoval(),e.target.closest(_selectors.default.actions.selectAllBtn)&&toggleAllCheckboxes(e)})),toggleAutotranslateButton(),allMLangs.forEach((ck=>{ck.checked=!1})),checkboxes.forEach((e=>{e.addEventListener("click",(()=>{toggleAutotranslateButton()}))}))};const doTagRemoval=()=>{grabSetting(),document.querySelectorAll(_selectors.default.statuses.checkedCheckBoxes).forEach((ckBox=>{let key=ckBox.getAttribute("data-key");null!==tempTranslations[key].editor&&((key=>{const sourceSelector=_selectors.default.sourcetexts.keys.replace("<KEY>",key),sourceTextEncoded=document.querySelector(sourceSelector).getAttribute("data-sourcetext-raw"),sourceText=fromBase64(sourceTextEncoded),rmtag=removetag.checked;let newText="";switch(removalMethod){case"all":newText=extractLanguage(sourceText,1===selectedLanguages.length?selectedLanguages[0]:"other");break;case"keepselected":newText=rmtag?extractLanguage(sourceText,selectedLanguages[0]):filterLanguagesWithTags(sourceText,selectedLanguages,!0);break;case"removeselected":newText=filterLanguagesWithTags(sourceText,selectedLanguages,!1)}log(removalMethod),log(selectedLanguages),log(sourceText),log(newText),tempTranslations[key]={old:sourceText,new:newText}})(key),(key=>{warn("WTF ?!?");const matches=key.match(/(\w+)\[(\d+)\]\[(\w+)\]\[(\d+)\]/);if(!matches)throw"key ".concat(key," did not match ");let id=matches[2],table=matches[1],field=matches[3],cmid=matches[4],updatedtext=tempTranslations[key].new,fielddata={};fielddata.courseid=config.courseid,fielddata.id=parseInt(id),fielddata.table=table,fielddata.field=field,fielddata.cmid=cmid,info(fielddata),_ajax.default.call([{methodname:"local_mlangremover_get_field",args:{data:[fielddata]},done:data=>{if(data.length>0){let textarea=document.querySelector(_selectors.default.editors.multiples.textAreasResults.replace("<KEY>",key)),tdata={};tdata.courseid=config.courseid,tdata.id=parseInt(id),tdata.table=table,tdata.field=field,tdata.text=updatedtext,tdata.cmid=cmid,info(tdata);const successMessage=()=>{log("SUCCES")},errorMessage=err=>{error(err)};_ajax.default.call([{methodname:"local_mlangremover_update_translation",args:{data:[tdata]},done:data=>{info("ws: ",key,data),data.length>0?(successMessage(),textarea.innerHTML=data[0].text):errorMessage()},fail:err=>{errorMessage(err)}}])}else warn(data)},fail:err=>{error(err)}}])})(key))}))},grabSetting=()=>{removalMethod=document.querySelector(_selectors.default.actions.removehow).value,info(_selectors.default.statuses.selectedMLangCkboxes);const allMlangSel=document.querySelectorAll(_selectors.default.statuses.selectedMLangCkboxes);info(allMlangSel.length),selectedLanguages=Array.from(document.querySelectorAll(_selectors.default.statuses.selectedMLangCkboxes)).map((checkbox=>checkbox.value)),1!==allMlangSel.length||"removeselected"===removalMethod?(removetag.checked=!1,removetag.disabled=!0):1===allMlangSel.length&&(removetag.disabled=!1)},toggleAllCheckboxes=e=>{e.target.checked?checkboxes.forEach((i=>{i.checked=!getParentRow(i).classList.contains("d-none")})):checkboxes.forEach((i=>{i.checked=!1})),toggleAutotranslateButton()},getParentRow=node=>node.closest(replaceKey(_selectors.default.sourcetexts.parentrow,node.getAttribute("data-key"))),toggleAutotranslateButton=()=>{letsdobutton.disabled=!0;for(let i in checkboxes){if(checkboxes[i].checked){letsdobutton.disabled=!1;break}}},replaceKey=(s,k)=>s.replace("<KEY>",k),fromBase64=encoded=>{const binString=atob(encoded),bytes=Uint8Array.from(binString,(m=>m.codePointAt(0)));return(new TextDecoder).decode(bytes)},hasMultilang=t=>t.includes("{mlang}"),extractLanguage=function(textContent,lang){let returnAllIfNotFound=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(!hasMultilang(textContent))return textContent;const pattern=new RegExp("{mlang\\s+".concat(lang,"}(.*?){mlang}"),"gis");let result="";const matches=textContent.matchAll(pattern);for(const match of matches)result+="".concat(match[1]," ");return result=result.trim(),""===result&&returnAllIfNotFound?textContent:result},filterLanguagesWithTags=function(textContent,langs){let keep=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(!hasMultilang(textContent)||0===langs.length)return textContent;info(textContent,langs,keep);const pattern=/\{mlang\s+([a-z]{2}|other)\}(.*?)\{mlang\}/gis;let result="";const matches=textContent.matchAll(pattern);log(matches);for(const match of matches){warn(match);const inArray=langs.includes(match[1]);(keep&&inArray||!keep&&!inArray)&&(result+="{mlang ".concat(match[1],"}").concat(match[2],"{mlang} "))}return result=result.trim(),""===result?textContent:result}}));

//# sourceMappingURL=mlangremover-old.min.js.map