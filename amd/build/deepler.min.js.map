{"version":3,"file":"deepler.min.js","sources":["../src/deepler.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/*\n * @module     local_deepler/deepler\n * @package    local_deepler\n * @file       amd/src/deepler.js\n * @copyright  2022 Kaleb Heitzman <kaleb@jamfire.io>\n * @copyright  2024 Bruno Baudry <bruno.baudry@bfh.ch>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(\n    [\n        'core/ajax',\n        './selectors',\n        'core/modal',\n        'core/str',\n        './tokeniser'\n    ],\n    (Ajax, Selectors, Modal, Str, Tokeniser)=>{\n        // Use getString instead of get_string\n        const getString = Str.get_string;\n\n        // Destructure the tokeniser functions\n        const {escapeReplacementString, postprocess, preprocess} = Tokeniser;\n// Initialize the temporary translations dictionary @todo make external class\n        let tempTranslations = {};\n        let mainEditorType = '';\n        let config = {};\n        let autotranslateButton = {};\n        let checkboxes = [];\n        let sourceLang = \"\";\n        let targetLang = \"\";\n        let saveAllBtn = {};\n        let usage = {};\n        let format = new Intl.NumberFormat();\n        let saveAllModal = {};\n        const escapePatterns = {};\n        let log = (...a) => {\n            return a;\n        };\n        let warn = (...a) => {\n            return a;\n        };\n        let info = (...a) => {\n            return a;\n        };\n        let error = (...a) => {\n            return a;\n        };\n        const debug = {\n            NONE: 0,\n            MINIMAL: 5,\n            NORMAL: 15,\n            ALL: 30719,\n            DEVELOPER: 32767\n        };\n        /**\n         * Event factory.\n         */\n        const registerEventListeners = () => {\n            document.addEventListener('change', e => {\n                if (e.target.closest(Selectors.actions.targetSwitcher)) {\n                    switchTarget(e);\n                }\n                if (e.target.closest(Selectors.actions.sourceSwitcher)) {\n                    switchSource(e);\n                }\n                if (e.target.closest(Selectors.actions.showUpdated)) {\n                    showRows(Selectors.statuses.updated, e.target.checked);\n                }\n                if (e.target.closest(Selectors.actions.showNeedUpdate)) {\n                    showRows(Selectors.statuses.needsupdate, e.target.checked);\n                }\n                if (e.target.closest(Selectors.actions.checkBoxes) || e.target.closest(Selectors.actions.sourceselect)) {\n                    onItemChecked(e);\n                }\n            });\n            document.addEventListener('click', e => {\n                if (e.target.closest(Selectors.actions.toggleMultilang)) {\n                    onToggleMultilang(e.target.closest(Selectors.actions.toggleMultilang));\n                }\n                if (e.target.closest(Selectors.actions.autoTranslateBtn)) {\n                    if (config.currentlang === config.lang || config.lang === undefined) {\n                        Modal.create({\n                            title: 'Cannot call deepl',\n                            body: `<p>Both languges are the same {$config.lang}</p>`,\n                            show: true,\n                            removeOnClose: true,\n                        });\n                    } else {\n                        doAutotranslate();\n                    }\n                }\n                if (e.target.closest(Selectors.actions.selectAllBtn)) {\n                    toggleAllCheckboxes(e);\n                }\n                if (e.target.closest(Selectors.actions.saveAll)) {\n                    const selected = document.querySelectorAll(Selectors.statuses.checkedCheckBoxes);\n                    const allKeys = Array.from(selected).map((e) => e.dataset.key);\n                    log(allKeys);\n                    if (allKeys.length > 0) {\n                        launchModal();\n                        saveAllBtn.disabled = true;\n                        saveTranslations(allKeys);\n                    }\n                }\n            });\n\n        };\n        /**\n         * Get the UIs.\n         */\n        const registerUI = () => {\n            try {\n                saveAllBtn = document.querySelector(Selectors.actions.saveAll);\n\n                sourceLang = document.querySelector(Selectors.actions.sourceSwitcher).value;\n                targetLang = document.querySelector(Selectors.actions.targetSwitcher).value;\n                autotranslateButton = document.querySelector(Selectors.actions.autoTranslateBtn);\n                checkboxes = document.querySelectorAll(Selectors.actions.checkBoxes);\n                // Initialise status object.\n                checkboxes.forEach((node) => {\n                    tempTranslations[node.dataset.key] = {};\n                });\n            } catch (e) {\n                if (config.debug) {\n                    error(e.message);\n                }\n            }\n        };\n        /**\n         * Translation Editor UI.\n         * @param {Object} cfg JS Config\n         */\n        const init = (cfg) => {\n            log('init');\n            config = cfg;\n            usage = config.usage;\n            // Preparing the debugger.\n            if (config.debug === debug.MINIMAL) {\n                error = window.console.error.bind(window.console);\n            } else if (config.debug === debug.NORMAL) {\n                error = window.console.error.bind(window.console);\n                warn = window.console.warn.bind(window.console);\n            } else if (config.debug === debug.ALL) {\n                error = window.console.error.bind(window.console);\n                warn = window.console.warn.bind(window.console);\n                info = window.console.info.bind(window.console);\n            } else if (config.debug === debug.DEVELOPER) {\n                error = window.console.error.bind(window.console);\n                warn = window.console.warn.bind(window.console);\n                info = window.console.info.bind(window.console);\n                log = window.console.log.bind(window.console);\n            }\n            info(\"DEEPLER loaded\");\n            log(config);\n            warn(\"Deepl's usage\", usage);\n            error(\"testing developper level (Your Moodle is set with dev debug level to the max)\");\n            mainEditorType = config.userPrefs;\n            // Setup.\n            registerUI();\n            registerEventListeners();\n            toggleAutotranslateButton();\n            saveAllBtn.disabled = true;\n            const selectAllBtn = document.querySelector(Selectors.actions.selectAllBtn);\n            selectAllBtn.disabled = sourceLang === targetLang;\n            /**\n             * Validate translation ck\n             */\n            const validators = document.querySelectorAll(Selectors.actions.validatorsBtns);\n            validators.forEach((item) => {\n                // Get the stored data and do the saving from editors content\n                item.addEventListener('click', (e) => {\n                    const _this = e.target.closest(Selectors.actions.validatorsBtns);\n                    const key = _this.dataset.keyValidator;\n                    const icon = document.querySelector(replaceKey(Selectors.actions.validatorBtn, key));\n                    let currentStatus = icon.getAttribute('data-status');\n                    if (tempTranslations[key] === null || tempTranslations[key] === undefined) {\n                        /**\n                         * @todo do a UI feedback (disable save )\n                         */\n                        error(`Translation key \"${key}\" is undefined `);\n                    } else if (currentStatus === Selectors.statuses.tosave) {\n                        saveTranslation(key);\n                    }\n                });\n            });\n            /**\n             * Selection Checkboxes\n             */\n            checkboxes.forEach((e) => {\n                e.disabled = sourceLang === targetLang;\n                e.addEventListener(\"click\", () => {\n                    toggleAutotranslateButton();\n                });\n            });\n            showRows(Selectors.statuses.updated, document.querySelector(Selectors.actions.showUpdated).checked);\n            showRows(Selectors.statuses.needsupdate, document.querySelector(Selectors.actions.showNeedUpdate).checked);\n        };\n        /**\n         * Display error message attached to the item's editor.\n         * @param {String} key\n         * @param {String} message\n         */\n        const showErrorMessageForEditor = (key, message) => {\n            let parent = document.querySelector(Selectors.editors.multiples.editorsWithKey.replace(\"<KEY>\", key));\n            const errorMsg = document.createElement('div');\n            errorMsg.id = 'local_deepler__errormsg';\n            errorMsg.classList = ['alert alert-danger'];\n            errorMsg.innerHTML = message;\n            parent.appendChild(errorMsg);\n        };\n        /**\n         * Hides an item's error message.\n         *\n         * @param {String} key\n         */\n        const hideErrorMessage = (key) => {\n            let parent = document.querySelector(Selectors.editors.multiples.editorsWithKey.replace(\"<KEY>\", key));\n            let alertChild = parent.querySelector('.alert-danger');\n            if (alertChild) {\n                parent.removeChild(alertChild);\n            }\n        };\n        /**\n         * Opens a modal infobox to warn user trunks of fields are saving.\n         * @returns {Promise<void>}\n         */\n        const launchModal = async() => {\n            saveAllModal = await Modal.create({\n                title: getString('saveallmodaltitle', 'local_deepler'),\n                body: getString('saveallmodalbody', 'local_deepler'),\n            });\n            await saveAllModal.show();\n        };\n        /**\n         * Displays success message and icon.\n         *\n         * @param {String} key\n         * @param {HTMLElement} element\n         */\n        const successMessageItem = (key, element) => {\n            element.classList.add(\"local_deepler__success\");\n            // Add saved indicator\n            setIconStatus(key, Selectors.statuses.success);\n            // Remove success message after a few seconds\n            setTimeout(() => {\n                let multilangPill = document.querySelector(replaceKey(Selectors.statuses.multilang, key));\n                let prevTransStatus = document.querySelector(replaceKey(Selectors.statuses.prevTransStatus, key));\n                prevTransStatus.classList = \"badge badge-pill badge-success\";\n                if (multilangPill.classList.contains(\"disabled\")) {\n                    multilangPill.classList.remove('disabled');\n                }\n                setIconStatus(key, Selectors.statuses.saved);\n            });\n        };\n        /**\n         * Displays error message and icon.\n         *\n         * @param {String} key\n         * @param {HTMLElement} editor\n         * @param {String} message\n         */\n        const errorMessageItem = (key, editor, message) => {\n            editor.classList.add(\"local_deepler__error\");\n            setIconStatus(key, Selectors.statuses.failed);\n            showErrorMessageForEditor(key, message);\n        };\n        /**\n         * Editor's text content.\n         *\n         * @param {HTMLElement} editor\n         * @returns {string}\n         */\n        const getEditorText = (editor) => {\n            let text = editor.innerHTML;\n            if (mainEditorType === 'textarea') {\n                text = decodeHTML(text);\n            }\n            return text;\n        };\n        /**\n         * Source text de-tokenised.\n         *\n         * @param {String} key\n         * @returns {String}\n         */\n        const getSourceText = (key) => {\n            const sourceTokenised = tempTranslations[key].source;\n            return postprocess(sourceTokenised, tempTranslations[key].tokens);\n        };\n        /**\n         * Fetch field coordinates stored in custom attributes.\n         *\n         * @param {HTMLElement} element\n         * @returns {{field: *, id: number, tid: *, table: *}}\n         */\n        const getElementAttributes = (element) => {\n            return {\n                id: parseInt(element.getAttribute(\"data-id\")),\n                tid: element.getAttribute(\"data-tid\"),\n                table: element.getAttribute(\"data-table\"),\n                field: element.getAttribute(\"data-field\")\n            };\n        };\n        /**\n         * External interface callback.\n         *\n         * @param {Array} data\n         */\n        const handleAjaxUpdateDBResponse = (data) => {\n            data.forEach((item) => {\n                if (item.keyid === '') {\n                    // Display generic error message.\n                    getString('errordbtitle', 'local_deepler')\n                        .then((s) => {\n                            Modal.create({\n                                    title: s,\n                                    body: item.error,\n                                    type: 'ALERT',\n                                    show: true,\n                                    removeOnClose: true,\n                                }\n                            );\n                            return s;\n                        }).catch((error)=>{\n                        error('errordbtitle, could not get Moodle string!!!');\n                    });\n                } else {\n                    const key = keyidToKey(item.keyid);\n                    const htmlElement = document.querySelector(replaceKey(Selectors.editors.multiples.editorsWithKey, key));\n                    const multilangTextarea = document.querySelector(replaceKey(Selectors.editors.multiples.textAreas, key));\n                    if (item.error !== undefined) {\n                        // Display granular error messages.\n                        const indexOfSET = item.error.indexOf(\"SET\");// Probably a text too long for the field if not -1.\n                        // Text too long.\n                        if (indexOfSET > -1) {\n                            // eslint-disable-next-line promise/always-return\n                            getString('errortoolong', 'local_deepler').then((s) => {\n                                errorMessageItem(key, tempTranslations[key].editor, item.error.slice(0, indexOfSET) + '<br/>' + s);\n                            }).catch((error)=>{\n                                error('errortoolong, could not get Moodle string!!!');\n                            });\n                        } else {\n                            errorMessageItem(key, tempTranslations[key].editor, item.error);\n                        }\n                    } else {\n                        successMessageItem(key, htmlElement);\n                        multilangTextarea.innerHTML = item.text;\n                        // Deselect the checkbox.\n                        document.querySelector(Selectors.editors.multiples.checkBoxesWithKey.replace('<KEY>', key))\n                            .checked = false;\n                    }\n                }\n            });\n        };\n        /**\n         * Save batch translations.\n         *\n         * @param {Array} keys\n         */\n        const saveTranslations = (keys) => {\n\n            const data = [];\n            keys.forEach((key) => {\n                    const icon = document.querySelector(replaceKey(Selectors.actions.validatorBtn, key));\n                    const currentStatus = icon.getAttribute('data-status');\n                    if (currentStatus === Selectors.statuses.tosave) {\n                        hideErrorMessage(key);\n                        data.push(prepareDbUpdatdeItem(key));\n                    }\n                }\n            );\n            Ajax.call([\n                {\n                    methodname: \"local_deepler_update_translation\",\n                    args: {\n                        data: data,\n                    },\n                    done: (data) => {\n                        info(data);\n                        if (saveAllModal !== null && saveAllModal.isVisible) {\n                            saveAllModal.hide();\n                        }\n                        if (data.length > 0) {\n                            handleAjaxUpdateDBResponse(data);\n                        } else {\n                            keys.forEach((key) => {\n                                errorMessageItem(key, tempTranslations[key].editor, 'Something went wrong with the data');\n                            });\n                        }\n                    },\n                    fail: (jqXHR, status, error) => {\n                        warn(jqXHR, status, error);\n                        if (saveAllModal !== null && saveAllModal.isVisible) {\n                            saveAllModal.hide();\n                        }\n                        getString('errordbtitle', 'local_deepler')\n                            .then((s) => {\n                                Modal.create({\n                                        title: s,\n                                        body: error,\n                                        type: 'ALERT',\n                                        show: true,\n                                        removeOnClose: true,\n                                    }\n                                );\n                                return s;\n                            }).catch((error)=>{\n                            error('errordbtitle, could not get Moodle string!!!');\n                        });\n                        // An error occurred\n                        keys.forEach((key) => {\n                            errorMessageItem(key, tempTranslations[key].editor, status + ':' + error.toString());\n                        });\n                    },\n                }\n            ]);\n        };\n        /**\n         * Save single translation.\n         *\n         * @param {string} key\n         */\n        const saveTranslation = (key) => {\n            hideErrorMessage(key);\n            Ajax.call([\n                {\n                    methodname: \"local_deepler_update_translation\",\n                    args: {\n                        data: [prepareDbUpdatdeItem(key)],\n                    },\n                    done: (data) => {\n                        info(data);\n                        if (data.length > 0) {\n                            info('ok');\n                            handleAjaxUpdateDBResponse(data);\n                        } else {\n                            info('nok');\n                            errorMessageItem(key, tempTranslations[key].editor, 'Something went wrong with the data');\n                        }\n                    },\n                    fail: (err) => {\n                        if (saveAllModal !== null && saveAllModal.isVisible) {\n                            saveAllModal.hide();\n                        }\n                        warn(err);\n                        // An error occurred\n                        errorMessageItem(key, tempTranslations[key].editor, err.toString());\n                    },\n                }\n            ]);\n        };\n        /**\n         * Compile data to be sent to deepl.\n         *\n         * @param {String} key\n         * @returns {{field: *, id: number, text: string, courseid, tid: *, table: *}}\n         */\n        const prepareDbUpdatdeItem = (key) => {\n            const editor = tempTranslations[key].editor;\n            const textTranslated = getEditorText(editor);\n            const sourceText = getSourceText(key);\n            const fieldText = tempTranslations[key].fieldText;\n            const element = document.querySelector(replaceKey(Selectors.editors.multiples.editorsWithKey, key));\n            const {id, tid, field, table} = getElementAttributes(element);\n            const textTosave = getupdatedtext(fieldText, textTranslated, sourceText, tempTranslations[key].sourceLang);\n            return {\n                courseid: config.courseid,\n                id: id,\n                tid: tid,\n                field: field,\n                table: table,\n                text: textTosave\n            };\n        };\n        /**\n         * Update Textarea\n         * @param {string} fieldtext Latest text from database including all mlang tag if any.\n         * @param {string} translation Translated Text to update.\n         * @param {string} source Original text translated from.\n         * @param {string} sourceItemLang The source language code\n         * @returns {string}\n         */\n        const getupdatedtext = (fieldtext, translation, source, sourceItemLang) => {\n            const isFirstTranslation = fieldtext.indexOf(\"{mlang\") === -1;\n            const isSourceOther = sourceItemLang === sourceLang;\n            const tagPatterns = {\n                \"other\": \"({mlang other)(.*?){mlang}\",\n                \"target\": `({mlang ${targetLang}}(.*?){mlang})`,\n                \"source\": `({mlang ${sourceItemLang}}(.*?){mlang})`\n            };\n            const langsItems = {\n                \"fullContent\": fieldtext,\n                \"other\": `{mlang other}${source}{mlang}`,\n                \"target\": `{mlang ${targetLang}}${translation}{mlang}`,\n                \"source\": `{mlang ${sourceItemLang}}${source}{mlang}`\n            };\n            if (isFirstTranslation) {\n                // No mlang tag : easy.\n                if (isSourceOther) {\n                    return langsItems.other + langsItems.target;\n                } else {\n                    return langsItems.other + langsItems.source + langsItems.target;\n                }\n            }\n            // Alreaddy mlang tag-s.\n            return additionalUpdate(isSourceOther, tagPatterns, langsItems);\n        };\n\n        /**\n         * Update Textarea when there was mlang tags.\n         * Main regex '({mlang ([a-z]{2,5})}(.*?){mlang})'.\n         * @param {boolean} isSourceOther\n         * @param {string} tagPatterns\n         * @param {string} langsItems\n         * @returns {string} {string}\n         */\n        const additionalUpdate = (isSourceOther, tagPatterns, langsItems) => {\n            let manipulatedText = langsItems.fullContent;\n            // Do we have a TARGET tag already ?\n            const targetReg = new RegExp(tagPatterns.target, \"sg\");\n            const hasTagTarget = manipulatedText.match(targetReg);\n            if (hasTagTarget) {\n                // Yes replace it.\n                manipulatedText = manipulatedText.replace(targetReg, escapeReplacementString(langsItems.target));\n            } else {\n                // No, add it at the end.\n                const lastMlangClosingTagEnd = manipulatedText.lastIndexOf(\"{mlang}\") + \"{mlang}\".length;\n                manipulatedText = [manipulatedText.slice(0, lastMlangClosingTagEnd),\n                    langsItems.target,\n                    manipulatedText.slice(lastMlangClosingTagEnd)\n                ].join('');\n            }\n            // Do we have a OTHER tag already ?\n            const otherReg = new RegExp(tagPatterns.other, \"sg\");\n            const hasTagOther = manipulatedText.match(otherReg);\n            // Do we have a SOURCE tag already ?\n            const sourceReg = new RegExp(tagPatterns.other, \"sg\");\n            const hasTagSource = manipulatedText.match(sourceReg);\n            if (isSourceOther) {\n                // Whatever was the {mlang other} tag language we need to replace it by this source.\n                manipulatedText = manipulatedText.replace(otherReg, escapeReplacementString(langsItems.other));\n                if (hasTagSource) {\n                    // And remove the {mlang source} tag if found.\n                    manipulatedText.replace(sourceReg, \"\");\n                }\n            } else {\n                if (!hasTagOther) {\n                    // We still add this source as otherTag of the so that it can be replaced further.\n                    const firstMlangClosingTagEnd = manipulatedText.indexOf(\"{mlang\");\n                    manipulatedText = [manipulatedText.slice(0, firstMlangClosingTagEnd),\n                        langsItems.other,\n                        manipulatedText.slice(firstMlangClosingTagEnd)\n                    ].join('');\n                }\n                if (!hasTagSource) {\n                    // Add the {mlang source} tag if not found.\n                    manipulatedText.replace(sourceReg, escapeReplacementString(langsItems.source));\n                }\n            }\n            return manipulatedText;\n        };\n        /**\n         * Event listener for selection checkboxes.\n         * @param {Event} e\n         */\n        const onItemChecked = (e) => {\n            log(\"SELECTION\", e.target.getAttribute('data-key'), e.target.getAttribute('data-action'));\n            const key = e.target.getAttribute('data-key');\n            if (e.target.getAttribute('data-action') === \"local_deepler/checkbox\") {\n                toggleStatus(key, e.target.checked);\n                countWordAndChar();\n            } else {\n                initTempForKey(key, false);\n            }\n        };\n        /**\n         * Initializing object storage before translation.\n         *\n         * @param {String} key\n         * @param {Boolean} blank\n         */\n        const initTempForKey = (key, blank) => {\n\n            // Get the source text\n            const sourceSelector = Selectors.sourcetexts.keys.replace(\"<KEY>\", key);\n            const sourceTextEncoded = document.querySelector(sourceSelector).getAttribute(\"data-sourcetext-raw\");\n            const multilangRawTextEncoded = document.querySelector(sourceSelector).getAttribute(\"data-filedtext-raw\");\n            const sourceText = fromBase64(sourceTextEncoded);\n            const fieldText = fromBase64(multilangRawTextEncoded);\n            const tokenised = preprocess(sourceText, escapePatterns, escapePatterns);\n            // Store the settings.\n            const editorSettings = findEditor(key);\n            const sourceLang = document.querySelector(Selectors.sourcetexts.sourcelangs.replace(\"<KEY>\", key)).value;\n            // We make sure to initialize the record.\n            tempTranslations[key] = {\n                'editorType': null,\n                'editor': null,\n                'source': '',\n                'sourceLang': '',\n                'fieldText': '',\n                'status': '',\n                'translation': '',\n                'tokens': []\n            };\n            if (!blank) {\n                if (editorSettings === null || editorSettings.editor === null) {\n                    setIconStatus(key, Selectors.statuses.failed);\n                    showErrorMessageForEditor(key, 'Original editor not found...');\n                } else {\n                    // Initialize status for the source content.\n                    tempTranslations[key] = {\n                        'editorType': editorSettings.editorType,\n                        'editor': editorSettings.editor,\n                        'source': tokenised.tokenizedText,\n                        'sourceLang': sourceLang,\n                        'fieldText': fieldText,\n                        'status': Selectors.statuses.wait,\n                        'translation': '',\n                        'tokens': tokenised.expressions\n                    };\n                }\n            }\n        };\n        /**\n         * Factory to display process' statuses for each item.\n         *\n         * @param {String} key\n         * @param {Boolean} checked\n         */\n        const toggleStatus = (key, checked) => {\n            const status = document.querySelector(replaceKey(Selectors.actions.validatorBtn, key)).dataset.status;\n            switch (status) {\n                case Selectors.statuses.wait :\n                    if (checked) {\n                        setIconStatus(key, Selectors.statuses.totranslate);\n                        initTempForKey(key, false);\n                    } else {\n                        initTempForKey(key, true);\n                    }\n                    break;\n                case Selectors.statuses.totranslate :\n                    if (checked && tempTranslations[key]?.translation?.length > 0) {\n                        setIconStatus(key, Selectors.statuses.tosave, true);\n                    } else {\n                        setIconStatus(key, Selectors.statuses.wait);\n                    }\n                    break;\n                case Selectors.statuses.tosave :\n                    if (!checked) {\n                        setIconStatus(key, Selectors.statuses.totranslate);\n                    }\n                    break;\n                case Selectors.statuses.failed :\n                    break;\n                case Selectors.statuses.success :\n                    break;\n                case Selectors.statuses.saved :\n                    break;\n            }\n        };\n        /**\n         * Change the item icon status as button.\n         *\n         * @param {String} key\n         * @param {String} status\n         * @param {Boolean} isBtn\n         */\n        const setIconStatus = (key, status = Selectors.statuses.wait, isBtn = false) => {\n            let icon = document.querySelector(replaceKey(Selectors.actions.validatorBtn, key));\n            if (isBtn) {\n                if (!icon.classList.contains('btn')) {\n                    icon.classList.add('btn');\n                    icon.classList.add('btn-outline-secondary');\n                }\n                if (icon.classList.contains('disable')) {\n                    icon.classList.remove('disable');\n                }\n            } else {\n                if (!icon.classList.contains('disable')) {\n                    icon.classList.add('disable');\n                }\n                if (icon.classList.contains('btn')) {\n                    icon.classList.remove('btn');\n                    icon.classList.remove('btn-outline-secondary');\n                }\n            }\n            icon.setAttribute('role', isBtn ? 'button' : 'status');\n            icon.setAttribute('data-status', status);\n            icon.setAttribute('title', config.statusstrings[status.replace('local_deepler/', '')]);\n        };\n        /**\n         * Shows/hides rows.\n         * @param {string} selector\n         * @param {boolean} selected\n         */\n        const showRows = (selector, selected) => {\n            const items = document.querySelectorAll(selector);\n            const allSelected = document.querySelector(Selectors.actions.selectAllBtn).checked;\n            items.forEach((item) => {\n                let k = item.getAttribute('data-row-id');\n                toggleRowVisibility(item, selected);\n                // When a row is toggled then we don't want it to be selected and sent from translation.\n                try {\n                    item.querySelector(replaceKey(Selectors.editors.multiples.checkBoxesWithKey, k)).checked =\n                        allSelected && selected;\n                    toggleStatus(k, false);\n                } catch (e) {\n                    log(`${k} translation is disalbled`);\n                }\n\n            });\n            toggleAutotranslateButton();\n            countWordAndChar();\n        };\n        /**\n         * Row visibility.\n         *\n         * @param {HTMLElement} row\n         * @param {Boolean} checked\n         */\n        const toggleRowVisibility = (row, checked) => {\n            if (checked) {\n                row.classList.remove(\"d-none\");\n            } else {\n                row.classList.add(\"d-none\");\n            }\n        };\n        /**\n         * Event listener to switch target lang.\n         * @param {Event} e\n         */\n        const switchTarget = (e) => {\n            let url = new URL(window.location.href);\n            let searchParams = url.searchParams;\n            searchParams.set(\"target_lang\", e.target.value);\n            window.location = url.toString();\n        };\n        /**\n         * Event listener to switch source lang\n         * Hence reload the page and change the site main lang\n         * @param {Event} e\n         */\n        const switchSource = (e) => {\n            let url = new URL(window.location.href);\n            let searchParams = url.searchParams;\n            searchParams.set(\"lang\", e.target.value);\n            window.location = url.toString();\n        };\n        /**\n         * Launch autotranslation.\n         */\n        const doAutotranslate = () => {\n            log('Do auto translate');\n            saveAllBtn.disabled = false;\n            document\n                .querySelectorAll(Selectors.statuses.checkedCheckBoxes)\n                .forEach((ckBox) => {\n                    let key = ckBox.getAttribute(\"data-key\");\n                    initTempForKey(key);\n                    if (tempTranslations[key].editor !== null) {\n                        getTranslation(key);\n                    }\n                });\n        };\n        /**\n         * Compile Advanced settings.\n         *\n         * @returns {{}}\n         */\n        const prepareAdvancedSettings = () => {\n            info('prepareAdvancedSettings');\n            let settings = {};\n            escapePatterns.LATEX = document.querySelector(Selectors.actions.escapeLatex).checked;\n            escapePatterns.PRETAG = document.querySelector(Selectors.actions.escapePre).checked;\n            // eslint-disable-next-line camelcase\n            settings.tag_handling = document.querySelector(Selectors.deepl.tagHandling).checked ? 'html' : 'xml';//\n            settings.context = document.querySelector(Selectors.deepl.context).value ?? null;//\n            // eslint-disable-next-line camelcase\n            settings.split_sentences = document.querySelector(Selectors.deepl.splitSentences).value;//\n            // eslint-disable-next-line camelcase\n            settings.preserve_formatting = document.querySelector(Selectors.deepl.preserveFormatting).checked;//\n            settings.formality = document.querySelector('[name=\"local_deepler/formality\"]:checked').value;\n            // eslint-disable-next-line camelcase\n            settings.glossary_id = document.querySelector(Selectors.deepl.glossaryId).value;//\n            // eslint-disable-next-line camelcase\n            settings.outline_detection = document.querySelector(Selectors.deepl.outlineDetection).checked;//\n            // eslint-disable-next-line camelcase\n            settings.non_splitting_tags = toJsonArray(document.querySelector(Selectors.deepl.nonSplittingTags).value);\n            // eslint-disable-next-line camelcase\n            settings.splitting_tags = toJsonArray(document.querySelector(Selectors.deepl.splittingTags).value);\n            // eslint-disable-next-line camelcase\n            settings.ignore_tags = toJsonArray(document.querySelector(Selectors.deepl.ignoreTags).value);\n            // eslint-disable-next-line camelcase\n            settings.target_lang = targetLang.toUpperCase();\n            // eslint-disable-next-line camelcase\n            settings.auth_key = config.apikey;\n            return settings;\n        };\n        /**\n         * Compile translation to be sent.\n         *\n         * @param {String} key\n         * @returns {{source_lang: (string|*), text}}\n         */\n        const prepareTranslation = (key) => {\n            return {\n                text: tempTranslations[key].source,\n                // eslint-disable-next-line camelcase\n                source_lang: tempTranslations[key].sourceLang,\n            };\n        };\n        /**\n         * Prepare the params for XHR call.\n         *\n         * @param {string} key\n         * @param {boolean} url\n         * @returns {URLSearchParams|FormData} Object to use in XHR.\n         */\n        const prepareFormData = (key, url = true) => {\n            let formData = url ? new URLSearchParams() : new FormData();\n            Object.entries(prepareAdvancedSettings()).forEach(([k, v]) => {\n                formData.append(k, v);\n            });\n            initTempForKey(key, false); // Reset temp translation in case setting changed.\n            Object.entries(prepareTranslation(key)).forEach(([k, v]) => {\n                formData.append(k, v);\n            });\n            return formData;\n        };\n\n\n        /**\n         * @todo extract images ALT tags to send for translation\n         * Send for Translation to DeepL\n         * @param {Integer} key Translation Key\n         */\n        const getTranslation = (key) => {\n            log('getTranslation');\n            // Workaround if undefined when JS is cached, need further investigation.\n            const readystateDone = XMLHttpRequest.DONE ?? 4;\n            // Initialize global dictionary with this key's editor.\n            tempTranslations[key].staus = Selectors.statuses.wait;\n            // Build formData.\n            let formData = prepareFormData(key);\n            if (tempTranslations[key].editor === null) {\n                error(`${key} no editor found :((`);\n            } else {\n                info(\"Send deepl:\", formData);\n                // Update the translation.\n                let xhr = new XMLHttpRequest();\n                xhr.responseType = 'json';\n                xhr.onreadystatechange = () => {\n                    if (xhr.readyState === readystateDone) {\n                        const status = xhr.status;\n                        if (status === 0 || (status >= 200 && status < 400)) {\n                            // The request has been completed successfully.\n                            log(tempTranslations);\n                            let data = xhr.responseType === 'text' || xhr.responseType === '' ?\n                                JSON.parse(xhr.responseText) : xhr.response;\n                            info(\"From deepl:\", data);\n                            let tr = postprocess(data.translations[0].text, tempTranslations[key].tokens, escapePatterns);\n                            // Display translation\n                            log(tr);\n                            tempTranslations[key].editor.innerHTML = tr;\n                            // Store the translation in the global object.\n                            tempTranslations[key].translation = tr;\n                            setIconStatus(key, Selectors.statuses.tosave, true);\n                            injectImageCss(\n                                tempTranslations[key].editorType,\n                                tempTranslations[key].editor); // Hack for iframes based editors to highlight missing pictures.\n                        } else {\n                            // Oh no! There has been an error with the request!\n                            setIconStatus(key, Selectors.statuses.failed, false);\n                        }\n                    } else if (typeof xhr.readyState !== 'number') {\n                        // Workaround for the Adaptable theme that did change the return type of xhr.readyState.\n                        log('ERROR: Some JS library in your Moodle install ' +\n                            'are overriding the core functionalities in a wrong way.' +\n                            'xhr.readyState MUST be of type \"number\"');\n                    }\n                };\n                xhr.open(\"POST\", config.deeplurl);\n                xhr.send(formData);\n            }\n\n        };\n\n        /**\n         * Inject css to highlight ALT text of image not loaded because of @@PLUGINFILE@@.\n         *\n         * @param {string} editorType\n         * @param {object} editor\n         */\n        const injectImageCss = (editorType, editor) => {\n            // Prepare css to inject in iframe editors\n            const css = document.createElement('style');\n            css.textContent = 'img{background-color:yellow !important;font-style: italic;}';\n            if (editorType === \"iframe\") {\n                let editorschildrens = Array.from(editor.parentElement.children);\n                let found = false;\n                for (let j in editorschildrens) {\n                    let e = editorschildrens[j];\n                    if (e.innerText === css.innerText) {\n                        found = true;\n                        break;\n                    }\n                }\n                if (!found) {\n                    editor.parentElement.appendChild(css);\n                }\n            }\n        };\n        /**\n         * Get the editor container based on recieved current user's editor preference.\n         *\n         * @param {Integer} key Translation Key\n         * @todo MDL-0 get the editor from moodle db in the php.\n         */\n        const findEditor = (key) => {\n            let e = document.querySelector(Selectors.editors.types.basic\n                .replace(\"<KEY>\", key));\n            let et = 'basic';\n            if (e === null) {\n                let r = null;\n                let editorTab = [\"atto\", \"tiny\", \"marklar\", \"textarea\"];\n                if (editorTab.indexOf(mainEditorType) === -1) {\n                    warn('Unsupported editor ' + mainEditorType);\n                } else {\n                    // First let's try the current editor.\n                    try {\n                        r = findEditorByType(key, mainEditorType);\n                    } catch (error) {\n                        // Content was edited by another editor.\n                        log(`Editor not found: ${mainEditorType} for key ${key}`);\n                    }\n                }\n                return r;\n            } else {\n                return {editor: e, editorType: et};\n            }\n        };\n        /**\n         * @param {string} key\n         * @param {object} editorType\n         * @returns {{editor: object, editorType: string}}\n         */\n        const findEditorByType = (key, editorType) => {\n            let et = 'basic';\n            let ed = null;\n            switch (editorType) {\n                case \"atto\" :\n                    et = 'iframe';\n                    ed = document.querySelector(\n                        Selectors.editors.types.atto\n                            .replaceAll(\"<KEY>\", key));\n                    break;\n                case \"tiny\":\n                    et = 'iframe';\n                    ed = document.querySelector(Selectors.editors.types.tiny\n                        .replaceAll(\"<KEY>\", key))\n                        .contentWindow.tinymce;\n                    break;\n                case 'marklar':\n                case \"textarea\" :\n                    ed = document.querySelector(Selectors.editors.types.other\n                        .replaceAll(\"<KEY>\", key));\n                    break;\n            }\n            return {editor: ed, editorType: et};\n        };\n        /**\n         * Toggle checkboxes\n         * @param {Event} e Event\n         */\n        const toggleAllCheckboxes = (e) => {\n            // Check/uncheck checkboxes\n            if (e.target.checked) {\n                checkboxes.forEach((i) => {\n                    // Toggle check box upon visibility\n                    i.checked = !getParentRow(i).classList.contains('d-none');\n                    toggleStatus(i.getAttribute('data-key'), i.checked);\n                });\n            } else {\n                checkboxes.forEach((i) => {\n                    i.checked = false;\n                    toggleStatus(i.getAttribute('data-key'), false);\n                });\n            }\n            toggleAutotranslateButton();\n            countWordAndChar();\n        };\n        const getParentRow = (node) => {\n            return node.closest(replaceKey(Selectors.sourcetexts.parentrow, node.getAttribute('data-key')));\n        };\n        /**\n         * Toggle Autotranslate Button\n         */\n        const toggleAutotranslateButton = () => {\n            autotranslateButton.disabled = true;\n            for (let i in checkboxes) {\n                let e = checkboxes[i];\n                if (e.checked) {\n                    autotranslateButton.disabled = false;\n                    break;\n                }\n            }\n        };\n        /**\n         * Multilang button handler\n         * @param {Event} e Event\n         */\n        const onToggleMultilang = (e) => {\n            let keyid = e.getAttribute('aria-controls');\n            let key = keyidToKey(keyid);\n            let source = document.querySelector(replaceKey(Selectors.sourcetexts.keys, key));\n            let multilang = document.querySelector(replaceKey(Selectors.sourcetexts.multilangs, keyid));\n            source.classList.toggle(\"show\");\n            multilang.classList.toggle(\"show\");\n        };\n        /**\n         * Json helper\n         * @param {string} s\n         * @param {string} sep\n         * @returns {string}\n         */\n        const toJsonArray = (s, sep = \",\") => {\n            return JSON.stringify(s.split(sep));\n        };\n        /**\n         * Simple helper to manage selectors\n         * @param {string} s\n         * @param {string} k\n         * @returns {*}\n         */\n        const replaceKey = (s, k) => {\n            return s.replace(\"<KEY>\", k);\n        };\n        /**\n         * Transforms a keyid to a key.\n         * @param {string} k\n         * @returns {`${*}[${*}][${*}]`}\n         */\n        const keyidToKey = (k) => {\n            let m = k.match(/^(.+)-(.+)-(.+)$/i);\n            return `${m[1]}[${m[2]}][${m[3]}]`;\n        };\n        /*\n        Const getKeyFromComponents = (id, field, table) => {\n            return `${table}[${id}][${field}]`;\n        };\n        */\n        /**\n         * Launch, display count of Words And Chars.\n         */\n        const countWordAndChar = () => {\n            let wrdsc = 0;\n            let cws = 0;\n            let cwos = 0;\n            document\n                .querySelectorAll(Selectors.statuses.checkedCheckBoxes)\n                .forEach((ckBox) => {\n                    let key = ckBox.getAttribute(\"data-key\");\n                    let results = getCount(key);\n                    wrdsc += results.wordCount;\n                    cwos += results.charNumWithOutSpace;\n                    cws += results.charNumWithSpace;\n                });\n            const wordCount = document.querySelector(Selectors.statuses.wordcount);\n            const charWithSpace = document.querySelector(Selectors.statuses.charNumWithSpace);\n            const charWOSpace = document.querySelector(Selectors.statuses.charNumWithOutSpace);\n            const deeplUseSpan = document.querySelector(Selectors.statuses.deeplUsage);\n            const deeplMaxSpan = document.querySelector(Selectors.statuses.deeplMax);\n            const parent = document.querySelector(Selectors.statuses.deeplStatusContainer);\n            let current = cwos + usage.character.count;\n            wordCount.innerText = wrdsc;\n            charWithSpace.innerText = cws;\n            charWOSpace.innerText = cwos;\n            deeplUseSpan.innerText = format.format(current);\n            deeplMaxSpan.innerText = usage.character.limit === null ? 'âˆž' : format.format(usage.character.limit);\n            if (current >= usage.character.limit) {\n                parent.classList.remove('alert-success');\n                parent.classList.add('alert-danger');\n            } else {\n                parent.classList.add('alert-success');\n                parent.classList.remove('alert-danger');\n            }\n        };\n        /**\n         * Compile the needed counts for info.\n         *\n         * @param {string} key\n         * @returns {{wordCount: *, charNumWithSpace: *, charNumWithOutSpace: *}}\n         */\n        const getCount = (key) => {\n            const item = document.querySelector(replaceKey(Selectors.sourcetexts.keys, key));\n            const raw = item.getAttribute(\"data-sourcetext-raw\");\n            // Cleaned sourceText.\n            const trimmedVal = stripHTMLTags(fromBase64(raw)).trim();\n            return {\n                \"wordCount\": (trimmedVal.match(/\\S+/g) || []).length,\n                \"charNumWithSpace\": trimmedVal.length,\n                \"charNumWithOutSpace\": trimmedVal.replace(/\\s+/g, '').length\n            };\n        };\n        /**\n         * Helper function to decode the PHP base64 encoded source.\n         * @param {string} encoded\n         * @returns {string}\n         */\n        const fromBase64 = (encoded) => {\n            const binString = atob(encoded); // Maybe we should import js-base64 instead.\n            const bytes = Uint8Array.from(binString, (m) => m.codePointAt(0));\n            return new TextDecoder().decode(bytes);\n        };\n        /**\n         * Helper function for the decode html escaped content.\n         * @param {string} encodedStr\n         * @returns {string}\n         */\n        const decodeHTML = (encodedStr) => {\n            const parser = new DOMParser();\n            const doc = parser.parseFromString(encodedStr, 'text/html');\n            return doc.documentElement.textContent;\n        };\n        /**\n         * Helper to remove HTML from strings.\n         *\n         * @param {string} str\n         * @returns {string|string}\n         */\n        const stripHTMLTags = (str) => {\n            let doc = new DOMParser().parseFromString(str, 'text/html');\n            return doc.body.textContent || \"\";\n        };\n\n        return {\n            init: init\n        };\n    }\n);\n"],"names":["define","Ajax","Selectors","Modal","Str","Tokeniser","getString","get_string","escapeReplacementString","postprocess","preprocess","tempTranslations","mainEditorType","config","autotranslateButton","checkboxes","sourceLang","targetLang","saveAllBtn","usage","format","Intl","NumberFormat","saveAllModal","escapePatterns","log","_len","arguments","length","a","Array","_key","warn","_len2","_key2","info","_len3","_key3","error","_len4","_key4","debug","showErrorMessageForEditor","key","message","parent","document","querySelector","editors","multiples","editorsWithKey","replace","errorMsg","createElement","id","classList","innerHTML","appendChild","hideErrorMessage","alertChild","removeChild","launchModal","async","create","title","body","show","errorMessageItem","editor","add","setIconStatus","statuses","failed","handleAjaxUpdateDBResponse","data","forEach","item","keyid","then","s","type","removeOnClose","catch","keyidToKey","htmlElement","replaceKey","multilangTextarea","textAreas","undefined","indexOfSET","indexOf","slice","successMessageItem","element","success","setTimeout","multilangPill","multilang","prevTransStatus","contains","remove","saved","text","checkBoxesWithKey","checked","saveTranslations","keys","actions","validatorBtn","getAttribute","tosave","push","prepareDbUpdatdeItem","call","methodname","args","done","isVisible","hide","fail","jqXHR","status","toString","saveTranslation","err","textTranslated","decodeHTML","getEditorText","sourceText","sourceTokenised","source","tokens","getSourceText","fieldText","tid","field","table","parseInt","getElementAttributes","textTosave","getupdatedtext","courseid","fieldtext","translation","sourceItemLang","isFirstTranslation","isSourceOther","tagPatterns","other","target","concat","langsItems","fullContent","additionalUpdate","manipulatedText","targetReg","RegExp","match","lastMlangClosingTagEnd","lastIndexOf","join","otherReg","hasTagOther","sourceReg","hasTagSource","firstMlangClosingTagEnd","onItemChecked","e","toggleStatus","countWordAndChar","initTempForKey","blank","sourceSelector","sourcetexts","sourceTextEncoded","multilangRawTextEncoded","fromBase64","tokenised","editorSettings","findEditor","sourcelangs","value","editorType","tokenizedText","wait","expressions","_tempTranslations$key","_tempTranslations$key2","dataset","totranslate","isBtn","icon","setAttribute","statusstrings","showRows","selector","selected","items","querySelectorAll","allSelected","selectAllBtn","k","toggleRowVisibility","toggleAutotranslateButton","row","switchTarget","url","URL","window","location","href","searchParams","set","switchSource","doAutotranslate","disabled","checkedCheckBoxes","ckBox","getTranslation","prepareFormData","formData","URLSearchParams","FormData","Object","entries","prepareAdvancedSettings","_document$querySelect","settings","LATEX","escapeLatex","PRETAG","escapePre","tag_handling","deepl","tagHandling","context","split_sentences","splitSentences","preserve_formatting","preserveFormatting","formality","glossary_id","glossaryId","outline_detection","outlineDetection","non_splitting_tags","toJsonArray","nonSplittingTags","splitting_tags","splittingTags","ignore_tags","ignoreTags","target_lang","toUpperCase","auth_key","apikey","_ref","v","append","source_lang","prepareTranslation","_ref2","_XMLHttpRequest$DONE","readystateDone","XMLHttpRequest","DONE","staus","xhr","responseType","onreadystatechange","readyState","JSON","parse","responseText","response","tr","translations","injectImageCss","open","deeplurl","send","css","textContent","editorschildrens","from","parentElement","children","found","j","innerText","types","basic","r","findEditorByType","et","ed","atto","replaceAll","tiny","contentWindow","tinymce","toggleAllCheckboxes","i","getParentRow","node","closest","parentrow","onToggleMultilang","multilangs","toggle","sep","stringify","split","m","wrdsc","cws","cwos","results","getCount","wordCount","charNumWithOutSpace","charNumWithSpace","wordcount","charWithSpace","charWOSpace","deeplUseSpan","deeplUsage","deeplMaxSpan","deeplMax","deeplStatusContainer","current","character","count","limit","raw","trimmedVal","stripHTMLTags","trim","encoded","binString","atob","bytes","Uint8Array","codePointAt","TextDecoder","decode","encodedStr","DOMParser","parseFromString","documentElement","str","init","cfg","console","bind","userPrefs","registerUI","saveAll","sourceSwitcher","targetSwitcher","autoTranslateBtn","checkBoxes","addEventListener","showUpdated","updated","showNeedUpdate","needsupdate","sourceselect","toggleMultilang","currentlang","lang","allKeys","map","validatorsBtns","keyValidator","currentStatus"],"mappings":"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"}